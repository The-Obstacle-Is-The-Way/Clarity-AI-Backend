[1m============================= test session starts ==============================[0m
platform darwin -- Python 3.12.10, pytest-8.2.2, pluggy-1.5.0
rootdir: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
configfile: pytest.ini
testpaths: app/tests
plugins: hypothesis-6.88.1, cov-5.0.0, anyio-4.9.0, Faker-37.1.0, asyncio-0.23.7, mock-3.14.0
asyncio: mode=Mode.AUTO
collected 1570 items / 9 skipped

app/tests/api/integration/test_xgboost_integration.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m               [  0%][0m
app/tests/api/routes/test_xgboost_routes.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m                        [  0%][0m
app/tests/api/unit/test_xgboost_endpoints.py [33ms[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[33m                 [  1%][0m
app/tests/application/services/test_temporal_neurotransmitter_service.py [32m.[0m[33m [  1%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m                                                          [  2%][0m
app/tests/core/security/test_rbac.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m                            [  2%][0m
app/tests/core/test_config.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m                                     [  3%][0m
app/tests/core/test_db.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m                                           [  3%][0m
app/tests/domain/entities/test_neurotransmitter_mapping.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m       [  3%][0m
app/tests/domain/entities/test_temporal_neurotransmitter.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m     [  4%][0m
app/tests/domain/enums/test_role.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m                                [  4%][0m
app/tests/domain/ml/test_exceptions.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m                      [  5%][0m
app/tests/domain/services/test_enhanced_xgboost_service.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m    [  6%][0m
app/tests/enhanced/test_enhanced_digital_twin_integration.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m  [  6%][0m
app/tests/enhanced/test_neurotransmitter_mapping_integration.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m [  7%]
[0m[32m.[0m[33m                                                                        [  7%][0m
app/tests/enhanced/test_temporal_neurotransmitter_sequence.py [32m.[0m[32m.[0m[32m.[0m[33m        [  7%][0m
app/tests/fixtures/test_mock_db.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m                                 [  7%][0m
app/tests/infrastructure/aws/test_aws_fixtures.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m                  [  8%][0m
app/tests/infrastructure/ml/test_digital_twin_integration.py [32m.[0m[32m.[0m[32m.[0m[33m         [  8%][0m
app/tests/infrastructure/repositories/test_temporal_event_repository.py [32m.[0m[33m [  8%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m                                                                   [  8%][0m
app/tests/infrastructure/repositories/test_temporal_sequence_repository.py [32m.[0m[33m [  8%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m                                                                 [  9%][0m
app/tests/infrastructure/services/test_mock_enhanced_digital_twin_neurotransmitter_service.py [32m.[0m[33m [  9%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33m                                                         [ 10%][0m
app/tests/integration/api/endpoints/test_actigraphy_endpoints.py [31mF[0m[31mF[0m[31mF[0m[31m     [ 10%][0m
app/tests/integration/api/mentallama/test_mentallama_api.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m     [ 11%][0m
app/tests/integration/api/test_actigraphy_api_integration.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m    [ 11%][0m
app/tests/integration/api/test_xgboost_api_integration.py [32m.[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[31mF[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m [ 12%]
[0m[31m                                                                         [ 12%][0m
app/tests/integration/core/temporal/test_temporal_neurotransmitter_integration.py [33ms[0m[31m [ 12%]
[0m[33ms[0m[33ms[0m[33ms[0m[31m                                                                      [ 12%][0m
app/tests/integration/core/test_db.py [32m.[0m[32m.[0m[32m.[0m[31m                                [ 12%][0m
app/tests/integration/domain/digital_twin/test_digital_twin_integration_int.py [32m.[0m[31m [ 13%]
[0m[31m                                                                         [ 13%][0m
app/tests/integration/infrastructure/persistence/repositories/test_patient_repository_int.py [32m.[0m[31m [ 13%]
[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                      [ 13%][0m
app/tests/integration/infrastructure/persistence/repositories/test_repository.py [31mF[0m[31m [ 13%]
[0m[31m                                                                         [ 13%][0m
app/tests/integration/infrastructure/persistence/test_database_docker_connection.py [33ms[0m[31m [ 13%]
[0m[33ms[0m[31m                                                                        [ 13%][0m
app/tests/integration/infrastructure/persistence/test_patient_encryption_integration.py [31mF[0m[31m [ 13%]
[0m[31mF[0m[32m.[0m[31m                                                                       [ 13%][0m
app/tests/integration/infrastructure/security/phi/test_phi_sanitization_integration.py [33ms[0m[31m [ 13%]
[0m[33ms[0m[33ms[0m[33ms[0m[31m                                                                      [ 13%][0m
app/tests/integration/infrastructure/security/phi/test_standalone_phi_sanitizer.py [33ms[0m[31m [ 14%]
[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[31m                                                                   [ 14%][0m
app/tests/integration/infrastructure/security/test_security_boundary.py [32m.[0m[31m [ 14%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                [ 15%][0m
app/tests/security/api/test_api_hipaa_compliance.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33ms[0m[32m.[0m[33ms[0m[32m.[0m[31m            [ 15%][0m
app/tests/security/api/test_api_security.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m         [ 16%][0m
app/tests/security/audit/test_audit_logging.py [33ms[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[31m                     [ 17%][0m
app/tests/security/audit/test_phi_audit.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[31m                   [ 17%][0m
app/tests/security/audit/test_phi_audit_fixed.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                   [ 18%][0m
app/tests/security/auth/test_auth_endpoints.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m                 [ 18%][0m
app/tests/security/auth/test_auth_hipaa_compliance.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[31m         [ 19%][0m
app/tests/security/auth/test_auth_middleware.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m                    [ 19%][0m
app/tests/security/db/test_database_security.py [32m.[0m[31m                        [ 19%][0m
app/tests/security/db/test_db_phi_protection.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m                  [ 20%][0m
app/tests/security/db/test_repository_security.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                [ 20%][0m
app/tests/security/db/test_unit_of_work.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33ms[0m[31m                    [ 21%][0m
app/tests/security/encryption/test_encryption.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                  [ 21%][0m
app/tests/security/encryption/test_ml_encryption.py [32m.[0m[31mF[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[31mF[0m[31m              [ 22%][0m
app/tests/security/jwt/test_jwt_auth.py [32m.[0m[32m.[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[32m.[0m[31m                         [ 22%][0m
app/tests/security/jwt/test_jwt_service.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31m                        [ 23%][0m
app/tests/security/phi/test_log_sanitization.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                  [ 23%][0m
app/tests/security/phi/test_log_sanitizer.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                 [ 24%][0m
app/tests/security/phi/test_ml_phi_security.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                [ 24%][0m
app/tests/security/phi/test_mock_phi_service.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m             [ 25%][0m
app/tests/security/phi/test_patient_phi_security.py [32m.[0m[33ms[0m[33ms[0m[31mF[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[33ms[0m[31m            [ 26%][0m
app/tests/security/phi/test_phi_audit_logic.py [32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                 [ 26%][0m
app/tests/security/phi/test_phi_code_patterns.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m               [ 27%][0m
app/tests/security/phi/test_phi_detection.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m                      [ 27%][0m
app/tests/security/phi/test_phi_middleware.py [32m.[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31m                    [ 28%][0m
app/tests/security/phi/test_phi_sanitizer.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m          [ 29%][0m
app/tests/security/utils/test_address_helper.py [32m.[0m[31m                        [ 29%][0m
app/tests/security/utils/test_base_security_test.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m               [ 29%][0m
app/tests/security/utils/test_fixtures.py [32m.[0m[31m                              [ 29%][0m
app/tests/standalone/core/test_base_security_test.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m            [ 30%][0m
app/tests/standalone/core/test_biometric_event_processor.py [32m.[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m [ 31%]
[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                      [ 31%][0m
app/tests/standalone/core/test_mfa_service.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 32%]
[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                      [ 33%][0m
app/tests/standalone/core/test_ml_exceptions.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                   [ 33%][0m
app/tests/standalone/core/test_mock_digital_twin.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m         [ 34%][0m
app/tests/standalone/core/test_mock_mentallama.py [32m.[0m[32m.[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[32m.[0m[31m              [ 34%][0m
app/tests/standalone/core/test_pat_mock.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[31mF[0m[31m [ 36%]
[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[31m                                                                    [ 37%][0m
app/tests/standalone/core/test_standalone_biometric_processor.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 37%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                           [ 38%][0m
app/tests/standalone/core/test_standalone_digital_twin.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 39%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[31m                                                              [ 39%][0m
app/tests/standalone/core/test_standalone_ml_exceptions.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m       [ 40%][0m
app/tests/standalone/core/test_standalone_pat_mock.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m             [ 40%][0m
app/tests/standalone/core/test_standalone_phi_sanitizer.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 41%]
[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[32m.[0m[31m                                                              [ 42%][0m
app/tests/standalone/core/test_utils.py [32m.[0m[32m.[0m[31mF[0m[31mF[0m[31m                             [ 42%][0m
app/tests/standalone/domain/test_exceptions.py [32m.[0m[32m.[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31m            [ 43%][0m
app/tests/standalone/domain/test_patient.py [32m.[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 45%]
[0m[32m.[0m[32m.[0m[31m                                                                       [ 45%][0m
app/tests/standalone/domain/test_patient_entity.py [32m.[0m[32m.[0m[32m.[0m[31m                   [ 45%][0m
app/tests/standalone/domain/test_patient_model.py [32m.[0m[31mF[0m[32m.[0m[31m                    [ 45%][0m
app/tests/standalone/domain/test_provider.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 47%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                         [ 48%][0m
app/tests/standalone/domain/test_standalone_patient.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m   [ 49%][0m
app/tests/standalone/infrastructure/test_appointment.py [32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m [ 50%]
[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                    [ 50%][0m
app/tests/standalone/infrastructure/test_debugging.py [32m.[0m[32m.[0m[31m                 [ 50%][0m
app/tests/standalone/security/test_base_security_test.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m           [ 51%][0m
app/tests/unit/api/routes/test_actigraphy_routes.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m [ 52%]
[0m[31mF[0m[31m                                                                        [ 52%][0m
app/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py [31mF[0m[31m [ 52%]
[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m                                                                    [ 52%][0m
app/tests/unit/application/use_cases/analytics/test_process_analytics_event.py [31mF[0m[31m [ 52%]
[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m                                                                     [ 53%][0m
app/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py [31mF[0m[31m [ 53%]
[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[31m                                                               [ 53%][0m
app/tests/unit/application/use_cases/patient/test_create_patient_use_case.py [32m.[0m[31m [ 54%]
[0m[32m.[0m[31m                                                                        [ 54%][0m
app/tests/unit/application/use_cases/patient/test_delete_patient_use_case.py [32m.[0m[31m [ 54%]
[0m[31m                                                                         [ 54%][0m
app/tests/unit/application/use_cases/patient/test_get_patient_by_id_use_case.py [32m.[0m[31m [ 54%]
[0m[32m.[0m[31m                                                                        [ 54%][0m
app/tests/unit/application/use_cases/patient/test_update_patient_use_case.py [32m.[0m[31m [ 54%]
[0m[31m                                                                         [ 54%][0m
app/tests/unit/core/config/test_ml_settings.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[31m                    [ 54%][0m
app/tests/unit/core/services/ml/pat/test_mock_pat.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[31m [ 55%]
[0m[31m                                                                         [ 55%][0m
app/tests/unit/core/services/ml/pat/test_pat_factory.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m          [ 56%][0m
app/tests/unit/core/services/ml/pat/test_pat_service_core.py [32m.[0m[31m           [ 56%][0m
app/tests/unit/core/services/ml/test_factory.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[33ms[0m[33ms[0m[33ms[0m[31mF[0m[33ms[0m[31mF[0m[31m              [ 57%][0m
app/tests/unit/core/services/ml/test_mock.py [31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[31mF[0m[32m.[0m[31mF[0m[32m.[0m[31m               [ 57%][0m
app/tests/unit/core/services/ml/test_mock_digital_twin.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m   [ 58%][0m
app/tests/unit/core/services/ml/test_mock_dt.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m             [ 59%][0m
app/tests/unit/core/services/ml/test_mock_mentallama.py [32m.[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31m         [ 60%][0m
app/tests/unit/core/services/ml/test_phi_detection_core.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[31m   [ 60%][0m
app/tests/unit/core/test_database.py [31mF[0m[31mF[0m[32m.[0m[32m.[0m[31m                                [ 60%][0m
app/tests/unit/core/utils/test_encryption_unit.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m              [ 61%][0m
app/tests/unit/core/utils/test_logging.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                    [ 62%][0m
app/tests/unit/core/utils/test_logging_enhanced.py [32m.[0m[31mF[0m[31m                    [ 62%][0m
app/tests/unit/core/utils/test_phi_sanitizer_unit.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m         [ 63%][0m
app/tests/unit/domain/entities/digital_twin/test_digital_twin_entity.py [31mF[0m[31m [ 63%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                 [ 63%][0m
app/tests/unit/domain/entities/test_appointment.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m          [ 64%][0m
app/tests/unit/domain/entities/test_biometric_twin.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m   [ 65%][0m
app/tests/unit/domain/entities/test_patient_contact_info.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m        [ 65%][0m
app/tests/unit/domain/entities/test_patient_entity.py [31mF[0m[31mF[0m[31mF[0m[31m                [ 65%][0m
app/tests/unit/domain/entities/test_provider.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                  [ 66%][0m
app/tests/unit/domain/services/test_appointment_service.py [32m.[0m[32m.[0m[32m.[0m[31m           [ 66%][0m
app/tests/unit/domain/services/test_biometric_alert_audit_service.py [32m.[0m[32m.[0m[32m.[0m[31m [ 66%]
[0m[32m.[0m[32m.[0m[31m                                                                       [ 66%][0m
app/tests/unit/domain/services/test_biometric_alert_notification_service.py [32m.[0m[31m [ 66%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                   [ 67%][0m
app/tests/unit/domain/services/test_biometric_event_processor.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 67%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                          [ 68%][0m
app/tests/unit/domain/services/test_biometric_integration_service.py [31mF[0m[31mF[0m[31mF[0m[31m [ 68%]
[0m[31mF[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[31m                                                              [ 69%][0m
app/tests/unit/domain/services/test_clinical_rule_engine.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31m   [ 70%][0m
app/tests/unit/domain/test_biometric_alert.py [32m.[0m[31mF[0m[31mF[0m[31m                        [ 70%][0m
app/tests/unit/domain/test_patient.py [31mF[0m[31mF[0m[32m.[0m[31m                                [ 70%][0m
app/tests/unit/domain/value_objects/test_contact_info.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m           [ 70%][0m
app/tests/unit/domain/value_objects/test_physiological_ranges.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m    [ 71%][0m
app/tests/unit/domain/value_objects/test_value_objects_enhanced.py [31mF[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 71%]
[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[31m                                                          [ 72%][0m
app/tests/unit/infrastructure/cache/test_redis_cache.py [31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m [ 73%]
[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m                                                                    [ 73%][0m
app/tests/unit/infrastructure/messaging/test_secure_messaging_service.py [32m.[0m[31m [ 73%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                          [ 74%][0m
app/tests/unit/infrastructure/ml/biometric_correlation/test_lstm_model.py [32m.[0m[31m [ 74%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                     [ 75%][0m
app/tests/unit/infrastructure/ml/biometric_correlation/test_model_service.py [32m.[0m[31m [ 75%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                    [ 75%][0m
app/tests/unit/infrastructure/ml/phi_detection/test_phi_detection_service.py [32m.[0m[31m [ 75%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[31mF[0m[31m                                                                  [ 76%][0m
app/tests/unit/infrastructure/ml/symptom_forecasting/test_xgboost_model.py [31mF[0m[31m [ 76%]
[0m[31mF[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[31mF[0m[31m                                                                   [ 76%][0m
app/tests/unit/infrastructure/ml/test_digital_twin_integration_service.py [31mF[0m[31m [ 76%]
[0m[31mF[0m[31mF[0m[32m.[0m[31mF[0m[31mF[0m[31m                                                                    [ 76%][0m
app/tests/unit/infrastructure/ml/test_phi_detection_infra.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 77%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                           [ 78%][0m
app/tests/unit/infrastructure/persistence/sqlalchemy/models/test_model_validation.py [32m.[0m[31m [ 78%]
[0m[31mF[0m[31mF[0m[32m.[0m[31m                                                                      [ 78%][0m
app/tests/unit/infrastructure/persistence/sqlalchemy/models/test_patient_encryption.py [32m.[0m[31m [ 78%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                    [ 79%][0m
app/tests/unit/infrastructure/persistence/sqlalchemy/repositories/test_biometric_alert_repository_infra.py [32m.[0m[31m [ 79%]
[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m                                                                     [ 79%][0m
app/tests/unit/infrastructure/persistence/sqlalchemy/repositories/test_patient_repository.py [32m.[0m[31m [ 79%]
[0m[32m.[0m[32m.[0m[31m                                                                       [ 79%][0m
app/tests/unit/infrastructure/persistence/sqlalchemy/test_database_enhanced.py [32m.[0m[31m [ 79%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                           [ 80%][0m
app/tests/unit/infrastructure/security/test_auth_middleware_unit.py [31mF[0m[32m.[0m[31mF[0m[31mF[0m[31m [ 80%]
[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m                                                                   [ 81%][0m
app/tests/unit/infrastructure/security/test_encryption_enhanced.py [32m.[0m[31mF[0m[32m.[0m[32m.[0m[31mF[0m[31m [ 81%]
[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m                                                                    [ 81%][0m
app/tests/unit/infrastructure/security/test_jwt_handler.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 82%]
[0m[32m.[0m[32m.[0m[31m                                                                       [ 82%][0m
app/tests/unit/infrastructure/security/test_jwt_service_enhanced.py [32m.[0m[31mF[0m[32m.[0m[31mF[0m[31m [ 83%]
[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[31m                                                               [ 83%][0m
app/tests/unit/infrastructure/security/test_jwt_service_unit.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 84%]
[0m[32m.[0m[31m                                                                        [ 84%][0m
app/tests/unit/infrastructure/security/test_mfa_service.py [32m.[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[31m [ 85%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                       [ 86%][0m
app/tests/unit/infrastructure/security/test_password_handler.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[31m [ 86%]
[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                 [ 87%][0m
app/tests/unit/infrastructure/security/test_rate_limiter.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 88%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                              [ 88%][0m
app/tests/unit/infrastructure/services/test_redis_cache_service.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 89%]
[0m[32m.[0m[32m.[0m[31m                                                                       [ 89%][0m
app/tests/unit/presentation/api/dependencies/test_rate_limiter_deps.py [32m.[0m[31m [ 89%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31m                                                             [ 90%][0m
app/tests/unit/presentation/api/test_rule_templates.py [32m.[0m[31m                 [ 90%][0m
app/tests/unit/presentation/api/v1/endpoints/test_analytics_endpoints.py [31mF[0m[31m [ 90%]
[0m[31mF[0m[31mF[0m[31m                                                                       [ 90%][0m
app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py [31mF[0m[31m [ 90%]
[0m[31mF[0m[31mF[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[31mF[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[32m.[0m[31m                                                     [ 91%][0m
app/tests/unit/presentation/api/v1/endpoints/test_biometric_endpoints.py [32m.[0m[31m [ 91%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31mF[0m[31m                                                               [ 92%][0m
app/tests/unit/presentation/api/v1/endpoints/test_digital_twins.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 92%]
[0m[32m.[0m[32m.[0m[31m                                                                       [ 92%][0m
app/tests/unit/presentation/middleware/test_rate_limiting_middleware.py [32m.[0m[31m [ 92%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                            [ 93%][0m
app/tests/unit/services/ml/mentallama/test_mentallama_mock.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 94%]
[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                      [ 94%][0m
app/tests/unit/services/ml/pat/test_bedrock_pat.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m              [ 94%][0m
app/tests/unit/services/ml/pat/test_mock_pat_service.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 95%]
[0m[32m.[0m[33ms[0m[31m                                                                       [ 96%][0m
app/tests/unit/services/ml/pat/test_pat_mock.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 97%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                    [ 97%][0m
app/tests/unit/services/ml/pat/test_pat_service.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31mF[0m[32m.[0m[32m.[0m[31m              [ 98%][0m
app/tests/unit/services/ml/xgboost_service/test_aws_xgboost.py [32m.[0m[32m.[0m[32m.[0m[31m       [ 98%][0m
app/tests/unit/services/ml/xgboost_service/test_aws_xgboost_core.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m [ 98%]
[0m[32m.[0m[31m                                                                        [ 98%][0m
app/tests/unit/services/ml/xgboost_service/test_aws_xgboost_prediction.py [32m.[0m[31m [ 99%]
[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                                                                     [ 99%][0m
app/tests/unit/test_auth_endpoints.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                             [ 99%][0m
app/tests/unit/test_patient_service.py [32m.[0m[32m.[0m[32m.[0m[32m.[0m[32m.[0m[31m                             [100%][0m

=================================== FAILURES ===================================
[31m[1m_________________________ test_upload_actigraphy_data __________________________[0m
[1m[31mapp/tests/integration/api/endpoints/test_actigraphy_endpoints.py[0m:388: in test_upload_actigraphy_data
    [0m[94massert[39;49;00m response.status_code == [94m200[39;49;00m [90m# Assuming 200 for successful analysis start[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - Loading test settings.
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - Loaded test settings. DATABASE_URL: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - Creating test database engine for URL: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - Created mock DB session override.
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - Created mock IUserRepository override provider.
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:31] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:31] [INFO] [httpx] - HTTP Request: POST http://test/api/v1/actigraphy/analyze "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: POST http://test/api/v1/actigraphy/analyze "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_______________________ test_get_actigraphy_data_summary _______________________[0m
[1m[31mapp/tests/integration/api/endpoints/test_actigraphy_endpoints.py[0m:409: in test_get_actigraphy_data_summary
    [0m[94massert[39;49;00m response.status_code == [94m200[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:31] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:31] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/actigraphy/patient/test-patient-summary/analyses "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/actigraphy/patient/test-patient-summary/analyses "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m______________________ test_get_specific_actigraphy_data _______________________[0m
[1m[31mapp/tests/integration/api/endpoints/test_actigraphy_endpoints.py[0m:440: in test_get_specific_actigraphy_data
    [0m[94massert[39;49;00m create_response.status_code == [94m200[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:31] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:31] [INFO] [httpx] - HTTP Request: POST http://test/api/v1/actigraphy/analyze "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: POST http://test/api/v1/actigraphy/analyze "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:31] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m______________________________ test_health_check _______________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/mentallama/test_mentallama_api.py", line 263, in test_health_check
    |     response = await client.get("/health")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1801, in get
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/auth_service.py", line 232, in get_auth_service
    |     jwt_service = await get_jwt_service(settings)
    |                   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt_service.py", line 270, in get_jwt_service
    |     return JWTService(settings)
    |            ^^^^^^^^^^^^^^^^^^^^
    | TypeError: Can't instantiate abstract class JWTService without an implementation for abstract methods 'get_token_payload_subject', 'get_user_from_token', 'verify_refresh_token'
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/mentallama/test_mentallama_api.py[0m:263: in test_health_check
    [0mresponse = [94mawait[39;49;00m client.get([33m"[39;49;00m[33m/health[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1801: in get
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mapp/infrastructure/security/auth_service.py[0m:232: in get_auth_service
    [0mjwt_service = [94mawait[39;49;00m get_jwt_service(settings)[90m[39;49;00m
[1m[31mapp/infrastructure/security/jwt_service.py[0m:270: in get_jwt_service
    [0m[94mreturn[39;49;00m JWTService(settings)[90m[39;49;00m
[1m[31mE   TypeError: Can't instantiate abstract class JWTService without an implementation for abstract methods 'get_token_payload_subject', 'get_user_from_token', 'verify_refresh_token'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Setting up test application fixture.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating FastAPI app instance within patched context (DI, Redis)...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:31] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:31] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: 1
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:31] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:31] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - FastAPI app instance created successfully with patches active.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Dependency overrides applied for routes/endpoints.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Entering lifespan context manager...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:31] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:31] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:31] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:31] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:31] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:31] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Application startup complete.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan startup complete (Redis calls mocked), yielding app...
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating test client using lifespan-managed app...
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:31] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:31] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:31] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Test client teardown.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Exiting lifespan context (yielded app)...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:31] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:31] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Application shutdown complete.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan context manager exited.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Tearing down test application fixture.
[31m[1m____________________________ test_process_endpoint _____________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/mentallama/test_mentallama_api.py", line 271, in test_process_endpoint
    |     response = await client.post(
    |                ^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1892, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/mentallama/test_mentallama_api.py[0m:271: in test_process_endpoint
    [0mresponse = [94mawait[39;49;00m client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Setting up test application fixture.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating FastAPI app instance within patched context (DI, Redis)...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:31] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:31] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: 1
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:31] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:31] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - FastAPI app instance created successfully with patches active.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Dependency overrides applied for routes/endpoints.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Entering lifespan context manager...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:31] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:31] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:31] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:31] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:31] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:31] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Application startup complete.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan startup complete (Redis calls mocked), yielding app...
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating test client using lifespan-managed app...
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:31] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:31] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:31] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Test client teardown.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Exiting lifespan context (yielded app)...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:31] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:31] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Application shutdown complete.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan context manager exited.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Tearing down test application fixture.
[31m[1m__________________________ test_analyze_text_endpoint __________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/mentallama/test_mentallama_api.py", line 286, in test_analyze_text_endpoint
    |     response = await client.post(
    |                ^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1892, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/mentallama/test_mentallama_api.py[0m:286: in test_analyze_text_endpoint
    [0mresponse = [94mawait[39;49;00m client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Setting up test application fixture.
[2025-05-02 21:52:31] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating FastAPI app instance within patched context (DI, Redis)...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:31] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:31] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:31] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: 1
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:31] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:32] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - FastAPI app instance created successfully with patches active.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Dependency overrides applied for routes/endpoints.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Entering lifespan context manager...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:32] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application startup complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan startup complete (Redis calls mocked), yielding app...
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating test client using lifespan-managed app...
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Test client teardown.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Exiting lifespan context (yielded app)...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:32] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:32] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application shutdown complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan context manager exited.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Tearing down test application fixture.
[31m[1m_______________________ test_detect_conditions_endpoint ________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/mentallama/test_mentallama_api.py", line 300, in test_detect_conditions_endpoint
    |     response = await client.post(
    |                ^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1892, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/mentallama/test_mentallama_api.py[0m:300: in test_detect_conditions_endpoint
    [0mresponse = [94mawait[39;49;00m client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Setting up test application fixture.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating FastAPI app instance within patched context (DI, Redis)...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:32] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:32] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: 1
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:32] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:32] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - FastAPI app instance created successfully with patches active.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Dependency overrides applied for routes/endpoints.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Entering lifespan context manager...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:32] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application startup complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan startup complete (Redis calls mocked), yielding app...
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating test client using lifespan-managed app...
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Test client teardown.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Exiting lifespan context (yielded app)...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:32] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:32] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application shutdown complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan context manager exited.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Tearing down test application fixture.
[31m[1m______________________ test_therapeutic_response_endpoint ______________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/mentallama/test_mentallama_api.py", line 314, in test_therapeutic_response_endpoint
    |     response = await client.post(
    |                ^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1892, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/mentallama/test_mentallama_api.py[0m:314: in test_therapeutic_response_endpoint
    [0mresponse = [94mawait[39;49;00m client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Setting up test application fixture.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating FastAPI app instance within patched context (DI, Redis)...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:32] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:32] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: 1
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:32] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:32] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - FastAPI app instance created successfully with patches active.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Dependency overrides applied for routes/endpoints.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Entering lifespan context manager...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:32] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application startup complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan startup complete (Redis calls mocked), yielding app...
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating test client using lifespan-managed app...
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Test client teardown.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Exiting lifespan context (yielded app)...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:32] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:32] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application shutdown complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan context manager exited.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Tearing down test application fixture.
[31m[1m__________________________ test_suicide_risk_endpoint __________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/mentallama/test_mentallama_api.py", line 332, in test_suicide_risk_endpoint
    |     response = await client.post(
    |                ^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1892, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/mentallama/test_mentallama_api.py[0m:332: in test_suicide_risk_endpoint
    [0mresponse = [94mawait[39;49;00m client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Setting up test application fixture.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating FastAPI app instance within patched context (DI, Redis)...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:32] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:32] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: 1
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:32] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:32] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - FastAPI app instance created successfully with patches active.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Dependency overrides applied for routes/endpoints.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Entering lifespan context manager...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:32] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application startup complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan startup complete (Redis calls mocked), yielding app...
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating test client using lifespan-managed app...
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Test client teardown.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Exiting lifespan context (yielded app)...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:32] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:32] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application shutdown complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan context manager exited.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Tearing down test application fixture.
[31m[1m______________________ test_wellness_dimensions_endpoint _______________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/mentallama/test_mentallama_api.py", line 346, in test_wellness_dimensions_endpoint
    |     response = await client.post(
    |                ^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1892, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/mentallama/test_mentallama_api.py[0m:346: in test_wellness_dimensions_endpoint
    [0mresponse = [94mawait[39;49;00m client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Setting up test application fixture.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating FastAPI app instance within patched context (DI, Redis)...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:32] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:32] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: 1
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:32] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:32] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - FastAPI app instance created successfully with patches active.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Dependency overrides applied for routes/endpoints.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Entering lifespan context manager...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:32] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application startup complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan startup complete (Redis calls mocked), yielding app...
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating test client using lifespan-managed app...
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Test client teardown.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Exiting lifespan context (yielded app)...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:32] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:32] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application shutdown complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan context manager exited.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Tearing down test application fixture.
[31m[1m___________________________ test_service_unavailable ___________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/mentallama/test_mentallama_api.py", line 365, in test_service_unavailable
    |     response = await client.post(
    |                ^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1892, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/mentallama/test_mentallama_api.py[0m:365: in test_service_unavailable
    [0mresponse = [94mawait[39;49;00m client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Setting up test application fixture.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating FastAPI app instance within patched context (DI, Redis)...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:32] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:32] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: 1
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:32] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:32] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - FastAPI app instance created successfully with patches active.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Dependency overrides applied for routes/endpoints.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Entering lifespan context manager...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:32] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:32] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application startup complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan startup complete (Redis calls mocked), yielding app...
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Creating test client using lifespan-managed app...
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:32] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Test client teardown.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Exiting lifespan context (yielded app)...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:32] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:32] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:32] [INFO] [app.app_factory] - Application shutdown complete.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Lifespan context manager exited.
[2025-05-02 21:52:32] [INFO] [app.tests.integration.api.mentallama.test_mentallama_api] - Tearing down test application fixture.
[31m[1m__________________ TestActigraphyAPI.test_analyze_actigraphy ___________________[0m
[1m[31mapp/tests/integration/api/test_actigraphy_api_integration.py[0m:164: in test_analyze_actigraphy
    [0m[94massert[39;49;00m response.status_code == [94m200[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:32] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:32] [INFO] [httpx] - HTTP Request: POST http://test/api/v1/actigraphy/analyze "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: POST http://test/api/v1/actigraphy/analyze "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_______________ TestActigraphyAPI.test_get_actigraphy_embeddings _______________[0m
[1m[31mapp/tests/integration/api/test_actigraphy_api_integration.py[0m:195: in test_get_actigraphy_embeddings
    [0m[94massert[39;49;00m response.status_code == [94m201[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:32] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:32] [INFO] [httpx] - HTTP Request: POST http://test/api/v1/actigraphy/embeddings "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: POST http://test/api/v1/actigraphy/embeddings "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m__________________ TestActigraphyAPI.test_get_analysis_by_id ___________________[0m
[1m[31mapp/tests/integration/api/test_actigraphy_api_integration.py[0m:212: in test_get_analysis_by_id
    [0manalysis_data = mock_pat_service.analyze_actigraphy([90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:816: in analyze_actigraphy
    [0m[96mself[39;49;00m._validate_actigraphy_inputs(patient_id, readings, sampling_rate_hz, device_info, analysis_types)[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:932: in _validate_actigraphy_inputs
    [0m[94mraise[39;49;00m ValidationError([33mf[39;49;00m[33m"[39;49;00m[33mDevice info must contain required keys: [39;49;00m[33m{[39;49;00mrequired_device_keys[33m}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ValidationError: Device info must contain required keys: ['manufacturer', 'model'][0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:32] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:32] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:32] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:32] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_________________ TestActigraphyAPI.test_get_patient_analyses __________________[0m
[1m[31mapp/tests/integration/api/test_actigraphy_api_integration.py[0m:251: in test_get_patient_analyses
    [0mmock_pat_service.analyze_actigraphy([90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:816: in analyze_actigraphy
    [0m[96mself[39;49;00m._validate_actigraphy_inputs(patient_id, readings, sampling_rate_hz, device_info, analysis_types)[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:932: in _validate_actigraphy_inputs
    [0m[94mraise[39;49;00m ValidationError([33mf[39;49;00m[33m"[39;49;00m[33mDevice info must contain required keys: [39;49;00m[33m{[39;49;00mrequired_device_keys[33m}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ValidationError: Device info must contain required keys: ['manufacturer', 'model'][0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:33] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:33] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:33] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m____________________ TestActigraphyAPI.test_get_model_info _____________________[0m
[1m[31mapp/tests/integration/api/test_actigraphy_api_integration.py[0m:300: in test_get_model_info
    [0m[94massert[39;49;00m response.status_code == [94m200[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:33] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:33] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:33] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:33] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/actigraphy/model-info "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/actigraphy/model-info "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m______________ TestActigraphyAPI.test_integrate_with_digital_twin ______________[0m
[1m[31mapp/tests/integration/api/test_actigraphy_api_integration.py[0m:313: in test_integrate_with_digital_twin
    [0manalysis_data = mock_pat_service.analyze_actigraphy([90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:816: in analyze_actigraphy
    [0m[96mself[39;49;00m._validate_actigraphy_inputs(patient_id, readings, sampling_rate_hz, device_info, analysis_types)[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:932: in _validate_actigraphy_inputs
    [0m[94mraise[39;49;00m ValidationError([33mf[39;49;00m[33m"[39;49;00m[33mDevice info must contain required keys: [39;49;00m[33m{[39;49;00mrequired_device_keys[33m}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ValidationError: Device info must contain required keys: ['manufacturer', 'model'][0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:33] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:33] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:33] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m__________________ TestActigraphyAPI.test_unauthorized_access __________________[0m
[1m[31mapp/tests/integration/api/test_actigraphy_api_integration.py[0m:362: in test_unauthorized_access
    [0m[94massert[39;49;00m response.status_code == [94m401[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:33] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:33] [INFO] [httpx] - HTTP Request: POST http://test/api/v1/actigraphy/analyze "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: POST http://test/api/v1/actigraphy/analyze "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m__________________ TestActigraphyAPI.test_get_analysis_types ___________________[0m
[1m[31mapp/tests/integration/api/test_actigraphy_api_integration.py[0m:387: in test_get_analysis_types
    [0m[94massert[39;49;00m response.status_code == [94m200[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:33] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:33] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:33] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:33] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/actigraphy/analysis_types "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/actigraphy/analysis_types "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_________ TestXGBoostAPIIntegration.test_predict_risk_validation_error _________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/test_xgboost_api_integration.py", line 361, in test_predict_risk_validation_error
    |     response = await async_client.post(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1892, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/test_xgboost_api_integration.py[0m:361: in test_predict_risk_validation_error
    [0mresponse = [94mawait[39;49;00m async_client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.integration.conftest] - Creating test database session with canonical SQLAlchemy models
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Initializing SQLAlchemy test session with model validation
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Created 4 tables from metadata
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Created tables: users, patients, providers, test_custom_models
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Users table columns: ['id', 'username', 'email', 'first_name', 'last_name', 'password_hash', 'is_active', 'is_verified', 'email_verified', 'role', 'roles', 'last_login', 'failed_login_attempts', 'account_locked_until', 'password_changed_at', 'reset_token', 'reset_token_expires_at', 'verification_token', 'bio', 'preferences', 'access_logs', 'created_at', 'updated_at', 'created_by', 'updated_by', 'audit_id']
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.registry] - Validating 1 registered models
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - Validated 0 models in local registry successfully
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - SQLAlchemy model validation completed successfully
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Committed test users using direct SQL: ['00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002']
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Test users already exist in database.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:33] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:33] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:33] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:33] [INFO] [app.app_factory] - FastAPI application creation complete.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:33] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:33] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:33] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[31m[1m__________ TestXGBoostAPIIntegration.test_predict_risk_phi_detection ___________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/test_xgboost_api_integration.py", line 395, in test_predict_risk_phi_detection
    |     response = await async_client.post(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1892, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/test_xgboost_api_integration.py[0m:395: in test_predict_risk_phi_detection
    [0mresponse = [94mawait[39;49;00m async_client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.integration.conftest] - Creating test database session with canonical SQLAlchemy models
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Initializing SQLAlchemy test session with model validation
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Created 4 tables from metadata
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Created tables: users, patients, providers, test_custom_models
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Users table columns: ['id', 'username', 'email', 'first_name', 'last_name', 'password_hash', 'is_active', 'is_verified', 'email_verified', 'role', 'roles', 'last_login', 'failed_login_attempts', 'account_locked_until', 'password_changed_at', 'reset_token', 'reset_token_expires_at', 'verification_token', 'bio', 'preferences', 'access_logs', 'created_at', 'updated_at', 'created_by', 'updated_by', 'audit_id']
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.registry] - Validating 1 registered models
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - Validated 0 models in local registry successfully
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - SQLAlchemy model validation completed successfully
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Committed test users using direct SQL: ['00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002']
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Test users already exist in database.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:33] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:33] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:33] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:33] [INFO] [app.app_factory] - FastAPI application creation complete.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:33] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:33] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:33] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[31m[1m___________ TestXGBoostAPIIntegration.test_predict_risk_unauthorized ___________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/test_xgboost_api_integration.py", line 421, in test_predict_risk_unauthorized
    |     response = await async_client.post(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1892, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/test_xgboost_api_integration.py[0m:421: in test_predict_risk_unauthorized
    [0mresponse = [94mawait[39;49;00m async_client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.integration.conftest] - Creating test database session with canonical SQLAlchemy models
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Initializing SQLAlchemy test session with model validation
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Created 4 tables from metadata
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Created tables: users, patients, providers, test_custom_models
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Users table columns: ['id', 'username', 'email', 'first_name', 'last_name', 'password_hash', 'is_active', 'is_verified', 'email_verified', 'role', 'roles', 'last_login', 'failed_login_attempts', 'account_locked_until', 'password_changed_at', 'reset_token', 'reset_token_expires_at', 'verification_token', 'bio', 'preferences', 'access_logs', 'created_at', 'updated_at', 'created_by', 'updated_by', 'audit_id']
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.registry] - Validating 1 registered models
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - Validated 0 models in local registry successfully
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - SQLAlchemy model validation completed successfully
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Committed test users using direct SQL: ['00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002']
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Test users already exist in database.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:33] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:33] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:33] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:33] [INFO] [app.app_factory] - FastAPI application creation complete.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:33] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:33] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:33] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[31m[1m____________ TestXGBoostAPIIntegration.test_predict_outcome_success ____________[0m
[1m[31mapp/tests/integration/api/test_xgboost_api_integration.py[0m:476: in test_predict_outcome_success
    [0m[33m"[39;49;00m[33moutcome_type[39;49;00m[33m"[39;49;00m: valid_outcome_prediction_data[[33m"[39;49;00m[33moutcome_type[39;49;00m[33m"[39;49;00m],[90m[39;49;00m
[1m[31mE   KeyError: 'outcome_type'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:33] [INFO] [app.tests.integration.conftest] - Creating test database session with canonical SQLAlchemy models
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Initializing SQLAlchemy test session with model validation
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Created 4 tables from metadata
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Created tables: users, patients, providers, test_custom_models
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Users table columns: ['id', 'username', 'email', 'first_name', 'last_name', 'password_hash', 'is_active', 'is_verified', 'email_verified', 'role', 'roles', 'last_login', 'failed_login_attempts', 'account_locked_until', 'password_changed_at', 'reset_token', 'reset_token_expires_at', 'verification_token', 'bio', 'preferences', 'access_logs', 'created_at', 'updated_at', 'created_by', 'updated_by', 'audit_id']
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.registry] - Validating 1 registered models
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - Validated 0 models in local registry successfully
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - SQLAlchemy model validation completed successfully
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Committed test users using direct SQL: ['00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002']
[2025-05-02 21:52:33] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:33] [INFO] [app.tests.integration.utils.test_db_initializer] - Test users already exist in database.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:33] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:33] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:33] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:33] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:33] [INFO] [app.app_factory] - FastAPI application creation complete.
[31m[1m_______ TestXGBoostAPIIntegration.test_get_feature_importance_not_found ________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/test_xgboost_api_integration.py", line 544, in test_get_feature_importance_not_found
    |     response = await async_client.get( # Use await with async_client
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1801, in get
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/test_xgboost_api_integration.py[0m:544: in test_get_feature_importance_not_found
    [0mresponse = [94mawait[39;49;00m async_client.get( [90m# Use await with async_client[39;49;00m[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1801: in get
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:34] [INFO] [app.tests.integration.conftest] - Creating test database session with canonical SQLAlchemy models
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Initializing SQLAlchemy test session with model validation
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Created 4 tables from metadata
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Created tables: users, patients, providers, test_custom_models
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Users table columns: ['id', 'username', 'email', 'first_name', 'last_name', 'password_hash', 'is_active', 'is_verified', 'email_verified', 'role', 'roles', 'last_login', 'failed_login_attempts', 'account_locked_until', 'password_changed_at', 'reset_token', 'reset_token_expires_at', 'verification_token', 'bio', 'preferences', 'access_logs', 'created_at', 'updated_at', 'created_by', 'updated_by', 'audit_id']
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.registry] - Validating 1 registered models
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - Validated 0 models in local registry successfully
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - SQLAlchemy model validation completed successfully
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Committed test users using direct SQL: ['00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002']
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Test users already exist in database.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:34] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:34] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:34] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:34] [INFO] [app.app_factory] - FastAPI application creation complete.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:34] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:34] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:34] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[31m[1m___________ TestXGBoostAPIIntegration.test_get_model_info_not_found ____________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/test_xgboost_api_integration.py", line 629, in test_get_model_info_not_found
    |     response = await async_client.get( # Use await with async_client
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1801, in get
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/test_xgboost_api_integration.py[0m:629: in test_get_model_info_not_found
    [0mresponse = [94mawait[39;49;00m async_client.get( [90m# Use await with async_client[39;49;00m[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1801: in get
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:34] [INFO] [app.tests.integration.conftest] - Creating test database session with canonical SQLAlchemy models
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Initializing SQLAlchemy test session with model validation
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Created 4 tables from metadata
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Created tables: users, patients, providers, test_custom_models
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Users table columns: ['id', 'username', 'email', 'first_name', 'last_name', 'password_hash', 'is_active', 'is_verified', 'email_verified', 'role', 'roles', 'last_login', 'failed_login_attempts', 'account_locked_until', 'password_changed_at', 'reset_token', 'reset_token_expires_at', 'verification_token', 'bio', 'preferences', 'access_logs', 'created_at', 'updated_at', 'created_by', 'updated_by', 'audit_id']
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.registry] - Validating 1 registered models
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - Validated 0 models in local registry successfully
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - SQLAlchemy model validation completed successfully
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Committed test users using direct SQL: ['00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002']
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Test users already exist in database.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:34] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:34] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:34] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:34] [INFO] [app.app_factory] - FastAPI application creation complete.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:34] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:34] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:34] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[31m[1m______________ TestXGBoostAPIIntegration.test_service_unavailable ______________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/test_xgboost_api_integration.py", line 649, in test_service_unavailable
    |     response = await async_client.post( # Use await with async_client
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1892, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/test_xgboost_api_integration.py[0m:649: in test_service_unavailable
    [0mresponse = [94mawait[39;49;00m async_client.post( [90m# Use await with async_client[39;49;00m[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:34] [INFO] [app.tests.integration.conftest] - Creating test database session with canonical SQLAlchemy models
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Initializing SQLAlchemy test session with model validation
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Created 4 tables from metadata
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Created tables: users, patients, providers, test_custom_models
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Users table columns: ['id', 'username', 'email', 'first_name', 'last_name', 'password_hash', 'is_active', 'is_verified', 'email_verified', 'role', 'roles', 'last_login', 'failed_login_attempts', 'account_locked_until', 'password_changed_at', 'reset_token', 'reset_token_expires_at', 'verification_token', 'bio', 'preferences', 'access_logs', 'created_at', 'updated_at', 'created_by', 'updated_by', 'audit_id']
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.registry] - Validating 1 registered models
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - Validated 0 models in local registry successfully
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - SQLAlchemy model validation completed successfully
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Committed test users using direct SQL: ['00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002']
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Test users already exist in database.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:34] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:34] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:34] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:34] [INFO] [app.app_factory] - FastAPI application creation complete.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:34] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:34] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:34] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[31m[1m_____________ TestXGBoostAPIIntegration.test_predict_risk_no_auth ______________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/test_xgboost_api_integration.py", line 664, in test_predict_risk_no_auth
    |     response = await async_client.post(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1892, in post
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/test_xgboost_api_integration.py[0m:664: in test_predict_risk_no_auth
    [0mresponse = [94mawait[39;49;00m async_client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:34] [INFO] [app.tests.integration.conftest] - Creating test database session with canonical SQLAlchemy models
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Initializing SQLAlchemy test session with model validation
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Created 4 tables from metadata
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Created tables: users, patients, providers, test_custom_models
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Users table columns: ['id', 'username', 'email', 'first_name', 'last_name', 'password_hash', 'is_active', 'is_verified', 'email_verified', 'role', 'roles', 'last_login', 'failed_login_attempts', 'account_locked_until', 'password_changed_at', 'reset_token', 'reset_token_expires_at', 'verification_token', 'bio', 'preferences', 'access_logs', 'created_at', 'updated_at', 'created_by', 'updated_by', 'audit_id']
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.registry] - Validating 1 registered models
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - Validated 0 models in local registry successfully
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - SQLAlchemy model validation completed successfully
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Committed test users using direct SQL: ['00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002']
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Test users already exist in database.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:34] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:34] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:34] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:34] [INFO] [app.app_factory] - FastAPI application creation complete.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:34] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:34] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:34] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[31m[1m____________ TestXGBoostAPIIntegration.test_get_model_info_no_auth _____________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/api/test_xgboost_api_integration.py", line 673, in test_get_model_info_no_auth
    |     response = await async_client.get("/api/v1/xgboost/info/risk_prediction")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1801, in get
    |     return await self.request(
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1574, in request
    |     return await self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1661, in send
    |     response = await self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1689, in _send_handling_auth
    |     response = await self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1726, in _send_handling_redirects
    |     response = await self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1763, in _send_single_request
    |     response = await transport.handle_async_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py", line 164, in handle_async_request
    |     await self.app(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/integration/api/test_xgboost_api_integration.py[0m:673: in test_get_model_info_no_auth
    [0mresponse = [94mawait[39;49;00m async_client.get([33m"[39;49;00m[33m/api/v1/xgboost/info/risk_prediction[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1801: in get
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:34] [INFO] [app.tests.integration.conftest] - Creating test database session with canonical SQLAlchemy models
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Initializing SQLAlchemy test session with model validation
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Created 4 tables from metadata
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Created tables: users, patients, providers, test_custom_models
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Users table columns: ['id', 'username', 'email', 'first_name', 'last_name', 'password_hash', 'is_active', 'is_verified', 'email_verified', 'role', 'roles', 'last_login', 'failed_login_attempts', 'account_locked_until', 'password_changed_at', 'reset_token', 'reset_token_expires_at', 'verification_token', 'bio', 'preferences', 'access_logs', 'created_at', 'updated_at', 'created_by', 'updated_by', 'audit_id']
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.registry] - Validating 1 registered models
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - Validated 0 models in local registry successfully
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - SQLAlchemy model validation completed successfully
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Committed test users using direct SQL: ['00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002']
[2025-05-02 21:52:34] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:34] [INFO] [app.tests.integration.utils.test_db_initializer] - Test users already exist in database.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:34] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:34] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:34] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:34] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:35] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:35] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:35] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:35] [INFO] [app.app_factory] - FastAPI application creation complete.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:35] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:35] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:35] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[31m[1m_____________ TestPatientRepositoryIntegration.test_create_patient _____________[0m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1815: in _execute_context
    [0mcontext = constructor([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py[0m:1459: in _init_compiled
    [0mflattened_processors[key](compiled_params[key])[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/sql/sqltypes.py[0m:3608: in process
    [0mvalue = value.hex[90m[39;49;00m
[1m[31mE   AttributeError: 'str' object has no attribute 'hex'[0m

[33mThe above exception was the direct cause of the following exception:[0m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:456: in _create_operation
    [0m[94mawait[39;49;00m session.flush()[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py[0m:800: in flush
    [0m[94mawait[39;49;00m greenlet_spawn([96mself[39;49;00m.sync_session.flush, objects=objects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py[0m:203: in greenlet_spawn
    [0mresult = context.switch(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:4341: in flush
    [0m[96mself[39;49;00m._flush(objects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:4476: in _flush
    [0m[94mwith[39;49;00m util.safe_reraise():[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py[0m:146: in __exit__
    [0m[94mraise[39;49;00m exc_value.with_traceback(exc_tb)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:4437: in _flush
    [0mflush_context.execute()[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py[0m:466: in execute
    [0mrec.execute([96mself[39;49;00m)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py[0m:642: in execute
    [0mutil.preloaded.orm_persistence.save_obj([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py[0m:93: in save_obj
    [0m_emit_insert_statements([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py[0m:1048: in _emit_insert_statements
    [0mresult = connection.execute([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1418: in execute
    [0m[94mreturn[39;49;00m meth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py[0m:515: in _execute_on_connection
    [0m[94mreturn[39;49;00m connection._execute_clauseelement([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1640: in _execute_clauseelement
    [0mret = [96mself[39;49;00m._execute_context([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1821: in _execute_context
    [0m[96mself[39;49;00m._handle_dbapi_exception([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:2353: in _handle_dbapi_exception
    [0m[94mraise[39;49;00m sqlalchemy_exception.with_traceback(exc_info[[94m2[39;49;00m]) [94mfrom[39;49;00m[90m [39;49;00m[04m[96me[39;49;00m[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1815: in _execute_context
    [0mcontext = constructor([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py[0m:1459: in _init_compiled
    [0mflattened_processors[key](compiled_params[key])[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/sql/sqltypes.py[0m:3608: in process
    [0mvalue = value.hex[90m[39;49;00m
[1m[31mE   sqlalchemy.exc.StatementError: (builtins.AttributeError) 'str' object has no attribute 'hex'[0m
[1m[31mE   [SQL: INSERT INTO patients (id, external_id, user_id, created_at, updated_at, is_active, first_name, last_name, date_of_birth, email, phone, medical_record_number, ssn, insurance_number, medical_history, medications_data, allergies, treatment_notes, gender, extra_data, address_line1, address_line2, city, state, postal_code, country, emergency_contact, insurance_info, biometric_twin_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)][0m
[1m[31mE   [parameters: [{'id': '6a507a4c-7cb3-4a3b-b068-fb9abdaca05e', 'address_line1': b'123 Test St, Testville, TS, 12345, US', 'first_name': b'Integration', 'medications_d ... (524 characters truncated) ... ': None, 'medical_record_number': None, 'postal_code': None, 'biometric_twin_id': None, 'address_line2': None, 'insurance_number': None, 'city': None}]][0m

[33mThe above exception was the direct cause of the following exception:[0m
[1m[31mapp/tests/integration/infrastructure/persistence/repositories/test_repository.py[0m:371: in test_create_patient
    [0mcreated_patient = [94mawait[39;49;00m repository.create(domain_patient)[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:483: in create
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m._with_session(_create_operation)[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:431: in _with_session
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m operation([96mself[39;49;00m.db_session)[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:476: in _create_operation
    [0m[94mraise[39;49;00m PersistenceError([33mf[39;49;00m[33m"[39;49;00m[33mFailed to create patient due to database error.[39;49;00m[33m"[39;49;00m) [94mfrom[39;49;00m[90m [39;49;00m[04m[96me[39;49;00m[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.PersistenceError: Failed to create patient due to database error.[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:35] [INFO] [app.tests.integration.conftest] - Creating test database session with canonical SQLAlchemy models
[2025-05-02 21:52:35] [INFO] [app.tests.integration.utils.test_db_initializer] - Initializing SQLAlchemy test session with model validation
[2025-05-02 21:52:35] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:35] [INFO] [app.tests.integration.utils.test_db_initializer] - Created 4 tables from metadata
[2025-05-02 21:52:35] [INFO] [app.tests.integration.utils.test_db_initializer] - Created tables: users, patients, providers, test_custom_models
[2025-05-02 21:52:35] [INFO] [app.tests.integration.utils.test_db_initializer] - Users table columns: ['id', 'username', 'email', 'first_name', 'last_name', 'password_hash', 'is_active', 'is_verified', 'email_verified', 'role', 'roles', 'last_login', 'failed_login_attempts', 'account_locked_until', 'password_changed_at', 'reset_token', 'reset_token_expires_at', 'verification_token', 'bio', 'preferences', 'access_logs', 'created_at', 'updated_at', 'created_by', 'updated_by', 'audit_id']
[2025-05-02 21:52:35] [INFO] [app.infrastructure.persistence.sqlalchemy.registry] - Validating 1 registered models
[2025-05-02 21:52:35] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - Validated 0 models in local registry successfully
[2025-05-02 21:52:35] [INFO] [app.tests.integration.utils.test_db_initializer] - SQLAlchemy model validation completed successfully
[2025-05-02 21:52:35] [INFO] [app.tests.integration.utils.test_db_initializer] - Committed test users using direct SQL: ['00000000-0000-0000-0000-000000000001', '00000000-0000-0000-0000-000000000002']
[2025-05-02 21:52:35] [INFO] [app.infrastructure.persistence.sqlalchemy.models.base] - All models loaded successfully: ['User']
[2025-05-02 21:52:35] [INFO] [app.tests.integration.utils.test_db_initializer] - Test users already exist in database.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:35] [INFO] [app.tests.integration.infrastructure.persistence.repositories.test_repository] - Attempting to create patient: 6a507a4c-7cb3-4a3b-b068-fb9abdaca05e
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_emergency_contact'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_medical_history'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_medications'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_allergies'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_treatment_notes'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_extra_data'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [ERROR] [app.infrastructure.persistence.sqlalchemy.repositories.patient_repository] - SQLAlchemyError during patient creation: (builtins.AttributeError) 'str' object has no attribute 'hex'
[SQL: INSERT INTO patients (id, external_id, user_id, created_at, updated_at, is_active, first_name, last_name, date_of_birth, email, phone, medical_record_number, ssn, insurance_number, medical_history, medications_data, allergies, treatment_notes, gender, extra_data, address_line1, address_line2, city, state, postal_code, country, emergency_contact, insurance_info, biometric_twin_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: [{'id': '6a507a4c-7cb3-4a3b-b068-fb9abdaca05e', 'address_line1': b'123 [REDACTED NAME], Testville, TS, 12345, US', 'first_name': b'Integration', 'medications_d ... (524 characters truncated) ... ': None, 'medical_record_number': None, 'postal_code': None, 'biometric_twin_id': None, 'address_line2': None, 'insurance_number': None, 'city': None}]]
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1815, in _execute_context
    context = constructor(
              ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 1459, in _init_compiled
    flattened_processors[key](compiled_params[key])
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/sql/sqltypes.py", line 3608, in process
    value = value.hex
            ^^^^^^^^^
AttributeError: 'str' object has no attribute 'hex'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py", line 456, in _create_operation
    await session.flush()
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 800, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4341, in flush
    self._flush(objects)
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4476, in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4437, in _flush
    flush_context.execute()
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1048, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1821, in _execute_context
    self._handle_dbapi_exception(
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2353, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1815, in _execute_context
    context = constructor(
              ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 1459, in _init_compiled
    flattened_processors[key](compiled_params[key])
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/sql/sqltypes.py", line 3608, in process
    value = value.hex
            ^^^^^^^^^
sqlalchemy.exc.StatementError: (builtins.AttributeError) 'str' object has no attribute 'hex'
[SQL: INSERT INTO patients (id, external_id, user_id, created_at, updated_at, is_active, first_name, last_name, date_of_birth, email, phone, medical_record_number, ssn, insurance_number, medical_history, medications_data, allergies, treatment_notes, gender, extra_data, address_line1, address_line2, city, state, postal_code, country, emergency_contact, insurance_info, biometric_twin_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: [{'id': '6a507a4c-7cb3-4a3b-b068-fb9abdaca05e', 'address_line1': b'123 Test St, Testville, TS, 12345, US', 'first_name': b'Integration', 'medications_d ... (524 characters truncated) ... ': None, 'medical_record_number': None, 'postal_code': None, 'biometric_twin_id': None, 'address_line2': None, 'insurance_number': None, 'city': None}]]
[2025-05-02 21:52:35] [ERROR] [app.infrastructure.persistence.sqlalchemy.repositories.patient_repository] - SQLAlchemyError during patient creation: (builtins.AttributeError) 'str' object has no attribute 'hex'
[SQL: INSERT INTO patients (id, external_id, user_id, created_at, updated_at, is_active, first_name, last_name, date_of_birth, email, phone, medical_record_number, ssn, insurance_number, medical_history, medications_data, allergies, treatment_notes, gender, extra_data, address_line1, address_line2, city, state, postal_code, country, emergency_contact, insurance_info, biometric_twin_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: [{'id': '6a507a4c-7cb3-4a3b-b068-fb9abdaca05e', 'address_line1': b'123 [REDACTED NAME], Testville, TS, 12345, US', 'first_name': b'Integration', 'medications_d ... (524 characters truncated) ... ': None, 'medical_record_number': None, 'postal_code': None, 'biometric_twin_id': None, 'address_line2': None, 'insurance_number': None, 'city': None}]]
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1815, in _execute_context
    context = constructor(
              ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 1459, in _init_compiled
    flattened_processors[key](compiled_params[key])
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/sql/sqltypes.py", line 3608, in process
    value = value.hex
            ^^^^^^^^^
AttributeError: 'str' object has no attribute 'hex'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py", line 456, in _create_operation
    await session.flush()
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py", line 800, in flush
    await greenlet_spawn(self.sync_session.flush, objects=objects)
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 203, in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4341, in flush
    self._flush(objects)
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4476, in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py", line 146, in __exit__
    raise exc_value.with_traceback(exc_tb)
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py", line 4437, in _flush
    flush_context.execute()
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 466, in execute
    rec.execute(self)
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py", line 642, in execute
    util.preloaded.orm_persistence.save_obj(
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 93, in save_obj
    _emit_insert_statements(
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py", line 1048, in _emit_insert_statements
    result = connection.execute(
             ^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1418, in execute
    return meth(
           ^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py", line 515, in _execute_on_connection
    return connection._execute_clauseelement(
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1640, in _execute_clauseelement
    ret = self._execute_context(
          ^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1821, in _execute_context
    self._handle_dbapi_exception(
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 2353, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py", line 1815, in _execute_context
    context = constructor(
              ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py", line 1459, in _init_compiled
    flattened_processors[key](compiled_params[key])
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/sql/sqltypes.py", line 3608, in process
    value = value.hex
            ^^^^^^^^^
sqlalchemy.exc.StatementError: (builtins.AttributeError) 'str' object has no attribute 'hex'
[SQL: INSERT INTO patients (id, external_id, user_id, created_at, updated_at, is_active, first_name, last_name, date_of_birth, email, phone, medical_record_number, ssn, insurance_number, medical_history, medications_data, allergies, treatment_notes, gender, extra_data, address_line1, address_line2, city, state, postal_code, country, emergency_contact, insurance_info, biometric_twin_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)]
[parameters: [{'id': '6a507a4c-7cb3-4a3b-b068-fb9abdaca05e', 'address_line1': b'123 Test St, Testville, TS, 12345, US', 'first_name': b'Integration', 'medications_d ... (524 characters truncated) ... ': None, 'medical_record_number': None, 'postal_code': None, 'biometric_twin_id': None, 'address_line2': None, 'insurance_number': None, 'city': None}]]
[31m[1m_______ TestPatientEncryptionIntegration.test_phi_encrypted_in_database ________[0m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1815: in _execute_context
    [0mcontext = constructor([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py[0m:1459: in _init_compiled
    [0mflattened_processors[key](compiled_params[key])[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/sql/sqltypes.py[0m:3608: in process
    [0mvalue = value.hex[90m[39;49;00m
[1m[31mE   AttributeError: 'str' object has no attribute 'hex'[0m

[33mThe above exception was the direct cause of the following exception:[0m
[1m[31mapp/tests/integration/infrastructure/persistence/test_patient_encryption_integration.py[0m:193: in test_phi_encrypted_in_database
    [0m[94mawait[39;49;00m db_session.commit()[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py[0m:1009: in commit
    [0m[94mawait[39;49;00m greenlet_spawn([96mself[39;49;00m.sync_session.commit)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py[0m:203: in greenlet_spawn
    [0mresult = context.switch(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:2017: in commit
    [0mtrans.commit(_to_root=[94mTrue[39;49;00m)[90m[39;49;00m
[1m[31m<string>[0m:2: in commit
    [0m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py[0m:139: in _go
    [0mret_value = fn([96mself[39;49;00m, *arg, **kw)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:1302: in commit
    [0m[96mself[39;49;00m._prepare_impl()[90m[39;49;00m
[1m[31m<string>[0m:2: in _prepare_impl
    [0m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py[0m:139: in _go
    [0mret_value = fn([96mself[39;49;00m, *arg, **kw)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:1277: in _prepare_impl
    [0m[96mself[39;49;00m.session.flush()[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:4341: in flush
    [0m[96mself[39;49;00m._flush(objects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:4476: in _flush
    [0m[94mwith[39;49;00m util.safe_reraise():[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py[0m:146: in __exit__
    [0m[94mraise[39;49;00m exc_value.with_traceback(exc_tb)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:4437: in _flush
    [0mflush_context.execute()[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py[0m:466: in execute
    [0mrec.execute([96mself[39;49;00m)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py[0m:642: in execute
    [0mutil.preloaded.orm_persistence.save_obj([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py[0m:93: in save_obj
    [0m_emit_insert_statements([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py[0m:1048: in _emit_insert_statements
    [0mresult = connection.execute([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1418: in execute
    [0m[94mreturn[39;49;00m meth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py[0m:515: in _execute_on_connection
    [0m[94mreturn[39;49;00m connection._execute_clauseelement([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1640: in _execute_clauseelement
    [0mret = [96mself[39;49;00m._execute_context([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1821: in _execute_context
    [0m[96mself[39;49;00m._handle_dbapi_exception([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:2353: in _handle_dbapi_exception
    [0m[94mraise[39;49;00m sqlalchemy_exception.with_traceback(exc_info[[94m2[39;49;00m]) [94mfrom[39;49;00m[90m [39;49;00m[04m[96me[39;49;00m[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1815: in _execute_context
    [0mcontext = constructor([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py[0m:1459: in _init_compiled
    [0mflattened_processors[key](compiled_params[key])[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/sql/sqltypes.py[0m:3608: in process
    [0mvalue = value.hex[90m[39;49;00m
[1m[31mE   sqlalchemy.exc.StatementError: (builtins.AttributeError) 'str' object has no attribute 'hex'[0m
[1m[31mE   [SQL: INSERT INTO patients (id, external_id, user_id, created_at, updated_at, is_active, first_name, last_name, date_of_birth, email, phone, medical_record_number, ssn, insurance_number, medical_history, medications_data, allergies, treatment_notes, gender, extra_data, address_line1, address_line2, city, state, postal_code, country, emergency_contact, insurance_info, biometric_twin_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)][0m
[1m[31mE   [parameters: [{'id': 'b068dba1-b7db-4a03-89ea-d1e5eae74f43', 'first_name': b'v1:gAAAAABoFXbjEXTt1LbuIPqNad9X6G1NyETluH-ZkVrx4-M0B_UJA8YJ_I7yvIwwZz6ln5Ainu14zPH9Zhi- ... (1327 characters truncated) ... number': None, 'postal_code': None, 'gender': None, 'biometric_twin_id': None, 'address_line2': None, 'insurance_number': None, 'address_line1': None}]][0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:35] [INFO] [app.tests.integration.infrastructure.persistence.test_patient_encryption_integration] - [[REDACTED NAME]] Setting up test database with REAL metadata: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:35] [INFO] [app.tests.integration.infrastructure.persistence.test_patient_encryption_integration] - [[REDACTED NAME]] Created all tables using real Base metadata.
[2025-05-02 21:52:35] [INFO] [app.tests.integration.infrastructure.persistence.test_patient_encryption_integration] - [[REDACTED NAME]] Created necessary test user using direct SQL: 00000000-0000-0000-0000-000000000001
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt: Encryption service did not return bytes for '_first_name'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt: Encryption service did not return bytes for '_last_name'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt: Encryption service did not return bytes for '_dob'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt: Encryption service did not return bytes for '_email'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt: Encryption service did not return bytes for '_phone'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_medical_history'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_medications'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_allergies'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_treatment_notes'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_extra_data'. Type: <class 'str'>. Attempting encode.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:35] [INFO] [app.tests.integration.infrastructure.persistence.test_patient_encryption_integration] - [[REDACTED NAME]] Rolled back test database session.
[2025-05-02 21:52:35] [INFO] [app.tests.integration.infrastructure.persistence.test_patient_encryption_integration] - [[REDACTED NAME]] Disposed engine.
[31m[1m______ TestPatientEncryptionIntegration.test_phi_decrypted_in_repository _______[0m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1815: in _execute_context
    [0mcontext = constructor([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py[0m:1459: in _init_compiled
    [0mflattened_processors[key](compiled_params[key])[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/sql/sqltypes.py[0m:3608: in process
    [0mvalue = value.hex[90m[39;49;00m
[1m[31mE   AttributeError: 'str' object has no attribute 'hex'[0m

[33mThe above exception was the direct cause of the following exception:[0m
[1m[31mapp/tests/integration/infrastructure/persistence/test_patient_encryption_integration.py[0m:248: in test_phi_decrypted_in_repository
    [0m[94mawait[39;49;00m db_session.commit()[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/ext/asyncio/session.py[0m:1009: in commit
    [0m[94mawait[39;49;00m greenlet_spawn([96mself[39;49;00m.sync_session.commit)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/util/_concurrency_py3k.py[0m:203: in greenlet_spawn
    [0mresult = context.switch(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:2017: in commit
    [0mtrans.commit(_to_root=[94mTrue[39;49;00m)[90m[39;49;00m
[1m[31m<string>[0m:2: in commit
    [0m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py[0m:139: in _go
    [0mret_value = fn([96mself[39;49;00m, *arg, **kw)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:1302: in commit
    [0m[96mself[39;49;00m._prepare_impl()[90m[39;49;00m
[1m[31m<string>[0m:2: in _prepare_impl
    [0m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/state_changes.py[0m:139: in _go
    [0mret_value = fn([96mself[39;49;00m, *arg, **kw)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:1277: in _prepare_impl
    [0m[96mself[39;49;00m.session.flush()[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:4341: in flush
    [0m[96mself[39;49;00m._flush(objects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:4476: in _flush
    [0m[94mwith[39;49;00m util.safe_reraise():[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py[0m:146: in __exit__
    [0m[94mraise[39;49;00m exc_value.with_traceback(exc_tb)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/session.py[0m:4437: in _flush
    [0mflush_context.execute()[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py[0m:466: in execute
    [0mrec.execute([96mself[39;49;00m)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/unitofwork.py[0m:642: in execute
    [0mutil.preloaded.orm_persistence.save_obj([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py[0m:93: in save_obj
    [0m_emit_insert_statements([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/persistence.py[0m:1048: in _emit_insert_statements
    [0mresult = connection.execute([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1418: in execute
    [0m[94mreturn[39;49;00m meth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/sql/elements.py[0m:515: in _execute_on_connection
    [0m[94mreturn[39;49;00m connection._execute_clauseelement([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1640: in _execute_clauseelement
    [0mret = [96mself[39;49;00m._execute_context([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1821: in _execute_context
    [0m[96mself[39;49;00m._handle_dbapi_exception([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:2353: in _handle_dbapi_exception
    [0m[94mraise[39;49;00m sqlalchemy_exception.with_traceback(exc_info[[94m2[39;49;00m]) [94mfrom[39;49;00m[90m [39;49;00m[04m[96me[39;49;00m[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/base.py[0m:1815: in _execute_context
    [0mcontext = constructor([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/engine/default.py[0m:1459: in _init_compiled
    [0mflattened_processors[key](compiled_params[key])[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/sql/sqltypes.py[0m:3608: in process
    [0mvalue = value.hex[90m[39;49;00m
[1m[31mE   sqlalchemy.exc.StatementError: (builtins.AttributeError) 'str' object has no attribute 'hex'[0m
[1m[31mE   [SQL: INSERT INTO patients (id, external_id, user_id, created_at, updated_at, is_active, first_name, last_name, date_of_birth, email, phone, medical_record_number, ssn, insurance_number, medical_history, medications_data, allergies, treatment_notes, gender, extra_data, address_line1, address_line2, city, state, postal_code, country, emergency_contact, insurance_info, biometric_twin_id) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)][0m
[1m[31mE   [parameters: [{'id': '32b26493-b1de-4b36-b483-d5a7158e3267', 'first_name': b'v1:gAAAAABoFXbjfKXuLgK4i9oGfCgJUDSL2PZAzPUDI3Yq8PVlPBcmORlKZZCIuZMwmCnQfo6heOeyKjwlpJUd ... (1327 characters truncated) ... number': None, 'postal_code': None, 'gender': None, 'biometric_twin_id': None, 'address_line2': None, 'insurance_number': None, 'address_line1': None}]][0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:35] [INFO] [app.tests.integration.infrastructure.persistence.test_patient_encryption_integration] - [[REDACTED NAME]] Setting up test database with REAL metadata: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:35] [INFO] [app.tests.integration.infrastructure.persistence.test_patient_encryption_integration] - [[REDACTED NAME]] Created all tables using real Base metadata.
[2025-05-02 21:52:35] [INFO] [app.tests.integration.infrastructure.persistence.test_patient_encryption_integration] - [[REDACTED NAME]] Created necessary test user using direct SQL: 00000000-0000-0000-0000-000000000001
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.security.encryption.base_encryption_service] - ENCRYPTION_KEY not found or invalid, attempting key derivation as fallback.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.security.encryption.base_encryption_service] - Using derived key - ensure this is acceptable for your security posture.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt: Encryption service did not return bytes for '_first_name'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt: Encryption service did not return bytes for '_last_name'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt: Encryption service did not return bytes for '_dob'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt: Encryption service did not return bytes for '_email'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt: Encryption service did not return bytes for '_phone'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_medical_history'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_medications'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_allergies'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_treatment_notes'. Type: <class 'str'>. Attempting encode.
[2025-05-02 21:52:35] [WARNING] [app.infrastructure.persistence.sqlalchemy.models.patient] - _encrypt_serializable: Encryption service did not return bytes for '_extra_data'. Type: <class 'str'>. Attempting encode.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:36] [INFO] [app.tests.integration.infrastructure.persistence.test_patient_encryption_integration] - [[REDACTED NAME]] Rolled back test database session.
[2025-05-02 21:52:36] [INFO] [app.tests.integration.infrastructure.persistence.test_patient_encryption_integration] - [[REDACTED NAME]] Disposed engine.
[31m[1m____________________ TestAuthentication.test_missing_token _____________________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:54: in test_missing_token
    [0m[94massert[39;49;00m response.status_code == status.HTTP_401_UNAUTHORIZED[90m[39;49;00m
[1m[31mE   assert 404 == 401[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   401 = status.HTTP_401_UNAUTHORIZED[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:39] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:39] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_________________ TestAuthentication.test_invalid_token_format _________________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:62: in test_invalid_token_format
    [0m[94massert[39;49;00m response.status_code == status.HTTP_401_UNAUTHORIZED[90m[39;49;00m
[1m[31mE   assert 404 == 401[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   401 = status.HTTP_401_UNAUTHORIZED[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:39] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:39] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m____________________ TestAuthentication.test_expired_token _____________________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:80: in test_expired_token
    [0m[94massert[39;49;00m response.status_code == status.HTTP_401_UNAUTHORIZED[90m[39;49;00m
[1m[31mE   assert 404 == 401[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   401 = status.HTTP_401_UNAUTHORIZED[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:39] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:39] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:39] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m____________________ TestAuthentication.test_tampered_token ____________________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:96: in test_tampered_token
    [0m[94massert[39;49;00m response.status_code == status.HTTP_401_UNAUTHORIZED[90m[39;49;00m
[1m[31mE   assert 404 == 401[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   401 = status.HTTP_401_UNAUTHORIZED[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:39] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:39] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:39] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m__________________ TestAuthentication.test_valid_token_access __________________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:113: in test_valid_token_access
    [0mmock_user_id = uuid.UUID([33m"[39;49;00m[33mtest-integration-user[39;49;00m[33m"[39;49;00m) [90m# ID from get_valid_auth_headers[39;49;00m[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/uuid.py[0m:178: in __init__
    [0m[94mraise[39;49;00m [96mValueError[39;49;00m([33m'[39;49;00m[33mbadly formed hexadecimal UUID string[39;49;00m[33m'[39;49;00m)[90m[39;49;00m
[1m[31mE   ValueError: badly formed hexadecimal UUID string[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:39] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:40] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m______________ TestAuthorization.test_patient_accessing_own_data _______________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:158: in test_patient_accessing_own_data
    [0mmock_user_id = uuid.UUID([33m"[39;49;00m[33mtest-integration-user[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/uuid.py[0m:178: in __init__
    [0m[94mraise[39;49;00m [96mValueError[39;49;00m([33m'[39;49;00m[33mbadly formed hexadecimal UUID string[39;49;00m[33m'[39;49;00m)[90m[39;49;00m
[1m[31mE   ValueError: badly formed hexadecimal UUID string[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:40] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_________ TestAuthorization.test_patient_accessing_other_patient_data __________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:193: in test_patient_accessing_other_patient_data
    [0m[94massert[39;49;00m response.status_code == status.HTTP_403_FORBIDDEN[90m[39;49;00m
[1m[31mE   assert 404 == 403[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   403 = status.HTTP_403_FORBIDDEN[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:40] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:40] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/patients/32227ef1-00ce-4117-9e24-778b318aab78 "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/patients/32227ef1-00ce-4117-9e24-778b318aab78 "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m____________ TestAuthorization.test_provider_accessing_patient_data ____________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:228: in test_provider_accessing_patient_data
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   assert 404 == 200[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   200 = status.HTTP_200_OK[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:40] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
----------------------------- Captured stdout call -----------------------------
---> [DEBUG] Original get_repository called for repo_type: IPatientRepository
[2025-05-02 21:52:40] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
---> [DEBUG] Original get_repository called for repo_type: IPatientRepository
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m____________ TestInputValidation.test_invalid_input_format_rejected ____________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:287: in test_invalid_input_format_rejected
    [0m[94massert[39;49;00m response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY[90m[39;49;00m
[1m[31mE   assert 404 == 422[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   422 = status.HTTP_422_UNPROCESSABLE_ENTITY[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:40] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:40] [INFO] [httpx] - HTTP Request: POST http://test/api/v1/patients "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: POST http://test/api/v1/patients "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_____________ TestInputValidation.test_input_sanitization_handling _____________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:306: in test_input_sanitization_handling
    [0m[94massert[39;49;00m response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY[90m[39;49;00m
[1m[31mE   assert 404 == 422[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   422 = status.HTTP_422_UNPROCESSABLE_ENTITY[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:40] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:40] [INFO] [httpx] - HTTP Request: POST http://test/api/v1/patients "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: POST http://test/api/v1/patients "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m____________ TestInputValidation.test_input_length_limits_enforced _____________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:325: in test_input_length_limits_enforced
    [0m[94massert[39;49;00m response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY[90m[39;49;00m
[1m[31mE   assert 404 == 422[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   422 = status.HTTP_422_UNPROCESSABLE_ENTITY[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:40] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:40] [INFO] [httpx] - HTTP Request: POST http://test/api/v1/patients "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: POST http://test/api/v1/patients "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m___________ TestSecureHeaders.test_required_security_headers_present ___________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:337: in test_required_security_headers_present
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   assert 404 == 200[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   200 = status.HTTP_200_OK[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:40] [INFO] [httpx] - HTTP Request: GET http://test/health "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/health "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m______________ TestSecureHeaders.test_cors_headers_configuration _______________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:356: in test_cors_headers_configuration
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   assert 404 == 200[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   200 = status.HTTP_200_OK[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:40] [INFO] [httpx] - HTTP Request: OPTIONS http://test/health "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: OPTIONS http://test/health "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_____________ TestErrorHandling.test_internal_server_error_masked ______________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:411: in test_internal_server_error_masked
    [0m[94massert[39;49;00m response.status_code == status.HTTP_500_INTERNAL_SERVER_ERROR[90m[39;49;00m
[1m[31mE   assert 404 == 500[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   500 = status.HTTP_500_INTERNAL_SERVER_ERROR[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
[2025-05-02 21:52:40] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
----------------------------- Captured stdout call -----------------------------
---> [DEBUG] Original get_repository called for repo_type: IPatientRepository
---> [DEBUG] Original get_repository called for repo_type: IPatientRepository
[2025-05-02 21:52:40] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
---> [DEBUG] Original get_repository called for repo_type: IPatientRepository
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m________________ test_access_patient_phi_data_success_provider _________________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:441: in test_access_patient_phi_data_success_provider
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   assert 404 == 200[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   200 = status.HTTP_200_OK[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
---> [DEBUG] Original get_repository called for repo_type: IPatientRepository
[2025-05-02 21:52:40] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m______________ test_access_patient_phi_data_unauthorized_patient _______________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:455: in test_access_patient_phi_data_unauthorized_patient
    [0m[94massert[39;49;00m response.status_code == status.HTTP_403_FORBIDDEN[90m[39;49;00m
[1m[31mE   assert 404 == 403[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   403 = status.HTTP_403_FORBIDDEN[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:40] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/patients/32227ef1-00ce-4117-9e24-778b318aab78 "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/patients/32227ef1-00ce-4117-9e24-778b318aab78 "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m________________ test_access_patient_phi_data_patient_not_found ________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:2362: in assert_awaited_once_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected get_by_id to have been awaited once. Awaited 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:471: in test_access_patient_phi_data_patient_not_found
    [0mmock_repo.get_by_id.assert_awaited_once_with(uuid.UUID(TEST_PATIENT_ID))[90m[39;49;00m
[1m[31mE   AssertionError: Expected get_by_id to have been awaited once. Awaited 0 times.[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
---> [DEBUG] Original get_repository called for repo_type: IPatientRepository
[2025-05-02 21:52:40] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_____________________ test_authenticated_but_unknown_role ______________________[0m
[1m[31mapp/tests/security/api/test_api_security.py[0m:495: in test_authenticated_but_unknown_role
    [0m[94massert[39;49;00m response.status_code == status.HTTP_403_FORBIDDEN[90m[39;49;00m
[1m[31mE   assert 404 == 403[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   403 = status.HTTP_403_FORBIDDEN[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:52:40] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:40] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/patients/1c8fd0c8-cc09-4f3c-a8df-7fa598dbbd91 "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m______________ TestPHIAudit.test_clean_app_directory_special_case ______________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1020: in assert_any_call
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m([90m[39;49;00m
[1m[31mE   AssertionError: info('Found potential PHI in a clean_app directory: %s', '/var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpu8gkpai4/clean_app_test_data/domain/test_data.py') call not found[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/audit/test_phi_audit.py[0m:342: in test_clean_app_directory_special_case
    [0mmock_logger.info.assert_any_call([33m"[39;49;00m[33mFound potential PHI in a clean_app directory: [39;49;00m[33m%s[39;49;00m[33m"[39;49;00m, os.path.join(app_dir, [33m"[39;49;00m[33mdomain[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mtest_data.py[39;49;00m[33m"[39;49;00m))[90m[39;49;00m
[1m[31mE   AssertionError: info('Found potential PHI in a clean_app directory: %s', '/var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpu8gkpai4/clean_app_test_data/domain/test_data.py') call not found[0m
[1m[31mE   [0m
[1m[31mE   pytest introspection follows:[0m
[1m[31mE   [0m
[1m[31mE   Args:[0m
[1m[31mE   assert ('PHI audit c...in 3 files.',) == ('Found poten...test_data.py')[0m
[1m[31mE     [0m
[1m[31mE     At index 0 diff: [0m[33m'[39;49;00m[33mPHI audit complete. 4 issues allowed due to special case in 3 files.[39;49;00m[33m'[39;49;00m[90m[39;49;00m != [0m[33m'[39;49;00m[33mFound potential PHI in a clean_app directory: [39;49;00m[33m%s[39;49;00m[33m'[39;49;00m[90m[39;49;00m[0m
[1m[31mE     Right contains one more item: [0m[33m'[39;49;00m[33m/var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpu8gkpai4/clean_app_test_data/domain/test_data.py[39;49;00m[33m'[39;49;00m[90m[39;49;00m[0m
[1m[31mE     Use -v to get more diff[0m
[31m[1m___________________ TestPHIAudit.test_audit_with_clean_files ___________________[0m
[1m[31mapp/tests/security/audit/test_phi_audit.py[0m:306: in test_audit_with_clean_files
    [0m[94massert[39;49;00m auditor._count_total_issues() == [94m0[39;49;00m[90m[39;49;00m
[1m[31mE   assert 4 == 0[0m
[1m[31mE    +  where 4 = <bound method PHIAuditor._count_total_issues of <scripts.test.security.run_hipaa_phi_audit.PHIAuditor object at 0x1684aede0>>()[0m
[1m[31mE    +    where <bound method PHIAuditor._count_total_issues of <scripts.test.security.run_hipaa_phi_audit.PHIAuditor object at 0x1684aede0>> = <scripts.test.security.run_hipaa_phi_audit.PHIAuditor object at 0x1684aede0>._count_total_issues[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:40] [INFO] [scripts.test.security.run_hipaa_phi_audit] - PHI audit complete. Found 0 files with PHI issues out of 2 examined.
[2025-05-02 21:52:40] [WARNING] [scripts.test.security.run_hipaa_phi_audit] - API security issue found in /var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpj49fad_u/clean_app_no_phi/presentation/api/v1/endpoints/patients.py
[2025-05-02 21:52:40] [WARNING] [scripts.test.security.run_hipaa_phi_audit] - API security issue found in /var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpj49fad_u/clean_app_no_phi/presentation/api/v1/endpoints/patients.py
[2025-05-02 21:52:40] [WARNING] [scripts.test.security.run_hipaa_phi_audit] - Missing security settings in /var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpj49fad_u/clean_app_no_phi/core/config.py: JWT_SECRET, ENCRYPTION_KEY, SSL_CERT, AUTH_REQUIRED, HIPAA_COMPLIANT
[2025-05-02 21:52:40] [WARNING] [scripts.test.security.run_hipaa_phi_audit] - Missing security settings in /var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpj49fad_u/clean_app_no_phi/core/config.py: JWT_SECRET, ENCRYPTION_KEY, SSL_CERT, AUTH_REQUIRED, HIPAA_COMPLIANT, encryption
[2025-05-02 21:52:40] [INFO] [scripts.test.security.run_hipaa_phi_audit] - PHI audit complete. 4 issues allowed due to special case in 4 files.
------------------------------ Captured log call -------------------------------
[32mINFO    [0m scripts.test.security.run_hipaa_phi_audit:run_hipaa_phi_audit.py:567 PHI audit complete. Found 0 files with PHI issues out of 2 examined.
[33mWARNING [0m scripts.test.security.run_hipaa_phi_audit:run_hipaa_phi_audit.py:411 API security issue found in /var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpj49fad_u/clean_app_no_phi/presentation/api/v1/endpoints/patients.py
[33mWARNING [0m scripts.test.security.run_hipaa_phi_audit:run_hipaa_phi_audit.py:454 API security issue found in /var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpj49fad_u/clean_app_no_phi/presentation/api/v1/endpoints/patients.py
[33mWARNING [0m scripts.test.security.run_hipaa_phi_audit:run_hipaa_phi_audit.py:496 Missing security settings in /var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpj49fad_u/clean_app_no_phi/core/config.py: JWT_SECRET, ENCRYPTION_KEY, SSL_CERT, AUTH_REQUIRED, HIPAA_COMPLIANT
[33mWARNING [0m scripts.test.security.run_hipaa_phi_audit:run_hipaa_phi_audit.py:544 Missing security settings in /var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpj49fad_u/clean_app_no_phi/core/config.py: JWT_SECRET, ENCRYPTION_KEY, SSL_CERT, AUTH_REQUIRED, HIPAA_COMPLIANT, encryption
[32mINFO    [0m scripts.test.security.run_hipaa_phi_audit:run_hipaa_phi_audit.py:637 PHI audit complete. 4 issues allowed due to special case in 4 files.
[31m[1m______________________________ test_login_success ______________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_endpoints.py", line 113, in test_login_success
    |     response = client.post("/api/v1/auth/login", json=login_data)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 633, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1145, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_endpoints.py[0m:113: in test_login_success
    [0mresponse = client.post([33m"[39;49;00m[33m/api/v1/auth/login[39;49;00m[33m"[39;49;00m, json=login_data)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:633: in post
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1145: in post
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:40] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:40] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:40] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:40] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:40] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:40] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:40] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:40] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:40] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:40] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:40] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:40] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:40] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Application startup complete.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:40] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:40] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Application shutdown complete.
[31m[1m________________________ test_login_invalid_credentials ________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_endpoints.py", line 142, in test_login_invalid_credentials
    |     response = client.post("/api/v1/auth/login", json=login_data)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 633, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1145, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_endpoints.py[0m:142: in test_login_invalid_credentials
    [0mresponse = client.post([33m"[39;49;00m[33m/api/v1/auth/login[39;49;00m[33m"[39;49;00m, json=login_data)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:633: in post
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1145: in post
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:40] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:40] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:40] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:40] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:40] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:40] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:40] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:40] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:40] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:40] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:40] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:40] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:40] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Application startup complete.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:40] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:40] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Application shutdown complete.
[31m[1m_________________________ test_login_inactive_account __________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_endpoints.py", line 169, in test_login_inactive_account
    |     response = client.post("/api/v1/auth/login", json=login_data)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 633, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1145, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_endpoints.py[0m:169: in test_login_inactive_account
    [0mresponse = client.post([33m"[39;49;00m[33m/api/v1/auth/login[39;49;00m[33m"[39;49;00m, json=login_data)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:633: in post
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1145: in post
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:40] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:40] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:40] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:40] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:41] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:41] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application startup complete.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:41] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:41] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application shutdown complete.
[31m[1m__________________________ test_refresh_token_success __________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_endpoints.py", line 194, in test_refresh_token_success
    |     response = client.post("/api/v1/auth/refresh", json=refresh_data)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 633, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1145, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_endpoints.py[0m:194: in test_refresh_token_success
    [0mresponse = client.post([33m"[39;49;00m[33m/api/v1/auth/refresh[39;49;00m[33m"[39;49;00m, json=refresh_data)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:633: in post
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1145: in post
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:41] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:41] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:41] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:41] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application startup complete.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:41] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:41] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application shutdown complete.
[31m[1m__________________________ test_refresh_token_invalid __________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_endpoints.py", line 221, in test_refresh_token_invalid
    |     response = client.post("/api/v1/auth/refresh", json=refresh_data)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 633, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1145, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_endpoints.py[0m:221: in test_refresh_token_invalid
    [0mresponse = client.post([33m"[39;49;00m[33m/api/v1/auth/refresh[39;49;00m[33m"[39;49;00m, json=refresh_data)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:633: in post
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1145: in post
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:41] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:41] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:41] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:41] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application startup complete.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:41] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:41] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application shutdown complete.
[31m[1m__________________________ test_refresh_token_missing __________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_endpoints.py", line 241, in test_refresh_token_missing
    |     response = client.post("/api/v1/auth/refresh", json={})
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 633, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1145, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_endpoints.py[0m:241: in test_refresh_token_missing
    [0mresponse = client.post([33m"[39;49;00m[33m/api/v1/auth/refresh[39;49;00m[33m"[39;49;00m, json={})[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:633: in post
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1145: in post
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:41] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:41] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:41] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:41] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application startup complete.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:41] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:41] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application shutdown complete.
[31m[1m_________________________________ test_logout __________________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_endpoints.py", line 263, in test_logout
    |     response = client.post("/api/v1/auth/logout", headers=headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 633, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1145, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_endpoints.py[0m:263: in test_logout
    [0mresponse = client.post([33m"[39;49;00m[33m/api/v1/auth/logout[39;49;00m[33m"[39;49;00m, headers=headers)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:633: in post
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1145: in post
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:41] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:41] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:41] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:41] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application startup complete.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:41] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:41] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application shutdown complete.
[31m[1m_______________________ test_session_info_authenticated ________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_endpoints.py", line 287, in test_session_info_authenticated
    |     response = client.get("/api/v1/auth/session-info")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 548, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_endpoints.py[0m:287: in test_session_info_authenticated
    [0mresponse = client.get([33m"[39;49;00m[33m/api/v1/auth/session-info[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:548: in get
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().get([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1054: in get
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:41] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:41] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:41] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:41] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:41] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:41] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:42] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:42] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:42] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:42] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:42] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Application startup complete.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:42] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:42] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Application shutdown complete.
[31m[1m_____________________ test_session_info_not_authenticated ______________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_endpoints.py", line 304, in test_session_info_not_authenticated
    |     response = client.get("/api/v1/auth/session-info")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 548, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_endpoints.py[0m:304: in test_session_info_not_authenticated
    [0mresponse = client.get([33m"[39;49;00m[33m/api/v1/auth/session-info[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:548: in get
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().get([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1054: in get
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Creating FastAPI application with version: 0.1.0
[2025-05-02 21:52:42] [WARNING] [app.app_factory] - SENTRY_DSN not configured. Sentry integration disabled.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Adding middleware...
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Added SecurityHeadersMiddleware.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Added CORSMiddleware with origins: ['http://localhost:3000', 'http://localhost:8000']
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Added LoggingMiddleware.
[2025-05-02 21:52:42] [INFO] [app.infrastructure.security.rate_limiting.limiter] - Rate limiter initialized with limits: ['60/minute', '1000/hour'], strategy: ip
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Added RateLimitingMiddleware.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Added AuthenticationMiddleware. Public paths: {'/api/0.1.0/auth/login', '/api/0.1.0/docs', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/health', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json'}
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Middleware configuration complete.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Adding API routers...
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Calling setup_routers()...
Successfully included auth router. Routes: ['/login', '/refresh', '/logout', '/me', '/session-info']
Python path during import: ['/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/domain/entities/backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/scripts', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python312.zip', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12', '/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/lib-dynload', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages', '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app']
Current directory: /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend
TESTING environment variable: true
Successfully included test_xgboost_router with routes: ['/api/v1/xgboost/predict/risk', '/api/v1/xgboost/predict/treatment-response', '/api/v1/xgboost/predict/outcome', '/api/v1/xgboost/explain/{model_type}/{prediction_id}', '/api/v1/xgboost/integrate/{prediction_id}', '/api/v1/xgboost/info/{model_type}']
[2025-05-02 21:52:42] [INFO] [app.app_factory] - setup_routers() returned.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Included main API router with prefix: /api/0.1.0
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Registering exception handlers...
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Exception handlers registered (assuming defined via decorators).
[2025-05-02 21:52:42] [INFO] [app.app_factory] - FastAPI application creation complete.
[2025-05-02 21:52:42] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:52:42] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:52:42] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Application startup: Initializing resources...
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Initializing database connection...
[2025-05-02 21:52:42] [INFO] [app.core.dependencies.database] - Creating database engine for URL: sqlite+aiosqlite:***
[2025-05-02 21:52:42] [INFO] [app.core.dependencies.database] - Initializing database...
[2025-05-02 21:52:42] [INFO] [app.core.dependencies.database] - Dropping all tables (dev/test environment)...
[2025-05-02 21:52:42] [INFO] [app.core.dependencies.database] - Creating all tables (dev/test environment)...
[2025-05-02 21:52:42] [INFO] [app.core.dependencies.database] - Database tables created.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Database connection initialized.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:42] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool initialized at redis://localhost:6379/0
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Redis connection pool initialized.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Application startup complete.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Application shutdown: Cleaning up resources...
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Database resources cleaned (implicitly by session management).
[2025-05-02 21:52:42] [INFO] [app.app_factory] - [REDACTED NAME] connection pool...
[2025-05-02 21:52:42] [INFO] [app.infrastructure.cache.redis_cache] - [REDACTED NAME] pool closed.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Redis connection pool closed.
[2025-05-02 21:52:42] [INFO] [app.app_factory] - Application shutdown complete.
[31m[1m__________ TestHIPAAAuthCompliance.test_token_operations_audit_trail ___________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:918: in assert_called
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'encode' to have been called.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_hipaa_compliance.py[0m:248: in test_token_operations_audit_trail
    [0mmock_encode.assert_called()[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'encode' to have been called.[0m
[31m[1m___________________________ test_public_route_access ___________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_middleware.py", line 74, in test_public_route_access
    |     response = test_client.get("/public")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 548, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_middleware.py[0m:74: in test_public_route_access
    [0mresponse = test_client.get([33m"[39;49;00m[33m/public[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:548: in get
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().get([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1054: in get
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:42] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/public', '/redoc', '/docs', '/']
[31m[1m________________________ test_protected_route_no_token _________________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_middleware.py", line 79, in test_protected_route_no_token
    |     response = test_client.get("/protected")
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 548, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_middleware.py[0m:79: in test_protected_route_no_token
    [0mresponse = test_client.get([33m"[39;49;00m[33m/protected[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:548: in get
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().get([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1054: in get
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:42] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/public', '/redoc', '/docs', '/']
[31m[1m____________________ test_protected_route_with_valid_token _____________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_middleware.py", line 84, in test_protected_route_with_valid_token
    |     response = test_client.get("/protected", headers={"Authorization": "Bearer patient123"})
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 548, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_middleware.py[0m:84: in test_protected_route_with_valid_token
    [0mresponse = test_client.get([33m"[39;49;00m[33m/protected[39;49;00m[33m"[39;49;00m, headers={[33m"[39;49;00m[33mAuthorization[39;49;00m[33m"[39;49;00m: [33m"[39;49;00m[33mBearer patient123[39;49;00m[33m"[39;49;00m})[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:548: in get
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().get([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1054: in get
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:42] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/public', '/redoc', '/docs', '/']
[31m[1m___________________ test_protected_route_with_invalid_token ____________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_middleware.py", line 89, in test_protected_route_with_invalid_token
    |     response = test_client.get("/protected", headers={"Authorization": "Bearer invalid"})
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 548, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_middleware.py[0m:89: in test_protected_route_with_invalid_token
    [0mresponse = test_client.get([33m"[39;49;00m[33m/protected[39;49;00m[33m"[39;49;00m, headers={[33m"[39;49;00m[33mAuthorization[39;49;00m[33m"[39;49;00m: [33m"[39;49;00m[33mBearer invalid[39;49;00m[33m"[39;49;00m})[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:548: in get
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().get([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1054: in get
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:42] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/public', '/redoc', '/docs', '/']
[31m[1m___________________ test_protected_route_with_expired_token ____________________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/security/auth/test_auth_middleware.py", line 94, in test_protected_route_with_expired_token
    |     response = test_client.get("/protected", headers={"Authorization": "Bearer expired"})
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 548, in get
    |     return super().get(
    |            ^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1054, in get
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/auth/test_auth_middleware.py[0m:94: in test_protected_route_with_expired_token
    [0mresponse = test_client.get([33m"[39;49;00m[33m/protected[39;49;00m[33m"[39;49;00m, headers={[33m"[39;49;00m[33mAuthorization[39;49;00m[33m"[39;49;00m: [33m"[39;49;00m[33mBearer expired[39;49;00m[33m"[39;49;00m})[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:548: in get
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().get([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1054: in get
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:42] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/public', '/redoc', '/docs', '/']
[31m[1m_______________ TestDBPHIProtection.test_data_encryption_at_rest _______________[0m
[1m[31mapp/tests/security/db/test_db_phi_protection.py[0m:386: in test_data_encryption_at_rest
    [0m[94massert[39;49;00m created_patient.ssn != [33m"[39;49;00m[33m123-45-6789[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'coroutine' object has no attribute 'ssn'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
[31m[1m______________ TestDBPHIProtection.test_role_based_access_control ______________[0m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:499: in _get_by_id_operation
    [0muuid_obj = UUID(patient_id)[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/uuid.py[0m:178: in __init__
    [0m[94mraise[39;49;00m [96mValueError[39;49;00m([33m'[39;49;00m[33mbadly formed hexadecimal UUID string[39;49;00m[33m'[39;49;00m)[90m[39;49;00m
[1m[31mE   ValueError: badly formed hexadecimal UUID string[0m

[33mThe above exception was the direct cause of the following exception:[0m
[1m[31mapp/tests/security/db/test_db_phi_protection.py[0m:421: in test_role_based_access_control
    [0m[94massert[39;49;00m ([94mawait[39;49;00m admin_repo.get_by_id([33m"[39;49;00m[33mP12345[39;49;00m[33m"[39;49;00m)) [95mis[39;49;00m [95mnot[39;49;00m [94mNone[39;49;00m[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:516: in get_by_id
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m._with_session(_get_by_id_operation)[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:431: in _with_session
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m operation([96mself[39;49;00m.db_session)[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:502: in _get_by_id_operation
    [0m[94mraise[39;49;00m PersistenceError([33mf[39;49;00m[33m"[39;49;00m[33mInvalid patient ID format: [39;49;00m[33m{[39;49;00mpatient_id[33m}[39;49;00m[33m"[39;49;00m) [94mfrom[39;49;00m[90m [39;49;00m[04m[96mve[39;49;00m[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.PersistenceError: Invalid patient ID format: P12345[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:42] [ERROR] [app.infrastructure.persistence.sqlalchemy.repositories.patient_repository] - Invalid UUID format for patient ID 'P12345': badly formed hexadecimal UUID string
[2025-05-02 21:52:42] [ERROR] [app.infrastructure.persistence.sqlalchemy.repositories.patient_repository] - Invalid UUID format for patient ID 'P12345': badly formed hexadecimal UUID string
[31m[1m_______________ TestDBPHIProtection.test_patient_data_isolation ________________[0m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:499: in _get_by_id_operation
    [0muuid_obj = UUID(patient_id)[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/uuid.py[0m:178: in __init__
    [0m[94mraise[39;49;00m [96mValueError[39;49;00m([33m'[39;49;00m[33mbadly formed hexadecimal UUID string[39;49;00m[33m'[39;49;00m)[90m[39;49;00m
[1m[31mE   ValueError: badly formed hexadecimal UUID string[0m

[33mThe above exception was the direct cause of the following exception:[0m
[1m[31mapp/tests/security/db/test_db_phi_protection.py[0m:467: in test_patient_data_isolation
    [0m[94massert[39;49;00m ([94mawait[39;49;00m patient1_repo.get_by_id([33m"[39;49;00m[33mP12345[39;49;00m[33m"[39;49;00m)) [95mis[39;49;00m [95mnot[39;49;00m [94mNone[39;49;00m[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:516: in get_by_id
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m._with_session(_get_by_id_operation)[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:431: in _with_session
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m operation([96mself[39;49;00m.db_session)[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:502: in _get_by_id_operation
    [0m[94mraise[39;49;00m PersistenceError([33mf[39;49;00m[33m"[39;49;00m[33mInvalid patient ID format: [39;49;00m[33m{[39;49;00mpatient_id[33m}[39;49;00m[33m"[39;49;00m) [94mfrom[39;49;00m[90m [39;49;00m[04m[96mve[39;49;00m[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.PersistenceError: Invalid patient ID format: P12345[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:42] [ERROR] [app.infrastructure.persistence.sqlalchemy.repositories.patient_repository] - Invalid UUID format for patient ID 'P12345': badly formed hexadecimal UUID string
[2025-05-02 21:52:42] [ERROR] [app.infrastructure.persistence.sqlalchemy.repositories.patient_repository] - Invalid UUID format for patient ID 'P12345': badly formed hexadecimal UUID string
[31m[1m____________________ TestDBPHIProtection.test_audit_logging ____________________[0m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:499: in _get_by_id_operation
    [0muuid_obj = UUID(patient_id)[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/uuid.py[0m:178: in __init__
    [0m[94mraise[39;49;00m [96mValueError[39;49;00m([33m'[39;49;00m[33mbadly formed hexadecimal UUID string[39;49;00m[33m'[39;49;00m)[90m[39;49;00m
[1m[31mE   ValueError: badly formed hexadecimal UUID string[0m

[33mThe above exception was the direct cause of the following exception:[0m
[1m[31mapp/tests/security/db/test_db_phi_protection.py[0m:483: in test_audit_logging
    [0m[94mawait[39;49;00m repo.get_by_id([33m"[39;49;00m[33mP12345[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:516: in get_by_id
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m._with_session(_get_by_id_operation)[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:431: in _with_session
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m operation([96mself[39;49;00m.db_session)[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:502: in _get_by_id_operation
    [0m[94mraise[39;49;00m PersistenceError([33mf[39;49;00m[33m"[39;49;00m[33mInvalid patient ID format: [39;49;00m[33m{[39;49;00mpatient_id[33m}[39;49;00m[33m"[39;49;00m) [94mfrom[39;49;00m[90m [39;49;00m[04m[96mve[39;49;00m[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.PersistenceError: Invalid patient ID format: P12345[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:42] [ERROR] [app.infrastructure.persistence.sqlalchemy.repositories.patient_repository] - Invalid UUID format for patient ID 'P12345': badly formed hexadecimal UUID string
[2025-05-02 21:52:42] [ERROR] [app.infrastructure.persistence.sqlalchemy.repositories.patient_repository] - Invalid UUID format for patient ID 'P12345': badly formed hexadecimal UUID string
[31m[1m________________ TestDBPHIProtection.test_phi_filtering_by_role ________________[0m
[1m[31mapp/tests/security/db/test_db_phi_protection.py[0m:517: in test_phi_filtering_by_role
    [0mrepo = PatientRepository(session=session)[90m[39;49;00m
[1m[31mapp/infrastructure/persistence/sqlalchemy/repositories/patient_repository.py[0m:123: in __init__
    [0m[94mraise[39;49;00m [96mValueError[39;49;00m([33m"[39;49;00m[33mEither db_session or db_session_factory must be provided[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   ValueError: Either db_session or db_session_factory must be provided[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
[31m[1m____________ TestDBPHIProtection.test_transaction_rollback_on_error ____________[0m
[1m[31mapp/tests/security/db/test_db_phi_protection.py[0m:586: in test_transaction_rollback_on_error
    [0muow = UnitOfWork(db)[90m[39;49;00m
[1m[31mE   TypeError: UnitOfWork() takes no arguments[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
[31m[1m_______________ TestDBPHIProtection.test_phi_in_query_parameters _______________[0m
[1m[31mapp/tests/security/db/test_db_phi_protection.py[0m:621: in test_phi_in_query_parameters
    [0mmock_session.execute.side_effect = execute_query[90m[39;49;00m
[1m[31mE   AttributeError: 'method' object has no attribute 'side_effect'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:42] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
[31m[1m____________ TestEncryptionService.test_encryption_is_deterministic ____________[0m
[1m[31mapp/tests/security/encryption/test_ml_encryption.py[0m:123: in test_encryption_is_deterministic
    [0m[94massert[39;49;00m encrypted1 == encrypted2[90m[39;49;00m
[1m[31mE   AssertionError: assert 'v1:gAAAAABoF...mmiW8eU3iuuY=' == 'v1:gAAAAABoF...2YTKC44ngpqs='[0m
[1m[31mE     [0m
[1m[31mE     - v1:gAAAAABoFXbqc2I2GhDvRzhox0o09GBQ2Yut-09Ukz71LVTJRgO5Ej2-Aw9LEGiArbduhFMThpNRUomPp5efBmUTLyC6A1WtxVx-xXayOC02YTKC44ngpqs=[0m
[1m[31mE     + v1:gAAAAABoFXbqONWdpT0kce2w6V0EcoiVKbfEc9h0KBswCfXS-__8uKzVZ76F35K-RzJhlRC7dyW6589cPtvRHry_BbcsFCL3u1N_58bwH6VmmiW8eU3iuuY=[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:42] [WARNING] [app.infrastructure.security.encryption.base_encryption_service] - Raw key material is more than 32 bytes, truncating.
[31m[1m_______________ TestEncryptionService.test_handle_invalid_input ________________[0m
[1m[31mapp/tests/security/encryption/test_ml_encryption.py[0m:161: in test_handle_invalid_input
    [0m[94mwith[39;49;00m pytest.raises([96mException[39;49;00m):[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'Exception'>[0m
[31m[1m_______________ TestFieldEncryption.test_encrypt_decrypt_fields ________________[0m
[1m[31mapp/tests/security/encryption/test_ml_encryption.py[0m:253: in test_encrypt_decrypt_fields
    [0m[94massert[39;49;00m decrypted_record[[33m"[39;49;00m[33mdemographics[39;49;00m[33m"[39;49;00m][[33m"[39;49;00m[33maddress[39;49;00m[33m"[39;49;00m][[33m"[39;49;00m[33mstreet[39;49;00m[33m"[39;49;00m] == patient_record[[33m"[39;49;00m[33mdemographics[39;49;00m[33m"[39;49;00m][[33m"[39;49;00m[33maddress[39;49;00m[33m"[39;49;00m][[33m"[39;49;00m[33mstreet[39;49;00m[33m"[39;49;00m][90m[39;49;00m
[1m[31mE   TypeError: string indices must be integers, not 'str'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:43] [WARNING] [app.infrastructure.security.encryption.base_encryption_service] - Raw key material is more than 32 bytes, truncating.
[2025-05-02 21:52:43] [WARNING] [app.infrastructure.security.encryption.base_encryption_service] - Encrypting non-string/bytes type: <class 'dict'>
[2025-05-02 21:52:43] [WARNING] [app.infrastructure.security.encryption.base_encryption_service] - Encrypting non-string/bytes type: <class 'list'>
[2025-05-02 21:52:43] [WARNING] [app.infrastructure.security.encryption.base_encryption_service] - Encrypting non-string/bytes type: <class 'list'>
[2025-05-02 21:52:43] [WARNING] [app.infrastructure.security.encryption.base_encryption_service] - Encrypting non-string/bytes type: <class 'dict'>
[31m[1m_______________ TestJWTService.test_decode_token_invalid_format ________________[0m
[1m[31mapp/tests/security/jwt/test_jwt_service.py[0m:137: in test_decode_token_invalid_format
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mNot enough segments[39;49;00m[33m"[39;49;00m [95min[39;49;00m [96mstr[39;49;00m(exc_info.value)[90m[39;49;00m
[1m[31mE   assert 'Not enough segments' in "Invalid token: Invalid header string: 'utf-8' codec can't decode byte 0x9e in position 0: invalid start byte"[0m
[1m[31mE    +  where "Invalid token: Invalid header string: 'utf-8' codec can't decode byte 0x9e in position 0: invalid start byte" = str(InvalidTokenException("Invalid token: Invalid header string: 'utf-8' codec can't decode byte 0x9e in position 0: invalid start byte"))[0m
[1m[31mE    +    where InvalidTokenException("Invalid token: Invalid header string: 'utf-8' codec can't decode byte 0x9e in position 0: invalid start byte") = <ExceptionInfo InvalidTokenException("Invalid token: Invalid header string: 'utf-8' codec can't decode byte 0x9e in position 0: invalid start byte") tblen=2>.value[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:43] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:43] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Invalid header string: 'utf-8' codec can't decode byte 0x9e in position 0: invalid start byte
[31m[1m______________ TestPatientPHISecurity.test_secure_error_handling _______________[0m
[1m[31mapp/tests/security/phi/test_patient_phi_security.py[0m:116: in test_secure_error_handling
    [0m[94massert[39;49;00m patient.email [95mnot[39;49;00m [95min[39;49;00m log_message, [33m"[39;49;00m[33mEmail should not be in error logs[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError: Email should not be in error logs[0m
[1m[31mE   assert 'alexandra.j...@example.com' not in 'Error occur...@example.com'[0m
[1m[31mE     [0m
[1m[31mE     'alexandra.johnson@example.com' is contained here:[0m
[1m[31mE       with email alexandra.johnson@example.com[0m
[31m[1m_________________ TestPHIAuditLogic.test_audit_file_detection __________________[0m
[1m[31mapp/tests/security/phi/test_phi_audit_logic.py[0m:149: in test_audit_file_detection
    [0m[94massert[39;49;00m auditor.is_phi_test_file(phi_test_file, [96mopen[39;49;00m(phi_test_file).read()) [95mis[39;49;00m [94mTrue[39;49;00m, [33m"[39;49;00m[33mPHI test file should be detected correctly[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError: PHI test file should be detected correctly[0m
[1m[31mE   assert False is True[0m
[1m[31mE    +  where False = <bound method PHIAuditor.is_phi_test_file of <scripts.test.security.run_hipaa_phi_audit.PHIAuditor object at 0x16f8a3a40>>('/var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpmjm8t709/test_phi_detection.py', '\n                    import pytest\n                    from app.core.utils.validation import PHIDetector\n\n       ...etector = PHIDetector()\n                        assert detector.contains_phi("123-45-6789") is True\n                ')[0m
[1m[31mE    +    where <bound method PHIAuditor.is_phi_test_file of <scripts.test.security.run_hipaa_phi_audit.PHIAuditor object at 0x16f8a3a40>> = <scripts.test.security.run_hipaa_phi_audit.PHIAuditor object at 0x16f8a3a40>.is_phi_test_file[0m
[1m[31mE    +    and   '\n                    import pytest\n                    from app.core.utils.validation import PHIDetector\n\n       ...etector = PHIDetector()\n                        assert detector.contains_phi("123-45-6789") is True\n                ' = <built-in method read of _io.TextIOWrapper object at 0x16f76f060>()[0m
[1m[31mE    +      where <built-in method read of _io.TextIOWrapper object at 0x16f76f060> = <_io.TextIOWrapper name='/var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpmjm8t709/test_phi_detection.py' mode='r' encoding='UTF-8'>.read[0m
[1m[31mE    +        where <_io.TextIOWrapper name='/var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpmjm8t709/test_phi_detection.py' mode='r' encoding='UTF-8'> = open('/var/folders/3p/t86zsht91l3gsdpddkqg_kfh0000gn/T/tmpmjm8t709/test_phi_detection.py')[0m
[31m[1m_________ TestPHIAuditLogic.test_strict_mode_disables_special_handling _________[0m
[1m[31mapp/tests/security/phi/test_phi_audit_logic.py[0m:182: in test_strict_mode_disables_special_handling
    [0m[94massert[39;49;00m strict_auditor._audit_passed() [95mis[39;49;00m [94mFalse[39;49;00m, [33m"[39;49;00m[33mAudit should fail in strict mode even in clean_app directory[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError: Audit should fail in strict mode even in clean_app directory[0m
[1m[31mE   assert True is False[0m
[1m[31mE    +  where True = <bound method PHIAuditor._audit_passed of <scripts.test.security.run_hipaa_phi_audit.PHIAuditor object at 0x168e8ea20>>()[0m
[1m[31mE    +    where <bound method PHIAuditor._audit_passed of <scripts.test.security.run_hipaa_phi_audit.PHIAuditor object at 0x168e8ea20>> = <scripts.test.security.run_hipaa_phi_audit.PHIAuditor object at 0x168e8ea20>._audit_passed[0m
[31m[1m________________ TestPHIInSourceFiles.test_python_file_with_phi ________________[0m
[1m[31mapp/tests/security/phi/test_phi_code_patterns.py[0m:70: in test_python_file_with_phi
    [0mresult = phi_analyzer.scan_file(temp_file)[90m[39;49;00m
[1m[31mE   AttributeError: 'PHICodeAnalyzer' object has no attribute 'scan_file'[0m
[31m[1m__________________ TestPHIInSourceFiles.test_js_file_with_phi __________________[0m
[1m[31mapp/tests/security/phi/test_phi_code_patterns.py[0m:116: in test_js_file_with_phi
    [0mresult = phi_analyzer.scan_file(temp_file)[90m[39;49;00m
[1m[31mE   AttributeError: 'PHICodeAnalyzer' object has no attribute 'scan_file'[0m
[31m[1m________________ TestPHIInSourceFiles.test_config_file_with_phi ________________[0m
[1m[31mapp/tests/security/phi/test_phi_code_patterns.py[0m:152: in test_config_file_with_phi
    [0mresult = phi_analyzer.scan_file(temp_file)[90m[39;49;00m
[1m[31mE   AttributeError: 'PHICodeAnalyzer' object has no attribute 'scan_file'[0m
[31m[1m_____________________ TestPHIInSourceFiles.test_clean_file _____________________[0m
[1m[31mapp/tests/security/phi/test_phi_code_patterns.py[0m:203: in test_clean_file
    [0mresult = phi_analyzer.scan_file(temp_file)[90m[39;49;00m
[1m[31mE   AttributeError: 'PHICodeAnalyzer' object has no attribute 'scan_file'[0m
[31m[1m___________________ TestPHIInSourceFiles.test_directory_scan ___________________[0m
[1m[31mapp/tests/security/phi/test_phi_code_patterns.py[0m:250: in test_directory_scan
    [0mresult = phi_analyzer.scan_directory(temp_dir)[90m[39;49;00m
[1m[31mE   AttributeError: 'PHICodeAnalyzer' object has no attribute 'scan_directory'[0m
[31m[1m___________________ TestPHIInSourceFiles.test_excluded_files ___________________[0m
[1m[31mapp/tests/security/phi/test_phi_code_patterns.py[0m:285: in test_excluded_files
    [0mresult = phi_analyzer.scan_directory(temp_dir)[90m[39;49;00m
[1m[31mE   AttributeError: 'PHICodeAnalyzer' object has no attribute 'scan_directory'[0m
[31m[1m_________________ TestPHIInSourceFiles.test_audit_code_for_phi _________________[0m
[1m[31mapp/tests/security/phi/test_phi_code_patterns.py[0m:306: in test_audit_code_for_phi
    [0mresult = phi_analyzer.audit_code_for_phi(temp_dir)[90m[39;49;00m
[1m[31mE   AttributeError: 'PHICodeAnalyzer' object has no attribute 'audit_code_for_phi'[0m
[31m[1m________________ TestPHIInSourceFiles.test_audit_api_endpoints _________________[0m
[1m[31mapp/tests/security/phi/test_phi_code_patterns.py[0m:340: in test_audit_api_endpoints
    [0mresult = phi_analyzer.audit_api_endpoints(temp_dir)[90m[39;49;00m
[1m[31mE   AttributeError: 'PHICodeAnalyzer' object has no attribute 'audit_api_endpoints'[0m
[31m[1m________________ TestPHIInSourceFiles.test_audit_configuration _________________[0m
[1m[31mapp/tests/security/phi/test_phi_code_patterns.py[0m:379: in test_audit_configuration
    [0mresult = phi_analyzer.audit_configuration(temp_dir)[90m[39;49;00m
[1m[31mE   AttributeError: 'PHICodeAnalyzer' object has no attribute 'audit_configuration'[0m
[31m[1m_________________ TestPHIDetection.test_ssn_pattern_detection __________________[0m
[1m[31mapp/tests/security/phi/test_phi_detection.py[0m:58: in test_ssn_pattern_detection
    [0mdetected_phi = [96mself[39;49;00m.phi_service.detect_phi(content)[90m[39;49;00m
[1m[31mE   AttributeError: 'PHIService' object has no attribute 'detect_phi'[0m
[31m[1m_____________ TestPHIDetection.test_audit_with_clean_app_directory _____________[0m
[1m[31mapp/tests/security/phi/test_phi_detection.py[0m:77: in test_audit_with_clean_app_directory
    [0mauditor.audit_code_for_phi()[90m[39;49;00m
[1m[31mE   AttributeError: 'types.SimpleNamespace' object has no attribute 'audit_code_for_phi'[0m
[31m[1m___________________ TestPHIDetection.test_phi_in_normal_code ___________________[0m
[1m[31mapp/tests/security/phi/test_phi_detection.py[0m:94: in test_phi_in_normal_code
    [0mauditor.audit_code_for_phi()[90m[39;49;00m
[1m[31mE   AttributeError: 'types.SimpleNamespace' object has no attribute 'audit_code_for_phi'[0m
[31m[1m___________________ TestPHIDetection.test_phi_in_test_files ____________________[0m
[1m[31mapp/tests/security/phi/test_phi_detection.py[0m:124: in test_phi_in_test_files
    [0mauditor.audit_code_for_phi()[90m[39;49;00m
[1m[31mE   AttributeError: 'types.SimpleNamespace' object has no attribute 'audit_code_for_phi'[0m
[31m[1m_________________ TestPHIDetection.test_api_endpoint_security __________________[0m
[1m[31mapp/tests/security/phi/test_phi_detection.py[0m:167: in test_api_endpoint_security
    [0mauditor.audit_api_endpoints()[90m[39;49;00m
[1m[31mE   AttributeError: 'types.SimpleNamespace' object has no attribute 'audit_api_endpoints'[0m
[31m[1m_____________ TestPHIDetection.test_config_security_classification _____________[0m
[1m[31mapp/tests/security/phi/test_phi_detection.py[0m:197: in test_config_security_classification
    [0mauditor.audit_configuration()[90m[39;49;00m
[1m[31mE   AttributeError: 'types.SimpleNamespace' object has no attribute 'audit_configuration'[0m
[31m[1m__________________ TestPHIMiddleware.test_whitelist_patterns ___________________[0m
[1m[31mapp/tests/security/phi/test_phi_middleware.py[0m:164: in test_whitelist_patterns
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mJohn Smith[39;49;00m[33m"[39;49;00m [95min[39;49;00m json.dumps(data)[90m[39;49;00m
[1m[31mE   assert 'John Smith' in '{"patient": {"name": "[REDACTED NAME]", "ssn": "[REDACTED SSN]", "contact": {"email": "[REDACTED EMAIL]", "phone": "[REDACTED PHONE]"}}, "meta": {"timestamp": "2023-01-01T12:00:00Z"}}'[0m
[1m[31mE    +  where '{"patient": {"name": "[REDACTED NAME]", "ssn": "[REDACTED SSN]", "contact": {"email": "[REDACTED EMAIL]", "phone": "[REDACTED PHONE]"}}, "meta": {"timestamp": "2023-01-01T12:00:00Z"}}' = <function dumps at 0x10322c540>({'meta': {'timestamp': '2023-01-01T12:00:00Z'}, 'patient': {'contact': {'email': '[REDACTED EMAIL]', 'phone': '[REDACTED PHONE]'}, 'name': '[REDACTED NAME]', 'ssn': '[REDACTED SSN]'}})[0m
[1m[31mE    +    where <function dumps at 0x10322c540> = json.dumps[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:46] [INFO] [app.infrastructure.security.phi.middleware] - PHI middleware added to FastAPI application (audit_mode=False)
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:46] [WARNING] [app.infrastructure.security.phi.middleware] - PHI detected in API response for GET /data-with-phi
[2025-05-02 21:52:46] [INFO] [app.infrastructure.security.phi.middleware] - PHI sanitized in response to GET /data-with-phi
[2025-05-02 21:52:46] [INFO] [httpx] - HTTP Request: GET http://testserver/data-with-phi "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/data-with-phi "HTTP/1.1 200 OK"
[31m[1m__________________ TestPHIMiddleware.test_add_phi_middleware ___________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:928: in assert_called_once
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'mock' to have been called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/security/phi/test_phi_middleware.py[0m:225: in test_add_phi_middleware
    [0mapp.add_middleware.assert_called_once()[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'mock' to have been called once. Called 0 times.[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:46] [INFO] [app.infrastructure.security.phi.middleware] - PHI middleware added to FastAPI application (audit_mode=False)
[31m[1m__________________ TestAlertRule.test_init_invalid_condition ___________________[0m
[1m[31mapp/tests/standalone/core/test_biometric_event_processor.py[0m:142: in test_init_invalid_condition
    [0m[94mwith[39;49;00m pytest.raises(ValidationError):[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'app.domain.exceptions.ValidationError'>[0m
[31m[1m______________ TestBiometricEventProcessor.test_register_observer ______________[0m
[1m[31mapp/tests/standalone/core/test_biometric_event_processor.py[0m:207: in test_register_observer
    [0m[94massert[39;49;00m observer [95min[39;49;00m processor.observers[90m[39;49;00m
[1m[31mE   AssertionError[0m
[31m[1m_________ TestBiometricEventProcessor.test_process_data_point_no_alert _________[0m
[1m[31mapp/tests/standalone/core/test_biometric_event_processor.py[0m:222: in test_process_data_point_no_alert
    [0m[94massert[39;49;00m [96mlen[39;49;00m(processor.alerts) == [94m0[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'BiometricEventProcessor' object has no attribute 'alerts'[0m
[31m[1m________ TestBiometricEventProcessor.test_process_data_point_with_alert ________[0m
[1m[31mapp/tests/standalone/core/test_biometric_event_processor.py[0m:238: in test_process_data_point_with_alert
    [0m[94massert[39;49;00m [96mlen[39;49;00m(processor.alerts) == [94m1[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'BiometricEventProcessor' object has no attribute 'alerts'[0m
[31m[1m___________________ TestAlertObservers.test_in_app_observer ____________________[0m
[1m[31mapp/tests/standalone/core/test_biometric_event_processor.py[0m:260: in test_in_app_observer
    [0mobserver = InAppAlertObserver()[90m[39;49;00m
[1m[31mE   TypeError: InAppAlertObserver.__init__() missing 1 required positional argument: 'notification_service'[0m
[31m[1m____________________ TestAlertObservers.test_email_observer ____________________[0m
[1m[31mapp/tests/standalone/core/test_biometric_event_processor.py[0m:281: in test_email_observer
    [0mobserver = EmailAlertObserver()[90m[39;49;00m
[1m[31mE   TypeError: EmailAlertObserver.__init__() missing 1 required positional argument: 'email_service'[0m
[31m[1m_____________________ TestAlertObservers.test_sms_observer _____________________[0m
[1m[31mapp/tests/standalone/core/test_biometric_event_processor.py[0m:306: in test_sms_observer
    [0mobserver = SMSAlertObserver()[90m[39;49;00m
[1m[31mE   TypeError: SMSAlertObserver.__init__() missing 1 required positional argument: 'sms_service'[0m
[31m[1m___________________ TestMockMentaLLaMA.test_process_general ____________________[0m
[1m[31mapp/tests/standalone/core/test_mock_mentallama.py[0m:89: in test_process_general
    [0mresult = [94mawait[39;49;00m [96mself[39;49;00m.service.process(text=[96mself[39;49;00m.sample_text, model_type=[33m"[39;49;00m[33mgeneral[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mapp/infrastructure/ml/mentallama/mock_service.py[0m:116: in process
    [0m[94mreturn[39;49;00m result_obj.dict() [90m# Assuming MentaLLaMAResult has a dict() method[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'MentaLLaMAResult' object has no attribute 'dict'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:46] [INFO] [app.infrastructure.ml.mentallama.mock_service] - MockMentaLLaMA initialized with model: test-mock-model
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:46] [INFO] [app.infrastructure.ml.mentallama.mock_service] - MockMentaLLaMA shutdown.
[31m[1m_______________ TestMockMentaLLaMA.test_process_risk_assessment ________________[0m
[1m[31mapp/tests/standalone/core/test_mock_mentallama.py[0m:98: in test_process_risk_assessment
    [0mresult = [94mawait[39;49;00m [96mself[39;49;00m.service.process(text=[96mself[39;49;00m.sample_text, model_type=[33m"[39;49;00m[33mrisk_assessment[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mapp/infrastructure/ml/mentallama/mock_service.py[0m:116: in process
    [0m[94mreturn[39;49;00m result_obj.dict() [90m# Assuming MentaLLaMAResult has a dict() method[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'MentaLLaMAResult' object has no attribute 'dict'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:46] [INFO] [app.infrastructure.ml.mentallama.mock_service] - MockMentaLLaMA initialized with model: test-mock-model
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:46] [INFO] [app.infrastructure.ml.mentallama.mock_service] - MockMentaLLaMA shutdown.
[31m[1m______________ TestMockMentaLLaMA.test_detect_depression_positive ______________[0m
[1m[31mapp/tests/standalone/core/test_mock_mentallama.py[0m:122: in test_detect_depression_positive
    [0mresult = [94mawait[39;49;00m [96mself[39;49;00m.service.detect_depression(text=[96mself[39;49;00m.sample_text)[90m[39;49;00m
[1m[31mE   TypeError: object dict can't be used in 'await' expression[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:46] [INFO] [app.infrastructure.ml.mentallama.mock_service] - MockMentaLLaMA initialized with model: test-mock-model
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:46] [INFO] [app.infrastructure.ml.mentallama.mock_service] - Mock detecting depression for text snippet: 'I've been feeling down for several weeks. I'm cons...'
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:46] [INFO] [app.infrastructure.ml.mentallama.mock_service] - MockMentaLLaMA shutdown.
[31m[1m______________ TestMockMentaLLaMA.test_detect_depression_negative ______________[0m
[1m[31mapp/tests/standalone/core/test_mock_mentallama.py[0m:131: in test_detect_depression_negative
    [0mresult = [94mawait[39;49;00m [96mself[39;49;00m.service.detect_depression(text=[33m"[39;49;00m[33mFeeling great today![39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   TypeError: object dict can't be used in 'await' expression[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:46] [INFO] [app.infrastructure.ml.mentallama.mock_service] - MockMentaLLaMA initialized with model: test-mock-model
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:46] [INFO] [app.infrastructure.ml.mentallama.mock_service] - Mock detecting depression for text snippet: 'Feeling great today!...'
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:46] [INFO] [app.infrastructure.ml.mentallama.mock_service] - MockMentaLLaMA shutdown.
[31m[1m_____________ TestMockPATAnalysis.test_analyze_actigraphy_success ______________[0m
[1m[31mapp/tests/standalone/core/test_pat_mock.py[0m:164: in test_analyze_actigraphy_success
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mreading_count[39;49;00m[33m"[39;49;00m [95min[39;49;00m result[[33m"[39;49;00m[33mmetadata[39;49;00m[33m"[39;49;00m][90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Mock PAT service initialized with config: {'mock_delay_ms': 0}
[31m[1m______ TestMockPATAnalysis.test_analyze_actigraphy_invalid_analysis_types ______[0m
[1m[31mapp/tests/standalone/core/test_pat_mock.py[0m:370: in test_analyze_actigraphy_invalid_analysis_types
    [0m[94mwith[39;49;00m pytest.raises(ValidationError):[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'app.core.services.ml.pat.exceptions.ValidationError'>[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Mock PAT service initialized with config: {'mock_delay_ms': 0}
[31m[1m_______ TestMockPATProfileManagement.test_create_patient_profile_success _______[0m
[1m[31mapp/tests/standalone/core/test_pat_mock.py[0m:405: in test_create_patient_profile_success
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mdata[39;49;00m[33m"[39;49;00m [95min[39;49;00m result[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Mock PAT service initialized with config: {'mock_delay_ms': 0}
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Created profile prof_4d35ae96-6489-46cf-87a5-21bbc7b6c862 for patient patient-123
[31m[1m________ TestMockPATProfileManagement.test_get_patient_profile_success _________[0m
[1m[31mapp/tests/standalone/core/test_pat_mock.py[0m:464: in test_get_patient_profile_success
    [0m[94massert[39;49;00m retrieved_profile[[33m"[39;49;00m[33mdata[39;49;00m[33m"[39;49;00m] == profile_data[90m[39;49;00m
[1m[31mE   KeyError: 'data'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Mock PAT service initialized with config: {'mock_delay_ms': 0}
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Created profile prof_dd5c4513-05d6-47d3-a396-1636e8c3db5d for patient patient-123
[31m[1m_____ TestMockPATProfileManagement.test_get_patient_profile_wrong_patient ______[0m
[1m[31mapp/tests/standalone/core/test_pat_mock.py[0m:496: in test_get_patient_profile_wrong_patient
    [0minitialized_mock_pat.get_patient_profile([90m[39;49;00m
[1m[31mapp/tests/standalone/mock_pat_service.py[0m:320: in get_patient_profile
    [0m[94mraise[39;49;00m ResourceNotFoundError([33mf[39;49;00m[33m"[39;49;00m[33mProfile for patient [39;49;00m[33m{[39;49;00mpatient_id[33m}[39;49;00m[33m not found.[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.services.ml.pat.exceptions.ResourceNotFoundError: Profile for patient patient-456 not found.[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Mock PAT service initialized with config: {'mock_delay_ms': 0}
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Created profile prof_2f8a05ab-1975-4a20-b8b8-8244c6d6c4b5 for patient patient-123
[31m[1m_______ TestMockPATProfileManagement.test_update_patient_profile_success _______[0m
[1m[31mapp/tests/standalone/core/test_pat_mock.py[0m:527: in test_update_patient_profile_success
    [0m[94massert[39;49;00m updated_profile[[33m"[39;49;00m[33mdata[39;49;00m[33m"[39;49;00m][[33m"[39;49;00m[33mage[39;49;00m[33m"[39;49;00m] == [94m36[39;49;00m[90m[39;49;00m
[1m[31mE   KeyError: 'data'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Mock PAT service initialized with config: {'mock_delay_ms': 0}
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Created profile prof_667e114a-d74c-4afa-b293-da633195e3dd for patient patient-123
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Updated profile prof_667e114a-d74c-4afa-b293-da633195e3dd for patient patient-123
[31m[1m____ TestMockPATProfileManagement.test_update_patient_profile_wrong_patient ____[0m
[1m[31mapp/tests/standalone/core/test_pat_mock.py[0m:563: in test_update_patient_profile_wrong_patient
    [0minitialized_mock_pat.update_patient_profile([90m[39;49;00m
[1m[31mapp/tests/standalone/mock_pat_service.py[0m:348: in update_patient_profile
    [0m[94mraise[39;49;00m ResourceNotFoundError([33mf[39;49;00m[33m"[39;49;00m[33mProfile for patient [39;49;00m[33m{[39;49;00mpatient_id[33m}[39;49;00m[33m not found for update.[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.services.ml.pat.exceptions.ResourceNotFoundError: Profile for patient patient-456 not found for update.[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Mock PAT service initialized with config: {'mock_delay_ms': 0}
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Created profile prof_a67445de-af01-4495-8299-a982464702a1 for patient patient-123
[31m[1m_______ TestMockPATIntegration.test_integrate_with_digital_twin_success ________[0m
[1m[31mapp/tests/standalone/core/test_pat_mock.py[0m:631: in test_integrate_with_digital_twin_success
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mdigital_twin_updates[39;49;00m[33m"[39;49;00m [95min[39;49;00m result[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Mock PAT service initialized with config: {'mock_delay_ms': 0}
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Created profile prof_4699c392-9c13-4071-90d9-55119f50e7db for patient patient-123
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Integrated analysis 3fc237fa-a926-42ce-a6f7-c2780a5175fa for patient patient-123 with twin mock_twin_patient-123
[31m[1m__ TestMockPATIntegration.test_integrate_with_digital_twin_profile_not_found ___[0m
[1m[31mapp/tests/standalone/core/test_pat_mock.py[0m:690: in test_integrate_with_digital_twin_profile_not_found
    [0minitialized_mock_pat.integrate_with_digital_twin([90m[39;49;00m
[1m[31mapp/tests/standalone/mock_pat_service.py[0m:392: in integrate_with_digital_twin
    [0m[94mraise[39;49;00m AuthorizationError([90m[39;49;00m
[1m[31mE   app.core.services.ml.pat.exceptions.AuthorizationError: Analysis fb7e9112-f9e4-4cac-918a-7e26cde9c077 does not belong to patient non-existent-profile.[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:47] [INFO] [app.tests.standalone.mock_pat_service] - Mock PAT service initialized with config: {'mock_delay_ms': 0}
[31m[1m______________ TestAlertRule.test_evaluate_greater_than_or_equal _______________[0m
[1m[31mapp/tests/standalone/core/test_standalone_biometric_processor.py[0m:1151: in test_evaluate_greater_than_or_equal
    [0m[96mself[39;49;00m.assertTrue(rule.evaluate(at_threshold))[90m[39;49;00m
[1m[31mE   AssertionError: False is not true[0m
[31m[1m________________ TestAlertRule.test_evaluate_less_than_or_equal ________________[0m
[1m[31mapp/tests/standalone/core/test_standalone_biometric_processor.py[0m:1220: in test_evaluate_less_than_or_equal
    [0m[96mself[39;49;00m.assertTrue(rule.evaluate(below_threshold))[90m[39;49;00m
[1m[31mE   AssertionError: False is not true[0m
[31m[1m________ TestNeurotransmitterTwinModel.test_simulate_medication_effect _________[0m
[1m[31mapp/tests/standalone/core/test_standalone_digital_twin.py[0m:1492: in test_simulate_medication_effect
    [0m[96mself[39;49;00m.assertAlmostEqual([90m[39;49;00m
[1m[31mE   AssertionError: 1.51 != 1.3 within 5 places (0.20999999999999996 difference)[0m
[31m[1m__________________ TestStandaloneMockPAT.test_initialization ___________________[0m
[1m[31mapp/tests/standalone/core/test_standalone_pat_mock.py[0m:70: in test_initialization
    [0mmock_pat._check_initialized()[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:195: in _check_initialized
    [0m[94mraise[39;49;00m InitializationError([33m"[39;49;00m[33mMock PAT service not initialized[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.InitializationError: Mock PAT service not initialized[0m
[31m[1m______________ TestStandaloneMockPAT.test_device_info_validation _______________[0m
[1m[31mapp/tests/standalone/core/test_standalone_pat_mock.py[0m:85: in test_device_info_validation
    [0mmock_pat._validate_device_info({})[90m[39;49;00m
[1m[31mE   AttributeError: 'MockPATService' object has no attribute '_validate_device_info'[0m
[31m[1m_____________ TestStandaloneMockPAT.test_analysis_types_validation _____________[0m
[1m[31mapp/tests/standalone/core/test_standalone_pat_mock.py[0m:101: in test_analysis_types_validation
    [0m[94mwith[39;49;00m pytest.raises(ValidationError):[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'app.core.services.ml.pat.exceptions.ValidationError'>[0m
[31m[1m________________ TestStandaloneMockPAT.test_analyze_actigraphy _________________[0m
[1m[31mapp/tests/standalone/core/test_standalone_pat_mock.py[0m:114: in test_analyze_actigraphy
    [0mresult = initialized_mock_pat.analyze_actigraphy([90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:816: in analyze_actigraphy
    [0m[96mself[39;49;00m._validate_actigraphy_inputs(patient_id, readings, sampling_rate_hz, device_info, analysis_types)[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:932: in _validate_actigraphy_inputs
    [0m[94mraise[39;49;00m ValidationError([33mf[39;49;00m[33m"[39;49;00m[33mDevice info must contain required keys: [39;49;00m[33m{[39;49;00mrequired_device_keys[33m}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ValidationError: Device info must contain required keys: ['manufacturer', 'model'][0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:47] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:47] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
[31m[1m________________ TestStandaloneMockPAT.test_get_analysis_by_id _________________[0m
[1m[31mapp/tests/standalone/core/test_standalone_pat_mock.py[0m:139: in test_get_analysis_by_id
    [0manalysis = initialized_mock_pat.analyze_actigraphy([90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:816: in analyze_actigraphy
    [0m[96mself[39;49;00m._validate_actigraphy_inputs(patient_id, readings, sampling_rate_hz, device_info, analysis_types)[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:932: in _validate_actigraphy_inputs
    [0m[94mraise[39;49;00m ValidationError([33mf[39;49;00m[33m"[39;49;00m[33mDevice info must contain required keys: [39;49;00m[33m{[39;49;00mrequired_device_keys[33m}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ValidationError: Device info must contain required keys: ['manufacturer', 'model'][0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:47] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:47] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
[31m[1m_____________ TestStandaloneMockPAT.test_get_nonexistent_analysis ______________[0m
[1m[31mapp/tests/standalone/core/test_standalone_pat_mock.py[0m:164: in test_get_nonexistent_analysis
    [0minitialized_mock_pat.get_analysis([33m"[39;49;00m[33mnon-existent-id[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'MockPATService' object has no attribute 'get_analysis'. Did you mean: '_analyses'?[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:47] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:47] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
[31m[1m____________________ TestPHIPattern.test_redact_partial_ssn ____________________[0m
[1m[31mapp/tests/standalone/core/test_standalone_phi_sanitizer.py[0m:288: in test_redact_partial_ssn
    [0m[94massert[39;49;00m pattern.redact([33m"[39;49;00m[33mMy SSN is 123-45-6789[39;49;00m[33m"[39;49;00m) == [33m"[39;49;00m[33mXXX-XX-6789[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
[31m[1m___________________ TestPHIPattern.test_redact_partial_phone ___________________[0m
[1m[31mapp/tests/standalone/core/test_standalone_phi_sanitizer.py[0m:297: in test_redact_partial_phone
    [0m[94massert[39;49;00m pattern.redact([33m"[39;49;00m[33mMy phone is (555) 123-4567[39;49;00m[33m"[39;49;00m) == [33m"[39;49;00m[33m(XXX) XXX-4567[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
[31m[1m____________________ TestPHISanitizer.test_sanitize_address ____________________[0m
[1m[31mapp/tests/standalone/core/test_standalone_phi_sanitizer.py[0m:369: in test_sanitize_address
    [0m[94massert[39;49;00m [33m"[39;49;00m[33m123 Main St[39;49;00m[33m"[39;49;00m [95mnot[39;49;00m [95min[39;49;00m sanitized [95mor[39;49;00m [33m"[39;49;00m[33mAnytown[39;49;00m[33m"[39;49;00m [95mnot[39;49;00m [95min[39;49;00m sanitized[90m[39;49;00m
[1m[31mE   AssertionError[0m
[31m[1m_____________________ TestSanitizedLogger.test_log_methods _____________________[0m
[1m[31mapp/tests/standalone/core/test_standalone_phi_sanitizer.py[0m:440: in test_log_methods
    [0m[94massert[39;49;00m [33m"[39;49;00m[33m[[39;49;00m[33m"[39;49;00m [95min[39;49;00m record.message  [90m# Some form of redaction marker[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [test_logger] - Info with SSN: XXX-XX-6789
[2025-05-02 21:52:47] [WARNING] [test_logger] - Warning with SSN: XXX-XX-6789
[2025-05-02 21:52:47] [ERROR] [test_logger] - Error with SSN: XXX-XX-6789
[2025-05-02 21:52:47] [CRITICAL] [test_logger] - Critical with SSN: XXX-XX-6789
------------------------------ Captured log call -------------------------------
[35mDEBUG   [0m test_logger:test_standalone_phi_sanitizer.py:185 Debug with SSN: XXX-XX-6789
[32mINFO    [0m test_logger:test_standalone_phi_sanitizer.py:192 Info with SSN: XXX-XX-6789
[33mWARNING [0m test_logger:test_standalone_phi_sanitizer.py:199 Warning with SSN: XXX-XX-6789
[1m[31mERROR   [0m test_logger:test_standalone_phi_sanitizer.py:206 Error with SSN: XXX-XX-6789
[31mCRITICAL[0m test_logger:test_standalone_phi_sanitizer.py:213 Critical with SSN: XXX-XX-6789
[31m[1m__________________ TestSanitizedLogger.test_exception_method ___________________[0m
[1m[31mapp/tests/standalone/core/test_standalone_phi_sanitizer.py[0m:456: in test_exception_method
    [0m[94massert[39;49;00m [33m"[39;49;00m[33m[[39;49;00m[33m"[39;49;00m [95min[39;49;00m record.message  [90m# Some form of redaction marker[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [ERROR] [test_logger] - Exception with SSN: XXX-XX-6789
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/standalone/core/test_standalone_phi_sanitizer.py", line 449, in test_exception_method
    raise ValueError("Error with SSN: 123-45-6789")
ValueError: Error with SSN: 123-45-6789
------------------------------ Captured log call -------------------------------
[1m[31mERROR   [0m test_logger:test_standalone_phi_sanitizer.py:220 Exception with SSN: XXX-XX-6789
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/standalone/core/test_standalone_phi_sanitizer.py", line 449, in test_exception_method
    raise ValueError("Error with SSN: 123-45-6789")
ValueError: Error with SSN: 123-45-6789
[31m[1m______________________________ test_sanitize_name ______________________________[0m
[1m[31mapp/tests/standalone/core/test_utils.py[0m:78: in test_sanitize_name
    [0m[94massert[39;49;00m sanitize_name([33m"[39;49;00m[33mJohn Doe[39;49;00m[33m"[39;49;00m) == [33m"[39;49;00m[33mjohn_doe[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
[31m[1m______________________________ test_truncate_text ______________________________[0m
[1m[31mapp/tests/standalone/core/test_utils.py[0m:104: in test_truncate_text
    [0m[94massert[39;49;00m truncate_text(long_text, max_length=[94m20[39;49;00m) == [33m"[39;49;00m[33mThis is a very lon...[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
[31m[1m_______________ TestMentalLLaMAExceptions.test_connection_error ________________[0m
[1m[31mapp/tests/standalone/domain/test_exceptions.py[0m:63: in test_connection_error
    [0m[94massert[39;49;00m [96mstr[39;49;00m(exception) == message[90m[39;49;00m
[1m[31mE   AssertionError[0m
[31m[1m_______ TestMentalLLaMAExceptions.test_connection_error_without_details ________[0m
[1m[31mapp/tests/standalone/domain/test_exceptions.py[0m:77: in test_connection_error_without_details
    [0m[94massert[39;49;00m [96mstr[39;49;00m(exception) == message[90m[39;49;00m
[1m[31mE   AssertionError[0m
[31m[1m________________ TestMentalLLaMAExceptions.test_inference_error ________________[0m
[1m[31mapp/tests/standalone/domain/test_exceptions.py[0m:116: in test_inference_error
    [0mexception = MentalLLaMAInferenceError(message, model_name, inference_parameters, details)[90m[39;49;00m
[1m[31mE   TypeError: MentalLLaMAInferenceError.__init__() takes from 2 to 4 positional arguments but 5 were given[0m
[31m[1m______ TestMentalLLaMAExceptions.test_inference_error_without_parameters _______[0m
[1m[31mapp/tests/standalone/domain/test_exceptions.py[0m:141: in test_inference_error_without_parameters
    [0m[94massert[39;49;00m exception.model_name == model_name[90m[39;49;00m
[1m[31mE   AttributeError: 'MentalLLaMAInferenceError' object has no attribute 'model_name'[0m
[31m[1m_______________ TestMentalLLaMAExceptions.test_validation_error ________________[0m
[1m[31mapp/tests/standalone/domain/test_exceptions.py[0m:163: in test_validation_error
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mvalidation_errors[39;49;00m[33m"[39;49;00m [95min[39;49;00m exception.details[90m[39;49;00m
[1m[31mE   AssertionError[0m
[31m[1m_______ TestMentalLLaMAExceptions.test_validation_error_without_details ________[0m
[1m[31mapp/tests/standalone/domain/test_exceptions.py[0m:181: in test_validation_error_without_details
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mvalidation_errors[39;49;00m[33m"[39;49;00m [95min[39;49;00m exception.details[90m[39;49;00m
[1m[31mE   AssertionError[0m
[31m[1m__________ TestMentalLLaMAExceptions.test_exception_context_isolation __________[0m
[1m[31mapp/tests/standalone/domain/test_exceptions.py[0m:259: in test_exception_context_isolation
    [0m[94massert[39;49;00m [94mFalse[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
[31m[1m____________________ TestPatient.test_patient_id_validation ____________________[0m
[1m[31mapp/tests/standalone/domain/test_patient.py[0m:110: in test_patient_id_validation
    [0m[94mwith[39;49;00m pytest.raises(ValidationException):[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'app.tests.mocks.patient_mock.ValidationException'>[0m
[31m[1m___________________ TestPatient.test_patient_name_validation ___________________[0m
[1m[31mapp/tests/standalone/domain/test_patient.py[0m:136: in test_patient_name_validation
    [0m[94mwith[39;49;00m pytest.raises(ValidationException):[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'app.tests.mocks.patient_mock.ValidationException'>[0m
[31m[1m______________ TestPatient.test_patient_date_of_birth_validation _______________[0m
[1m[31mapp/tests/standalone/domain/test_patient.py[0m:145: in test_patient_date_of_birth_validation
    [0m[94mwith[39;49;00m pytest.raises(ValidationException):[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'app.tests.mocks.patient_mock.ValidationException'>[0m
[31m[1m_______________________ TestPatient.test_add_medication ________________________[0m
[1m[31mapp/tests/standalone/domain/test_patient.py[0m:351: in test_add_medication
    [0mvalid_patient.add_medication(med_name)[90m[39;49;00m
[1m[31mapp/tests/mocks/patient_mock.py[0m:196: in add_medication
    [0m[94mraise[39;49;00m ValidationException([33m"[39;49;00m[33mMedication must have a name[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.tests.mocks.patient_mock.ValidationException: Medication must have a name[0m
[31m[1m______________________ TestPatient.test_remove_medication ______________________[0m
[1m[31mapp/tests/standalone/domain/test_patient.py[0m:360: in test_remove_medication
    [0mvalid_patient.add_medication(med_to_remove)[90m[39;49;00m
[1m[31mapp/tests/mocks/patient_mock.py[0m:196: in add_medication
    [0m[94mraise[39;49;00m ValidationException([33m"[39;49;00m[33mMedication must have a name[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.tests.mocks.patient_mock.ValidationException: Medication must have a name[0m
[31m[1m_____________ TestPatientModel.test_patient_creation_invalid_name ______________[0m
[1m[31mapp/tests/standalone/domain/test_patient_model.py[0m:48: in test_patient_creation_invalid_name
    [0m[94mwith[39;49;00m pytest.raises([96mValueError[39;49;00m) [94mas[39;49;00m exc_info:[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'ValueError'>[0m
[31m[1m_____________________ TestAppointment.test_validate_times ______________________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:114: in test_validate_times
    [0m[94mwith[39;49;00m pytest.raises(InvalidAppointmentTimeError):[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'app.domain.exceptions.InvalidAppointmentTimeError'>[0m
[31m[1m________________ TestAppointment.test_validate_required_fields _________________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:141: in test_validate_required_fields
    [0mAppointment([90m[39;49;00m
[1m[31mE   TypeError: Appointment.__init__() missing 1 required positional argument: 'patient_id'[0m
[31m[1m___________________ TestAppointment.test_confirm_appointment ___________________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:189: in test_confirm_appointment
    [0mvalid_appointment.confirm()[90m[39;49;00m
[1m[31mE   AttributeError: 'Appointment' object has no attribute 'confirm'[0m
[31m[1m__________ TestAppointment.test_cannot_confirm_completed_appointment ___________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:196: in test_cannot_confirm_completed_appointment
    [0mvalid_appointment.complete()[90m[39;49;00m
[1m[31mE   AttributeError: 'Appointment' object has no attribute 'complete'[0m
[31m[1m___________________ TestAppointment.test_cancel_appointment ____________________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:208: in test_cancel_appointment
    [0mvalid_appointment.cancel(cancelled_by=cancelled_by_user, reason=reason)[90m[39;49;00m
[1m[31mE   AttributeError: 'Appointment' object has no attribute 'cancel'[0m
[31m[1m___________ TestAppointment.test_cannot_cancel_completed_appointment ___________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:220: in test_cannot_cancel_completed_appointment
    [0mvalid_appointment.complete() [90m# Now this should work[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'Appointment' object has no attribute 'complete'[0m
[31m[1m_________________ TestAppointment.test_reschedule_appointment __________________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:237: in test_reschedule_appointment
    [0m[94massert[39;49;00m valid_appointment.status == AppointmentStatus.RESCHEDULED[90m[39;49;00m
[1m[31mE   AssertionError[0m
[31m[1m__________________ TestAppointment.test_complete_appointment ___________________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:246: in test_complete_appointment
    [0mvalid_appointment.complete()[90m[39;49;00m
[1m[31mE   AttributeError: 'Appointment' object has no attribute 'complete'[0m
[31m[1m__________ TestAppointment.test_cannot_complete_cancelled_appointment __________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:254: in test_cannot_complete_cancelled_appointment
    [0mvalid_appointment.cancel(cancelled_by=cancelled_by_user, reason=[33m"[39;49;00m[33mPatient request[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'Appointment' object has no attribute 'cancel'[0m
[31m[1m___________________ TestAppointment.test_no_show_appointment ___________________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:264: in test_no_show_appointment
    [0mvalid_appointment.mark_no_show()[90m[39;49;00m
[1m[31mE   AttributeError: 'Appointment' object has no attribute 'mark_no_show'[0m
[31m[1m__________ TestAppointment.test_cannot_no_show_cancelled_appointment ___________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:271: in test_cannot_no_show_cancelled_appointment
    [0mvalid_appointment.cancel(cancelled_by=cancelled_by_user, reason=[33m"[39;49;00m[33mPatient request[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'Appointment' object has no attribute 'cancel'[0m
[31m[1m______________________ TestAppointment.test_update_notes _______________________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:283: in test_update_notes
    [0mvalid_appointment.update_notes(new_notes)[90m[39;49;00m
[1m[31mE   AttributeError: 'Appointment' object has no attribute 'update_notes'. Did you mean: 'update_status'?[0m
[31m[1m_____________________ TestAppointment.test_update_location _____________________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:294: in test_update_location
    [0mvalid_appointment.update_location(new_location)[90m[39;49;00m
[1m[31mE   AttributeError: 'Appointment' object has no attribute 'update_location'[0m
[31m[1m_________________________ TestAppointment.test_to_dict _________________________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:302: in test_to_dict
    [0mappointment_dict = valid_appointment.to_dict()[90m[39;49;00m
[1m[31mE   AttributeError: 'Appointment' object has no attribute 'to_dict'[0m
[31m[1m________________________ TestAppointment.test_from_dict ________________________[0m
[1m[31mapp/tests/standalone/infrastructure/test_appointment.py[0m:325: in test_from_dict
    [0mappointment_dict = valid_appointment.to_dict()[90m[39;49;00m
[1m[31mE   AttributeError: 'Appointment' object has no attribute 'to_dict'[0m
[31m[1m_____________ TestActigraphyRoutes.test_analyze_actigraphy_success _____________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:421: in test_analyze_actigraphy_success
    [0m[94massert[39;49;00m response.status_code == status.HTTP_201_CREATED[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/analyze "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/analyze "HTTP/1.1 401 Unauthorized"
[31m[1m__________ TestActigraphyRoutes.test_analyze_actigraphy_unauthorized ___________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:445: in test_analyze_actigraphy_unauthorized
    [0m[94massert[39;49;00m response.status_code == status.HTTP_403_FORBIDDEN[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/analyze "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/analyze "HTTP/1.1 401 Unauthorized"
[31m[1m________ TestActigraphyRoutes.test_analyze_actigraphy_validation_error _________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:467: in test_analyze_actigraphy_validation_error
    [0m[94massert[39;49;00m response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/analyze "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/analyze "HTTP/1.1 401 Unauthorized"
[31m[1m_________ TestActigraphyRoutes.test_analyze_actigraphy_analysis_error __________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:489: in test_analyze_actigraphy_analysis_error
    [0m[94massert[39;49;00m response.status_code == status.HTTP_500_INTERNAL_SERVER_ERROR[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/analyze "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/analyze "HTTP/1.1 401 Unauthorized"
[31m[1m_________ TestActigraphyRoutes.test_get_actigraphy_embeddings_success __________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:509: in test_get_actigraphy_embeddings_success
    [0m[94massert[39;49;00m response.status_code == status.HTTP_201_CREATED[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/embeddings "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/embeddings "HTTP/1.1 401 Unauthorized"
[31m[1m_______ TestActigraphyRoutes.test_get_actigraphy_embeddings_unauthorized _______[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:531: in test_get_actigraphy_embeddings_unauthorized
    [0m[94massert[39;49;00m response.status_code == status.HTTP_403_FORBIDDEN[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/embeddings "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/embeddings "HTTP/1.1 401 Unauthorized"
[31m[1m_____ TestActigraphyRoutes.test_get_actigraphy_embeddings_validation_error _____[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:553: in test_get_actigraphy_embeddings_validation_error
    [0m[94massert[39;49;00m response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/embeddings "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/embeddings "HTTP/1.1 401 Unauthorized"
[31m[1m_____ TestActigraphyRoutes.test_get_actigraphy_embeddings_embedding_error ______[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:575: in test_get_actigraphy_embeddings_embedding_error
    [0m[94massert[39;49;00m response.status_code == status.HTTP_500_INTERNAL_SERVER_ERROR[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/embeddings "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/embeddings "HTTP/1.1 401 Unauthorized"
[31m[1m_____________ TestActigraphyRoutes.test_get_analysis_by_id_success _____________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:594: in test_get_analysis_by_id_success
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: GET http://testserver/api/v1/actigraphy/analyses/analysis123 "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/api/v1/actigraphy/analyses/analysis123 "HTTP/1.1 401 Unauthorized"
[31m[1m____________ TestActigraphyRoutes.test_get_analysis_by_id_not_found ____________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:615: in test_get_analysis_by_id_not_found
    [0m[94massert[39;49;00m response.status_code == status.HTTP_404_NOT_FOUND[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: GET http://testserver/api/v1/actigraphy/analyses/nonexistent-analysis "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/api/v1/actigraphy/analyses/nonexistent-analysis "HTTP/1.1 401 Unauthorized"
[31m[1m__________ TestActigraphyRoutes.test_get_analysis_by_id_unauthorized ___________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:637: in test_get_analysis_by_id_unauthorized
    [0m[94massert[39;49;00m response.status_code == status.HTTP_403_FORBIDDEN[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: GET http://testserver/api/v1/actigraphy/analyses/analysis123 "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/api/v1/actigraphy/analyses/analysis123 "HTTP/1.1 401 Unauthorized"
[31m[1m____________ TestActigraphyRoutes.test_get_patient_analyses_success ____________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:655: in test_get_patient_analyses_success
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: GET http://testserver/api/v1/actigraphy/patient/00000000-0000-4000-A000-000000000001/analyses "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/api/v1/actigraphy/patient/00000000-0000-4000-A000-000000000001/analyses "HTTP/1.1 401 Unauthorized"
[31m[1m_________ TestActigraphyRoutes.test_get_patient_analyses_unauthorized __________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:677: in test_get_patient_analyses_unauthorized
    [0m[94massert[39;49;00m response.status_code == status.HTTP_403_FORBIDDEN[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: GET http://testserver/api/v1/actigraphy/patient/different_patient/analyses "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/api/v1/actigraphy/patient/different_patient/analyses "HTTP/1.1 401 Unauthorized"
[31m[1m_______________ TestActigraphyRoutes.test_get_model_info_success _______________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:697: in test_get_model_info_success
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [REDACTED NAME]: Creating NEW Database instance using settings from get_settings(). URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] ENTERING. ENVIRONMENT=development
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Settings URI: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] Override URI: None
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] [REDACTED NAME] URL for create_async_engine: sqlite+aiosqlite:///:memory:
[2025-05-02 21:52:47] [INFO] [app.infrastructure.persistence.sqlalchemy.config.database] - [DB._create_engine] Using NullPool for SQLite.
------> [DEBUG] Inner _get_repo_instance_deferred_lookup executing for repo_type: IUserRepository
[2025-05-02 21:52:47] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[2025-05-02 21:52:47] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Not enough segments
[2025-05-02 21:52:47] [ERROR] [app.infrastructure.security.jwt.jwt_service] - Unexpected error retrieving user from token: Invalid token: Not enough segments
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments
[2025-05-02 21:52:47] [INFO] [app.presentation.api.dependencies.auth] - Authentication failed: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [ERROR] [app.presentation.api.dependencies.database] - Exception during DB session yield: 401: Failed to retrieve user information from token.
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 176, in _load
    signing_input, crypto_segment = jwt.rsplit(b".", 1)
    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
ValueError: not enough values to unpack (expected 2, got 1)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 142, in decode
    payload = jws.verify(token, key, algorithms, verify=verify_signature)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 70, in verify
    header, payload, signing_input, signature = _load(token)
                                                ^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jws.py", line 180, in _load
    raise JWSError("Not enough segments")
jose.exceptions.JWSError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 223, in decode_token
    payload_dict = jwt.decode(
                   ^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py", line 144, in decode
    raise JWTError(e)
jose.exceptions.JWTError: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 276, in get_user_from_token
    payload: TokenPayload = await self.decode_token(token) # Re-uses the validation logic
                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 249, in decode_token
    raise InvalidTokenException(f"Invalid token: {e}")
app.domain.exceptions.token_exceptions.InvalidTokenException: Invalid token: Not enough segments

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 116, in get_current_user
    user = await jwt_service.get_user_from_token(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/jwt/jwt_service.py", line 309, in get_user_from_token
    raise AuthenticationError("Failed to retrieve user information from token.")
app.domain.exceptions.AuthenticationError: Failed to retrieve user information from token.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/database.py", line 81, in get_db
    yield session
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/routing.py", line 269, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py", line 600, in solve_dependencies
    solved = await call(**sub_values)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/dependencies/auth.py", line 137, in get_current_user
    raise HTTPException(
fastapi.exceptions.HTTPException: 401: Failed to retrieve user information from token.
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: GET http://testserver/api/v1/actigraphy/model-info "HTTP/1.1 401 Unauthorized"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/api/v1/actigraphy/model-info "HTTP/1.1 401 Unauthorized"
[31m[1m________ TestActigraphyRoutes.test_integrate_with_digital_twin_success _________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:721: in test_integrate_with_digital_twin_success
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/integrate "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/integrate "HTTP/1.1 404 [REDACTED NAME]"
[31m[1m_____________ TestActigraphyRoutes.test_get_analysis_types_success _____________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:739: in test_get_analysis_types_success
    [0m[94massert[39;49;00m response.json() == expected[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.core.services.ml.pat.factory] - Creating PAT service of type: mock
[2025-05-02 21:52:47] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:47] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: GET http://testserver/api/v1/actigraphy/analysis_types "HTTP/1.1 200 OK"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/api/v1/actigraphy/analysis_types "HTTP/1.1 200 OK"
[31m[1m______ TestActigraphyRoutes.test_integrate_with_digital_twin_unauthorized ______[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:759: in test_integrate_with_digital_twin_unauthorized
    [0m[94massert[39;49;00m response.status_code == status.HTTP_403_FORBIDDEN[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/integrate "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/integrate "HTTP/1.1 404 [REDACTED NAME]"
[31m[1m_______ TestActigraphyRoutes.test_integrate_with_digital_twin_not_found ________[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:782: in test_integrate_with_digital_twin_not_found
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mAnalysis not found[39;49;00m[33m"[39;49;00m [95min[39;49;00m response.json()[[33m"[39;49;00m[33mdetail[39;49;00m[33m"[39;49;00m][90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/integrate "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/integrate "HTTP/1.1 404 [REDACTED NAME]"
[31m[1m__ TestActigraphyRoutes.test_integrate_with_digital_twin_authorization_error ___[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:803: in test_integrate_with_digital_twin_authorization_error
    [0m[94massert[39;49;00m response.status_code == status.HTTP_403_FORBIDDEN[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/integrate "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/integrate "HTTP/1.1 404 [REDACTED NAME]"
[31m[1m____ TestActigraphyRoutes.test_integrate_with_digital_twin_validation_error ____[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:825: in test_integrate_with_digital_twin_validation_error
    [0m[94massert[39;49;00m response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/integrate "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/integrate "HTTP/1.1 404 [REDACTED NAME]"
[31m[1m___ TestActigraphyRoutes.test_integrate_with_digital_twin_integration_error ____[0m
[1m[31mapp/tests/unit/api/routes/test_actigraphy_routes.py[0m:847: in test_integrate_with_digital_twin_integration_error
    [0m[94massert[39;49;00m response.status_code == status.HTTP_500_INTERNAL_SERVER_ERROR[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
Warning: Auth dependencies not found for override.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [httpx] - HTTP Request: POST http://testserver/api/v1/actigraphy/integrate "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: POST http://testserver/api/v1/actigraphy/integrate "HTTP/1.1 404 [REDACTED NAME]"
[31m[1m________ TestBatchProcessAnalyticsUseCase.test_execute_with_empty_batch ________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:940: in assert_called_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(error_message)[90m[39;49;00m
[1m[31mE   AssertionError: expected call not found.[0m
[1m[31mE   Expected: warning('Received empty batch of analytics events')[0m
[1m[31mE     Actual: not called.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py[0m:123: in test_execute_with_empty_batch
    [0muse_case._logger.warning.assert_called_with([90m[39;49;00m
[1m[31mE   AssertionError: expected call not found.[0m
[1m[31mE   Expected: warning('Received empty batch of analytics events')[0m
[1m[31mE     Actual: not called.[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [WARNING] [app.application.use_cases.analytics.batch_process_analytics] - Received empty batch of analytics events
[2025-05-02 21:52:47] [WARNING] [app.application.use_cases.analytics.batch_process_analytics] - Received empty batch of analytics events
[31m[1m_______ TestBatchProcessAnalyticsUseCase.test_execute_with_valid_events ________[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py[0m:158: in test_execute_with_valid_events
    [0m[94massert[39;49;00m mock_event_processor.execute.call_count == [94m2[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'call_count'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Starting batch processing of 2 analytics events
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Starting batch processing of 2 analytics events
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Completed batch processing: 2 succeeded, 0 failed
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Completed batch processing: 2 succeeded, 0 failed
[31m[1m________ TestBatchProcessAnalyticsUseCase.test_partial_failure_handling ________[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py[0m:202: in test_partial_failure_handling
    [0m[94massert[39;49;00m use_case._logger.error.call_count == [94m2[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError: assert 0 == 2[0m
[1m[31mE    +  where 0 = <MagicMock name='get_logger().error' id='13058178224'>.call_count[0m
[1m[31mE    +    where <MagicMock name='get_logger().error' id='13058178224'> = <MagicMock name='get_logger()' id='13058174336'>.error[0m
[1m[31mE    +      where <MagicMock name='get_logger()' id='13058174336'> = <app.application.use_cases.analytics.batch_process_analytics.BatchProcessAnalyticsUseCase object at 0x30a53fc50>._logger[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Starting batch processing of 3 analytics events
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Starting batch processing of 3 analytics events
[2025-05-02 21:52:47] [ERROR] [app.application.use_cases.analytics.batch_process_analytics] - Error processing analytics event: Simulated error in event processing
[2025-05-02 21:52:47] [ERROR] [app.application.use_cases.analytics.batch_process_analytics] - Error processing analytics event: Simulated error in event processing
[2025-05-02 21:52:47] [ERROR] [app.application.use_cases.analytics.batch_process_analytics] - Error processing analytics event: Simulated error in event processing
[2025-05-02 21:52:47] [ERROR] [app.application.use_cases.analytics.batch_process_analytics] - Error processing analytics event: Simulated error in event processing
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Completed batch processing: 1 succeeded, 2 failed
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Completed batch processing: 1 succeeded, 2 failed
[31m[1m________ TestBatchProcessAnalyticsUseCase.test_event_timestamp_handling ________[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py[0m:237: in test_event_timestamp_handling
    [0mcall_args_list = mock_event_processor.execute.call_args_list[90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'call_args_list'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Starting batch processing of 3 analytics events
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Starting batch processing of 3 analytics events
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Completed batch processing: 3 succeeded, 0 failed
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Completed batch processing: 3 succeeded, 0 failed
[31m[1m__________ TestBatchProcessAnalyticsUseCase.test_batch_metadata_saved __________[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py[0m:278: in test_batch_metadata_saved
    [0mmock_cache_service.increment.assert_any_call([33m"[39;49;00m[33manalytics:batches:processed[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'assert_any_call'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Starting batch processing of 3 analytics events
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Starting batch processing of 3 analytics events
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Completed batch processing: 3 succeeded, 0 failed
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Completed batch processing: 3 succeeded, 0 failed
[31m[1m__________ TestBatchProcessAnalyticsUseCase.test_large_batch_chunking __________[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py[0m:314: in test_large_batch_chunking
    [0m[94massert[39;49;00m mock_event_processor.execute.call_count == [94m250[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'call_count'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Starting batch processing of 250 analytics events
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Starting batch processing of 250 analytics events
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Completed batch processing: 250 succeeded, 0 failed
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.batch_process_analytics] - Completed batch processing: 250 succeeded, 0 failed
[31m[1m______ TestProcessAnalyticsEventUseCase.test_execute_with_all_parameters _______[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_process_analytics_event.py[0m:100: in test_execute_with_all_parameters
    [0mmock_analytics_repository.save_event.assert_called_once()[90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'assert_called_once'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.process_analytics_event] - Processing analytics event of type: page_view
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.process_analytics_event] - Processing analytics event of type: page_view
[31m[1m____ TestProcessAnalyticsEventUseCase.test_execute_with_minimal_parameters _____[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:940: in assert_called_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(error_message)[90m[39;49;00m
[1m[31mE   AssertionError: expected call not found.[0m
[1m[31mE   Expected: info('Processing analytics event of type: feature_usage', extra={'session_id': None})[0m
[1m[31mE     Actual: not called.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_process_analytics_event.py[0m:134: in test_execute_with_minimal_parameters
    [0muse_case._logger.info.assert_called_with([90m[39;49;00m
[1m[31mE   AssertionError: expected call not found.[0m
[1m[31mE   Expected: info('Processing analytics event of type: feature_usage', extra={'session_id': None})[0m
[1m[31mE     Actual: not called.[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.process_analytics_event] - Processing analytics event of type: feature_usage
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.process_analytics_event] - Processing analytics event of type: feature_usage
[31m[1m_______ TestProcessAnalyticsEventUseCase.test_real_time_counter_updates ________[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_process_analytics_event.py[0m:157: in test_real_time_counter_updates
    [0mmock_cache_service.increment.assert_any_call([33mf[39;49;00m[33m"[39;49;00m[33manalytics:counter:[39;49;00m[33m{[39;49;00mevent_type[33m}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'assert_any_call'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.process_analytics_event] - Processing analytics event of type: patient_search
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.process_analytics_event] - Processing analytics event of type: patient_search
[31m[1m_____________ TestProcessAnalyticsEventUseCase.test_phi_not_logged _____________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:940: in assert_called_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(error_message)[90m[39;49;00m
[1m[31mE   AssertionError: expected call not found.[0m
[1m[31mE   Expected: info('Processing analytics event of type: patient_record_view', extra={'session_id': 'session-xyz'})[0m
[1m[31mE     Actual: not called.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_process_analytics_event.py[0m:180: in test_phi_not_logged
    [0muse_case._logger.info.assert_called_with([90m[39;49;00m
[1m[31mE   AssertionError: expected call not found.[0m
[1m[31mE   Expected: info('Processing analytics event of type: patient_record_view', extra={'session_id': 'session-xyz'})[0m
[1m[31mE     Actual: not called.[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.process_analytics_event] - Processing analytics event of type: patient_record_view
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.process_analytics_event] - Processing analytics event of type: patient_record_view
[31m[1m_______ TestProcessAnalyticsEventUseCase.test_repository_error_handling ________[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_process_analytics_event.py[0m:204: in test_repository_error_handling
    [0m[94mwith[39;49;00m pytest.raises([96mException[39;49;00m) [94mas[39;49;00m excinfo:[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'Exception'>[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.process_analytics_event] - Processing analytics event of type: error_event
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.process_analytics_event] - Processing analytics event of type: error_event
[31m[1m__ TestRetrieveAggregatedAnalyticsUseCase.test_execute_with_basic_parameters ___[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py[0m:146: in test_execute_with_basic_parameters
    [0mmock_analytics_repository.get_aggregates.assert_called_once()[90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'assert_called_once'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[31m[1m_ TestRetrieveAggregatedAnalyticsUseCase.test_execute_with_filters_and_time_range _[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py[0m:185: in test_execute_with_filters_and_time_range
    [0mcall_args = mock_analytics_repository.get_aggregates.call_args[[94m1[39;49;00m][90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'call_args'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving avg analytics
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving avg analytics
[31m[1m____ TestRetrieveAggregatedAnalyticsUseCase.test_time_range_string_handling ____[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py[0m:206: in test_time_range_string_handling
    [0mresult = [94mawait[39;49;00m use_case.execute([90m[39;49;00m
[1m[31mapp/application/use_cases/analytics/retrieve_aggregated_analytics.py[0m:118: in execute
    [0mttl = [96mself[39;49;00m._get_cache_ttl(aggregate_type, start_time, end_time)[90m[39;49;00m
[1m[31mapp/application/use_cases/analytics/retrieve_aggregated_analytics.py[0m:313: in _get_cache_ttl
    [0m[94mif[39;49;00m end_time < now - timedelta(days=[94m1[39;49;00m):[90m[39;49;00m
[1m[31mE   TypeError: can't compare offset-naive and offset-aware datetimes[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[31m[1m___ TestRetrieveAggregatedAnalyticsUseCase.test_invalid_time_range_handling ____[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py[0m:234: in test_invalid_time_range_handling
    [0mresult = [94mawait[39;49;00m use_case.execute([90m[39;49;00m
[1m[31mapp/application/use_cases/analytics/retrieve_aggregated_analytics.py[0m:70: in execute
    [0mstart_time, end_time = [96mself[39;49;00m._resolve_time_range(time_range)[90m[39;49;00m
[1m[31mapp/application/use_cases/analytics/retrieve_aggregated_analytics.py[0m:239: in _resolve_time_range
    [0m[94mif[39;49;00m start_time > end_time:[90m[39;49;00m
[1m[31mE   TypeError: can't compare offset-naive and offset-aware datetimes[0m
[31m[1m______ TestRetrieveAggregatedAnalyticsUseCase.test_dimension_sanitization ______[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py[0m:264: in test_dimension_sanitization
    [0mcall_args = mock_analytics_repository.get_aggregates.call_args[[94m1[39;49;00m][90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'call_args'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[31m[1m_______ TestRetrieveAggregatedAnalyticsUseCase.test_filter_sanitization ________[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py[0m:291: in test_filter_sanitization
    [0mcall_args = mock_analytics_repository.get_aggregates.call_args[[94m1[39;49;00m][90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'call_args'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[2025-05-02 21:52:47] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[31m[1m_________ TestRetrieveAggregatedAnalyticsUseCase.test_caching_behavior _________[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py[0m:319: in test_caching_behavior
    [0m[94massert[39;49;00m mock_analytics_repository.get_aggregates.call_count == [94m1[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'call_count'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:48] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[2025-05-02 21:52:48] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[31m[1m_____ TestRetrieveAggregatedAnalyticsUseCase.test_empty_dimensions_default _____[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py[0m:439: in test_empty_dimensions_default
    [0mcall_args = mock_analytics_repository.get_aggregates.call_args[[94m1[39;49;00m][90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'call_args'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:48] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[2025-05-02 21:52:48] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[31m[1m___ TestRetrieveAggregatedAnalyticsUseCase.test_very_large_time_range_limit ____[0m
[1m[31mapp/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py[0m:461: in test_very_large_time_range_limit
    [0mcall_args = mock_analytics_repository.get_aggregates.call_args[[94m1[39;49;00m][90m[39;49;00m
[1m[31mE   AttributeError: 'function' object has no attribute 'call_args'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:48] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[2025-05-02 21:52:48] [INFO] [app.application.use_cases.analytics.retrieve_aggregated_analytics] - Retrieving count analytics
[31m[1m_____________ TestMLSettingsStructure.test_nested_xgboost_defaults _____________[0m
[1m[31mapp/tests/unit/core/config/test_ml_settings.py[0m:96: in test_nested_xgboost_defaults
    [0m[94massert[39;49;00m xgboost_settings.sagemaker_endpoint_name [95mis[39;49;00m [94mNone[39;49;00m [90m# Default is None[39;49;00m[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/pydantic/main.py[0m:828: in __getattr__
    [0m[94mraise[39;49;00m [96mAttributeError[39;49;00m([33mf[39;49;00m[33m'[39;49;00m[33m{[39;49;00m[96mtype[39;49;00m([96mself[39;49;00m).[91m__name__[39;49;00m[33m!r}[39;49;00m[33m object has no attribute [39;49;00m[33m{[39;49;00mitem[33m!r}[39;49;00m[33m'[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'XGBoostSettings' object has no attribute 'sagemaker_endpoint_name'[0m
[31m[1m________________________ TestEnums.test_model_type_enum ________________________[0m
[1m[31mapp/tests/unit/core/config/test_ml_settings.py[0m:111: in test_model_type_enum
    [0m[94massert[39;49;00m ModelType.LSTM.value == [33m"[39;49;00m[33mlstm[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: type object 'ModelType' has no attribute 'LSTM'[0m
[31m[1m____________ TestMockPAT.test_analyze_actigraphy_missing_patient_id ____________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_mock_pat.py[0m:146: in test_analyze_actigraphy_missing_patient_id
    [0mmock_pat.analyze_actigraphy([90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:816: in analyze_actigraphy
    [0m[96mself[39;49;00m._validate_actigraphy_inputs(patient_id, readings, sampling_rate_hz, device_info, analysis_types)[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:919: in _validate_actigraphy_inputs
    [0m[94mraise[39;49;00m ValidationError([33m"[39;49;00m[33mPatient ID is required[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ValidationError: Patient ID is required[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
[31m[1m__________ TestMockPAT.test_analyze_actigraphy_invalid_sampling_rate ___________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_mock_pat.py[0m:161: in test_analyze_actigraphy_invalid_sampling_rate
    [0mmock_pat.analyze_actigraphy([90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:816: in analyze_actigraphy
    [0m[96mself[39;49;00m._validate_actigraphy_inputs(patient_id, readings, sampling_rate_hz, device_info, analysis_types)[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:923: in _validate_actigraphy_inputs
    [0m[94mraise[39;49;00m ValidationError([33m"[39;49;00m[33mSampling rate must be positive[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ValidationError: Sampling rate must be positive[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
[31m[1m__________ TestMockPAT.test_analyze_actigraphy_insufficient_readings ___________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_mock_pat.py[0m:188: in test_analyze_actigraphy_insufficient_readings
    [0mmock_pat.analyze_actigraphy([90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:816: in analyze_actigraphy
    [0m[96mself[39;49;00m._validate_actigraphy_inputs(patient_id, readings, sampling_rate_hz, device_info, analysis_types)[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:947: in _validate_actigraphy_inputs
    [0m[94mraise[39;49;00m ValidationError([33m"[39;49;00m[33mAt least 10 readings are required[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ValidationError: At least 10 readings are required[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
[31m[1m__________ TestMockPAT.test_analyze_actigraphy_invalid_reading_format __________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_mock_pat.py[0m:215: in test_analyze_actigraphy_invalid_reading_format
    [0mmock_pat.analyze_actigraphy([90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:816: in analyze_actigraphy
    [0m[96mself[39;49;00m._validate_actigraphy_inputs(patient_id, readings, sampling_rate_hz, device_info, analysis_types)[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:953: in _validate_actigraphy_inputs
    [0m[94mraise[39;49;00m ValidationError([33m"[39;49;00m[33mReading format invalid: missing required fields[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ValidationError: Reading format invalid: missing required fields[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
[31m[1m________ TestMockPAT.test_analyze_actigraphy_unsupported_analysis_type _________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_mock_pat.py[0m:230: in test_analyze_actigraphy_unsupported_analysis_type
    [0mmock_pat.analyze_actigraphy([90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:816: in analyze_actigraphy
    [0m[96mself[39;49;00m._validate_actigraphy_inputs(patient_id, readings, sampling_rate_hz, device_info, analysis_types)[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:939: in _validate_actigraphy_inputs
    [0m[96mself[39;49;00m._validate_analysis_types(analysis_types)[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:971: in _validate_analysis_types
    [0m[94mraise[39;49;00m ValidationError([33mf[39;49;00m[33m"[39;49;00m[33mUnsupported analysis type: [39;49;00m[33m{[39;49;00manalysis_type[33m}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ValidationError: Unsupported analysis type: unsupported_type[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
[31m[1m________________ TestMockPAT.test_get_analysis_by_id_not_found _________________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_mock_pat.py[0m:297: in test_get_analysis_by_id_not_found
    [0mmock_pat.get_analysis_by_id([33m"[39;49;00m[33mnon-existent-id[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:1395: in get_analysis_by_id
    [0m[94mraise[39;49;00m ResourceNotFoundError([33m"[39;49;00m[33mAnalysis not found[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ResourceNotFoundError: Analysis not found[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
[31m[1m_______ TestMockPAT.test_integrate_with_digital_twin_analysis_not_found ________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_mock_pat.py[0m:425: in test_integrate_with_digital_twin_analysis_not_found
    [0mmock_pat.integrate_with_digital_twin([90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:1745: in integrate_with_digital_twin
    [0manalysis_data = [96mself[39;49;00m._validate_integration_params([90m[39;49;00m
[1m[31mapp/core/services/ml/pat/mock.py[0m:1932: in _validate_integration_params
    [0m[94mraise[39;49;00m ResourceNotFoundError([33m"[39;49;00m[33mAnalysis not found[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ResourceNotFoundError: Analysis not found[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - [REDACTED NAME] PAT service
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.pat.mock] - Mock PAT service initialized
[31m[1m_______________ TestPATServiceFactory.test_cache_key_generation ________________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_pat_factory.py[0m:37: in setUp
    [0m[96mself[39;49;00m.mock_bedrock_pat = [96mself[39;49;00m.bedrock_pat_patcher.start()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1624: in start
    [0mresult = [96mself[39;49;00m.[92m__enter__[39;49;00m()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1467: in __enter__
    [0moriginal, local = [96mself[39;49;00m.get_original()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1437: in get_original
    [0m[94mraise[39;49;00m [96mAttributeError[39;49;00m([90m[39;49;00m
[1m[31mE   AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/core/services/ml/pat/factory.py'> does not have the attribute 'BedrockPAT'[0m
[31m[1m___ TestPATServiceFactory.test_different_configs_create_different_instances ____[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_pat_factory.py[0m:37: in setUp
    [0m[96mself[39;49;00m.mock_bedrock_pat = [96mself[39;49;00m.bedrock_pat_patcher.start()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1624: in start
    [0mresult = [96mself[39;49;00m.[92m__enter__[39;49;00m()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1467: in __enter__
    [0moriginal, local = [96mself[39;49;00m.get_original()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1437: in get_original
    [0m[94mraise[39;49;00m [96mAttributeError[39;49;00m([90m[39;49;00m
[1m[31mE   AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/core/services/ml/pat/factory.py'> does not have the attribute 'BedrockPAT'[0m
[31m[1m__________________ TestPATServiceFactory.test_get_bedrock_pat __________________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_pat_factory.py[0m:37: in setUp
    [0m[96mself[39;49;00m.mock_bedrock_pat = [96mself[39;49;00m.bedrock_pat_patcher.start()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1624: in start
    [0mresult = [96mself[39;49;00m.[92m__enter__[39;49;00m()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1467: in __enter__
    [0moriginal, local = [96mself[39;49;00m.get_original()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1437: in get_original
    [0m[94mraise[39;49;00m [96mAttributeError[39;49;00m([90m[39;49;00m
[1m[31mE   AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/core/services/ml/pat/factory.py'> does not have the attribute 'BedrockPAT'[0m
[31m[1m_______________ TestPATServiceFactory.test_get_default_provider ________________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_pat_factory.py[0m:37: in setUp
    [0m[96mself[39;49;00m.mock_bedrock_pat = [96mself[39;49;00m.bedrock_pat_patcher.start()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1624: in start
    [0mresult = [96mself[39;49;00m.[92m__enter__[39;49;00m()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1467: in __enter__
    [0moriginal, local = [96mself[39;49;00m.get_original()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1437: in get_original
    [0m[94mraise[39;49;00m [96mAttributeError[39;49;00m([90m[39;49;00m
[1m[31mE   AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/core/services/ml/pat/factory.py'> does not have the attribute 'BedrockPAT'[0m
[31m[1m___________________ TestPATServiceFactory.test_get_mock_pat ____________________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_pat_factory.py[0m:37: in setUp
    [0m[96mself[39;49;00m.mock_bedrock_pat = [96mself[39;49;00m.bedrock_pat_patcher.start()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1624: in start
    [0mresult = [96mself[39;49;00m.[92m__enter__[39;49;00m()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1467: in __enter__
    [0moriginal, local = [96mself[39;49;00m.get_original()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1437: in get_original
    [0m[94mraise[39;49;00m [96mAttributeError[39;49;00m([90m[39;49;00m
[1m[31mE   AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/core/services/ml/pat/factory.py'> does not have the attribute 'BedrockPAT'[0m
[31m[1m_______________ TestPATServiceFactory.test_get_unknown_provider ________________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_pat_factory.py[0m:37: in setUp
    [0m[96mself[39;49;00m.mock_bedrock_pat = [96mself[39;49;00m.bedrock_pat_patcher.start()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1624: in start
    [0mresult = [96mself[39;49;00m.[92m__enter__[39;49;00m()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1467: in __enter__
    [0moriginal, local = [96mself[39;49;00m.get_original()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1437: in get_original
    [0m[94mraise[39;49;00m [96mAttributeError[39;49;00m([90m[39;49;00m
[1m[31mE   AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/core/services/ml/pat/factory.py'> does not have the attribute 'BedrockPAT'[0m
[31m[1m_________________ TestPATServiceFactory.test_instance_caching __________________[0m
[1m[31mapp/tests/unit/core/services/ml/pat/test_pat_factory.py[0m:37: in setUp
    [0m[96mself[39;49;00m.mock_bedrock_pat = [96mself[39;49;00m.bedrock_pat_patcher.start()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1624: in start
    [0mresult = [96mself[39;49;00m.[92m__enter__[39;49;00m()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1467: in __enter__
    [0moriginal, local = [96mself[39;49;00m.get_original()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1437: in get_original
    [0m[94mraise[39;49;00m [96mAttributeError[39;49;00m([90m[39;49;00m
[1m[31mE   AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/core/services/ml/pat/factory.py'> does not have the attribute 'BedrockPAT'[0m
[31m[1m_________ TestMLServiceFactory.test_create_mentalllama_service_invalid _________[0m
[1m[31mapp/tests/unit/core/services/ml/test_factory.py[0m:138: in test_create_mentalllama_service_invalid
    [0mfactory.create_mentalllama_service([33m"[39;49;00m[33minvalid[39;49;00m[33m"[39;49;00m, [94mTrue[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'MLServiceFactory' object has no attribute 'create_mentalllama_service'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.factory] - ML service factory initialized with configuration
[31m[1m______________________ TestMLServiceFactory.test_shutdown ______________________[0m
[1m[31mapp/tests/unit/core/services/ml/test_factory.py[0m:176: in test_shutdown
    [0mfactory.shutdown()[90m[39;49;00m
[1m[31mapp/core/services/ml/factory.py[0m:115: in shutdown
    [0m[94mfor[39;49;00m service [95min[39;49;00m [96mself[39;49;00m._mental_llama_instances.values():[90m[39;49;00m
[1m[31mE   AttributeError: 'MLServiceFactory' object has no attribute '_mental_llama_instances'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:48] [INFO] [app.core.services.ml.factory] - ML service factory initialized with configuration
[31m[1m____________________ TestMockMentaLLaMA.test_initialization ____________________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock.py[0m:73: in test_initialization
    [0m[94mwith[39;49;00m pytest.raises(InvalidConfigurationError):[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'app.core.exceptions.base_exceptions.InvalidConfigurationError'>[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service initialized
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service initialized
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service initialized
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service initialized
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service shut down
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service shut down
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service initialized
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service initialized
[31m[1m____________ TestMockMentaLLaMA.test_digital_twin_session_workflow _____________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock.py[0m:178: in test_digital_twin_session_workflow
    [0mtwin_result = mock_service.generate_digital_twin([90m[39;49;00m
[1m[31mE   TypeError: MockMentaLLaMA.generate_digital_twin() got an unexpected keyword argument 'text_data'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service initialized
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service initialized
[31m[1m______________ TestMockPHIDetection.test_detect_phi_valid_inputs _______________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock.py[0m:266: in test_detect_phi_valid_inputs
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mtext[39;49;00m[33m"[39;49;00m [95min[39;49;00m result[[33m"[39;49;00m[33mphi_instances[39;49;00m[33m"[39;49;00m][[94m0[39;49;00m][90m[39;49;00m
[1m[31mE   AssertionError: assert 'text' in {'confidence': 0.89, 'end': 12, 'id': 'entity-1', 'start': 0, ...}[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.phi.mock] - Mock PHI detection service initialized with level: strict
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.phi.mock] - Performing mock PHI detection
[31m[1m_____________________ TestMockPHIDetection.test_redact_phi _____________________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock.py[0m:317: in test_redact_phi
    [0m[94massert[39;49;00m [33m"[39;49;00m[33m[PHI][39;49;00m[33m"[39;49;00m [95min[39;49;00m result[[33m"[39;49;00m[33mredacted_text[39;49;00m[33m"[39;49;00m][90m[39;49;00m
[1m[31mE   AssertionError: assert '[PHI]' in '[REDACTED] Smith (SSN: [REDACTED]) was admitted on [REDACTED]. His email is [REDACTED] and phone number is (555) 123-4567. He resides at [REDACTED] [REDACTED] [REDACTED].'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.phi.mock] - Mock PHI detection service initialized with level: strict
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.phi.mock] - Performing mock PHI redaction
[2025-05-02 21:52:48] [INFO] [app.infrastructure.ml.phi.mock] - Performing mock PHI detection
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.phi.mock] - Performing mock PHI redaction
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.phi.mock] - Performing mock PHI detection
[31m[1m________________ TestMockDigitalTwinService.test_initialization ________________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_dt.py[0m:60: in test_initialization
    [0m[94massert[39;49;00m [95mnot[39;49;00m service.is_healthy()[90m[39;49;00m
[1m[31mE   assert not True[0m
[1m[31mE    +  where True = <bound method MockDigitalTwinService.is_healthy of <app.infrastructure.ml.digital_twin.mock.MockDigitalTwinService object at 0x30409c470>>()[0m
[1m[31mE    +    where <bound method MockDigitalTwinService.is_healthy of <app.infrastructure.ml.digital_twin.mock.MockDigitalTwinService object at 0x30409c470>> = <app.infrastructure.ml.digital_twin.mock.MockDigitalTwinService object at 0x30409c470>.is_healthy[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service shut down.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service shut down.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[31m[1m________________ TestMockDigitalTwinService.test_create_session ________________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_dt.py[0m:71: in test_create_session
    [0mresult = mock_service.create_session(sample_patient_id)[90m[39;49;00m
[1m[31mE   TypeError: MockDigitalTwinService.create_session() missing 1 required positional argument: 'session_type'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[31m[1m_________________ TestMockDigitalTwinService.test_get_session __________________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_dt.py[0m:93: in test_get_session
    [0mcreate_result = mock_service.create_session(sample_patient_id)[90m[39;49;00m
[1m[31mE   TypeError: MockDigitalTwinService.create_session() missing 1 required positional argument: 'session_type'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[31m[1m_________________ TestMockDigitalTwinService.test_send_message _________________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_dt.py[0m:119: in test_send_message
    [0mcreate_result = mock_service.create_session(sample_patient_id)[90m[39;49;00m
[1m[31mE   TypeError: MockDigitalTwinService.create_session() missing 1 required positional argument: 'session_type'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[31m[1m____________ TestMockDigitalTwinService.test_message_response_types ____________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_dt.py[0m:161: in test_message_response_types
    [0mcreate_result = mock_service.create_session(sample_patient_id)[90m[39;49;00m
[1m[31mE   TypeError: MockDigitalTwinService.create_session() missing 1 required positional argument: 'session_type'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[31m[1m_________________ TestMockDigitalTwinService.test_end_session __________________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_dt.py[0m:217: in test_end_session
    [0mcreate_result = mock_service.create_session(sample_patient_id)[90m[39;49;00m
[1m[31mE   TypeError: MockDigitalTwinService.create_session() missing 1 required positional argument: 'session_type'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[31m[1m_________________ TestMockDigitalTwinService.test_get_insights _________________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_dt.py[0m:244: in test_get_insights
    [0mresult = mock_service.get_insights(sample_patient_id)[90m[39;49;00m
[1m[31mapp/infrastructure/ml/digital_twin/mock.py[0m:249: in get_insights
    [0m[94mraise[39;49;00m ResourceNotFoundError([33mf[39;49;00m[33m"[39;49;00m[33mMock digital twin with ID [39;49;00m[33m{[39;49;00mtwin_id[33m}[39;49;00m[33m not found.[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.base_exceptions.ResourceNotFoundError: Mock digital twin with ID test-patient-4db31158-53ab-4ab5-9a73-b09a3a6f3c6b not found.[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[31m[1m________________ TestMockDigitalTwinService.test_mood_insights _________________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_dt.py[0m:288: in test_mood_insights
    [0mresult = mock_service.get_insights(sample_patient_id, insight_type=[33m"[39;49;00m[33mmood[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   TypeError: MockDigitalTwinService.get_insights() got an unexpected keyword argument 'insight_type'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[31m[1m______________ TestMockDigitalTwinService.test_activity_insights _______________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_dt.py[0m:301: in test_activity_insights
    [0mresult = mock_service.get_insights(sample_patient_id, insight_type=[33m"[39;49;00m[33mactivity[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   TypeError: MockDigitalTwinService.get_insights() got an unexpected keyword argument 'insight_type'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[31m[1m________________ TestMockDigitalTwinService.test_sleep_insights ________________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_dt.py[0m:314: in test_sleep_insights
    [0mresult = mock_service.get_insights(sample_patient_id, insight_type=[33m"[39;49;00m[33msleep[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   TypeError: MockDigitalTwinService.get_insights() got an unexpected keyword argument 'insight_type'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[31m[1m_____________ TestMockDigitalTwinService.test_medication_insights ______________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_dt.py[0m:328: in test_medication_insights
    [0mresult = mock_service.get_insights(sample_patient_id, insight_type=[33m"[39;49;00m[33mmedication[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   TypeError: MockDigitalTwinService.get_insights() got an unexpected keyword argument 'insight_type'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[31m[1m______________ TestMockDigitalTwinService.test_treatment_insights ______________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_dt.py[0m:342: in test_treatment_insights
    [0mresult = mock_service.get_insights(sample_patient_id, insight_type=[33m"[39;49;00m[33mtreatment[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   TypeError: MockDigitalTwinService.get_insights() got an unexpected keyword argument 'insight_type'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.digital_twin.mock] - [REDACTED NAME] Twin service initialized.
[31m[1m__________ TestMockMentaLLaMA.test_process_returns_expected_structure __________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_mentallama.py[0m:112: in test_process_returns_expected_structure
    [0mtimestamp = datetime.fromisoformat(timestamp_str)[90m[39;49;00m
[1m[31mE   ValueError: Invalid isoformat string: '2025-05-03T01:52:49.684158+00:00+00:00'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service initialized
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service initialized
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service shut down
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service shut down
[31m[1m____________ TestMockMentaLLaMA.test_digital_twin_session_workflow _____________[0m
[1m[31mapp/tests/unit/core/services/ml/test_mock_mentallama.py[0m:198: in test_digital_twin_session_workflow
    [0mtwin_result = [96mself[39;49;00m.service.generate_digital_twin([90m[39;49;00m
[1m[31mE   TypeError: MockMentaLLaMA.generate_digital_twin() got an unexpected keyword argument 'text_data'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service initialized
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service initialized
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service shut down
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.mentallama.mock] - Mock MentaLLaMA service shut down
[31m[1m___________ TestAWSComprehendMedicalPHIDetection.test_initialization ___________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:928: in assert_called_once
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'client' to have been called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/core/services/ml/test_phi_detection_core.py[0m:88: in test_initialization
    [0mmock_boto3.assert_called_once()[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'client' to have been called once. Called 0 times.[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.phi.aws_comprehend_medical] - PHI detection service initialized successfully
[31m[1m_____ TestAWSComprehendMedicalPHIDetection.test_initialization_boto_error ______[0m
[1m[31mapp/tests/unit/core/services/ml/test_phi_detection_core.py[0m:100: in test_initialization_boto_error
    [0m[94mwith[39;49;00m pytest.raises(InvalidConfigurationError):[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'app.core.exceptions.base_exceptions.InvalidConfigurationError'>[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.phi.aws_comprehend_medical] - PHI detection service initialized successfully
[31m[1m________ TestAWSComprehendMedicalPHIDetection.test_detect_phi_with_phi _________[0m
[1m[31mapp/tests/unit/core/services/ml/test_phi_detection_core.py[0m:110: in test_detect_phi_with_phi
    [0mphi_detection_service._comprehend_medical_client,[90m[39;49;00m
[1m[31mE   AttributeError: 'AWSComprehendMedicalPHIDetection' object has no attribute '_comprehend_medical_client'. Did you mean: '_comprehend_medical_service'?[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.phi.aws_comprehend_medical] - PHI detection service initialized successfully
[31m[1m_______ TestAWSComprehendMedicalPHIDetection.test_detect_phi_without_phi _______[0m
[1m[31mapp/tests/unit/core/services/ml/test_phi_detection_core.py[0m:126: in test_detect_phi_without_phi
    [0mphi_detection_service._comprehend_medical_client,[90m[39;49;00m
[1m[31mE   AttributeError: 'AWSComprehendMedicalPHIDetection' object has no attribute '_comprehend_medical_client'. Did you mean: '_comprehend_medical_service'?[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.phi.aws_comprehend_medical] - PHI detection service initialized successfully
[31m[1m________ TestAWSComprehendMedicalPHIDetection.test_detect_phi_aws_error ________[0m
[1m[31mapp/tests/unit/core/services/ml/test_phi_detection_core.py[0m:153: in test_detect_phi_aws_error
    [0mphi_detection_service._comprehend_medical_client,[90m[39;49;00m
[1m[31mE   AttributeError: 'AWSComprehendMedicalPHIDetection' object has no attribute '_comprehend_medical_client'. Did you mean: '_comprehend_medical_service'?[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.phi.aws_comprehend_medical] - PHI detection service initialized successfully
[31m[1m________ TestAWSComprehendMedicalPHIDetection.test_redact_phi_with_phi _________[0m
[1m[31mapp/tests/unit/core/services/ml/test_phi_detection_core.py[0m:166: in test_redact_phi_with_phi
    [0mphi_detection_service._comprehend_medical_client,[90m[39;49;00m
[1m[31mE   AttributeError: 'AWSComprehendMedicalPHIDetection' object has no attribute '_comprehend_medical_client'. Did you mean: '_comprehend_medical_service'?[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.phi.aws_comprehend_medical] - PHI detection service initialized successfully
[31m[1m_______ TestAWSComprehendMedicalPHIDetection.test_redact_phi_without_phi _______[0m
[1m[31mapp/tests/unit/core/services/ml/test_phi_detection_core.py[0m:185: in test_redact_phi_without_phi
    [0mphi_detection_service._comprehend_medical_client,[90m[39;49;00m
[1m[31mE   AttributeError: 'AWSComprehendMedicalPHIDetection' object has no attribute '_comprehend_medical_client'. Did you mean: '_comprehend_medical_service'?[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:49] [INFO] [app.infrastructure.ml.phi.aws_comprehend_medical] - PHI detection service initialized successfully
[31m[1m_______________________________ test_get_engine ________________________________[0m
[1m[31mapp/tests/unit/core/test_database.py[0m:52: in test_get_engine
    [0m[94massert[39;49;00m engine [95mis[39;49;00m mock_engine_instance[90m[39;49;00m
[1m[31mE   AssertionError: assert namespace(echo=False, future=True, pool_pre_ping=True, pool_size=5, max_overflow=10, dict=<function _magicmock_call.<locals>._asdict at 0x16f91ca40>, model_dump=<function _magicmock_call.<locals>._asdict at 0x16f91ca40>) is <AsyncMock name='create_async_engine()' id='13059013088'>[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:49] [INFO] [app.core.dependencies.database] - Creating database engine for URL: postgresql+asyncpg:***
[31m[1m____________________________ test_get_session_local ____________________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:928: in assert_called_once
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'sessionmaker' to have been called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/core/test_database.py[0m:76: in test_get_session_local
    [0mmock_sessionmaker.assert_called_once()[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'sessionmaker' to have been called once. Called 0 times.[0m
[31m[1m__________________ TestEncryptionService.test_initialization ___________________[0m
[1m[31mapp/tests/unit/core/utils/test_encryption_unit.py[0m:29: in test_initialization
    [0m[94massert[39;49;00m service.secret_key == [33m"[39;49;00m[33mtest_key[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'BaseEncryptionService' object has no attribute 'secret_key'. Did you mean: '_direct_key'?[0m
[31m[1m__________ TestEncryptionService.test_initialization_with_missing_key __________[0m
[1m[31mapp/tests/unit/core/utils/test_encryption_unit.py[0m:37: in test_initialization_with_missing_key
    [0m[94mwith[39;49;00m pytest.raises([96mValueError[39;49;00m) [94mas[39;49;00m excinfo:[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'ValueError'>[0m
[31m[1m______________ TestEncryptionService.test_encrypt_decrypt_string _______________[0m
[1m[31mapp/tests/unit/core/utils/test_encryption_unit.py[0m:46: in test_encrypt_decrypt_string
    [0mencrypted = encryption_service.encrypt_string(plaintext)[90m[39;49;00m
[1m[31mE   AttributeError: 'BaseEncryptionService' object has no attribute 'encrypt_string'[0m
[31m[1m___________ TestEncryptionService.test_encrypt_decrypt_empty_string ____________[0m
[1m[31mapp/tests/unit/core/utils/test_encryption_unit.py[0m:62: in test_encrypt_decrypt_empty_string
    [0mencrypted = encryption_service.encrypt_string(plaintext)[90m[39;49;00m
[1m[31mE   AttributeError: 'BaseEncryptionService' object has no attribute 'encrypt_string'[0m
[31m[1m______________ TestEncryptionService.test_decrypt_invalid_string _______________[0m
[1m[31mapp/tests/unit/core/utils/test_encryption_unit.py[0m:76: in test_decrypt_invalid_string
    [0mencryption_service.decrypt_string([33m"[39;49;00m[33minvalid_encrypted_text[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'BaseEncryptionService' object has no attribute 'decrypt_string'[0m
[31m[1m_______________ TestEncryptionService.test_encrypt_decrypt_dict ________________[0m
[1m[31mapp/tests/unit/core/utils/test_encryption_unit.py[0m:94: in test_encrypt_decrypt_dict
    [0mencrypted_data = encryption_service.encrypt_dict(data, sensitive_fields)[90m[39;49;00m
[1m[31mE   TypeError: BaseEncryptionService.encrypt_dict() takes 2 positional arguments but 3 were given[0m
[31m[1m____________ TestEncryptionService.test_encrypt_decrypt_nested_dict ____________[0m
[1m[31mapp/tests/unit/core/utils/test_encryption_unit.py[0m:135: in test_encrypt_decrypt_nested_dict
    [0mencrypted_data = encryption_service.encrypt_dict(data, sensitive_fields)[90m[39;49;00m
[1m[31mE   TypeError: BaseEncryptionService.encrypt_dict() takes 2 positional arguments but 3 were given[0m
[31m[1m_______________ TestEncryptionService.test_generate_verify_hash ________________[0m
[1m[31mapp/tests/unit/core/utils/test_encryption_unit.py[0m:160: in test_generate_verify_hash
    [0mhash_value, salt = encryption_service.generate_hash(data)[90m[39;49;00m
[1m[31mE   AttributeError: 'BaseEncryptionService' object has no attribute 'generate_hash'[0m
[31m[1m_______________ TestEncryptionService.test_generate_verify_hmac ________________[0m
[1m[31mapp/tests/unit/core/utils/test_encryption_unit.py[0m:181: in test_generate_verify_hmac
    [0mhmac_value = encryption_service.generate_hmac(data)[90m[39;49;00m
[1m[31mE   AttributeError: 'BaseEncryptionService' object has no attribute 'generate_hmac'[0m
[31m[1m_________________ TestGetLogger.test_get_logger_configuration __________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:928: in assert_called_once
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'Formatter' to have been called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/core/utils/test_logging_enhanced.py[0m:73: in test_get_logger_configuration
    [0mmock_formatter_class.assert_called_once()[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'Formatter' to have been called once. Called 0 times.[0m
[31m[1m___________________ TestDigitalTwin.test_init_default_values ___________________[0m
[1m[31mapp/tests/unit/domain/entities/digital_twin/test_digital_twin_entity.py[0m:47: in test_init_default_values
    [0m[94massert[39;49;00m twin.created_at == twin.last_updated [90m# Initially should be same[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError: assert _PatchedDateTime(2025, 5, 3, 1, 52, 49, 820868, tzinfo=datetime.timezone.utc) == _PatchedDateTime(2025, 5, 3, 1, 52, 49, 820872, tzinfo=datetime.timezone.utc)[0m
[1m[31mE    +  where _PatchedDateTime(2025, 5, 3, 1, 52, 49, 820868, tzinfo=datetime.timezone.utc) = DigitalTwin(patient_id=UUID('bf0ec920-c96a-44d6-a16b-885626271492'), id=UUID('beac81d3-f15e-4050-a10c-1de07a5a25f1'), ...ted=_PatchedDateTime(2025, 5, 3, 1, 52, 49, 820872, tzinfo=datetime.timezone.utc), version=1, integration_summary=None).created_at[0m
[1m[31mE    +  and   _PatchedDateTime(2025, 5, 3, 1, 52, 49, 820872, tzinfo=datetime.timezone.utc) = DigitalTwin(patient_id=UUID('bf0ec920-c96a-44d6-a16b-885626271492'), id=UUID('beac81d3-f15e-4050-a10c-1de07a5a25f1'), ...ted=_PatchedDateTime(2025, 5, 3, 1, 52, 49, 820872, tzinfo=datetime.timezone.utc), version=1, integration_summary=None).last_updated[0m
[31m[1m_____________ TestPatientContactInfo.test_contact_info_descriptor ______________[0m
[1m[31mapp/tests/unit/domain/entities/test_patient_entity.py[0m:39: in test_contact_info_descriptor
    [0m[96mself[39;49;00m.assertIsInstance(patient_dict.contact_info, ContactInfo)[90m[39;49;00m
[1m[31mE   AssertionError: <class 'app.domain.entities.patient.ContactInfo'> is not an instance of <class 'app.domain.entities.patient.ContactInfo'>[0m
[31m[1m______________ TestPatientContactInfo.test_contact_info_with_dict ______________[0m
[1m[31mapp/tests/unit/domain/entities/test_patient_entity.py[0m:102: in test_contact_info_with_dict
    [0m[96mself[39;49;00m.assertIsInstance(patient.contact_info, ContactInfo)[90m[39;49;00m
[1m[31mE   AssertionError: <class 'app.domain.entities.patient.ContactInfo'> is not an instance of <class 'app.domain.entities.patient.ContactInfo'>[0m
[31m[1m_____________ TestPatientContactInfo.test_contact_info_with_object _____________[0m
[1m[31mapp/tests/unit/domain/entities/test_patient_entity.py[0m:126: in test_contact_info_with_object
    [0m[96mself[39;49;00m.assertIsInstance(patient.contact_info, ContactInfo)[90m[39;49;00m
[1m[31mE   AssertionError: <class 'app.domain.entities.patient.ContactInfo'> is not an instance of <class 'app.domain.entities.patient.ContactInfo'>[0m
[31m[1m__ TestBiometricIntegrationService.test_get_or_create_biometric_twin_existing __[0m
[1m[31mapp/tests/unit/domain/services/test_biometric_integration_service.py[0m:50: in test_get_or_create_biometric_twin_existing
    [0mmock_twin = BiometricTwin(patient_id=patient_id)[90m[39;49;00m
[1m[31mE   TypeError: BiometricTwin.__init__() missing 1 required positional argument: 'timeseries_data'[0m
[31m[1m____ TestBiometricIntegrationService.test_get_or_create_biometric_twin_new _____[0m
[1m[31mapp/tests/unit/domain/services/test_biometric_integration_service.py[0m:77: in test_get_or_create_biometric_twin_new
    [0m[94massert[39;49;00m [96misinstance[39;49;00m(result, BiometricTwin)[90m[39;49;00m
[1m[31mE   assert False[0m
[1m[31mE    +  where False = isinstance(None, BiometricTwin)[0m
[31m[1m___ TestBiometricIntegrationService.test_get_or_create_biometric_twin_error ____[0m
[1m[31mapp/tests/unit/domain/services/test_biometric_integration_service.py[0m:91: in test_get_or_create_biometric_twin_error
    [0m[94mawait[39;49;00m service.get_or_create_biometric_twin(patient_id)[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:2291: in _execute_mock_call
    [0m[94mraise[39;49;00m effect[90m[39;49;00m
[1m[31mE   Exception: Database error[0m
[31m[1m___________ TestBiometricIntegrationService.test_add_biometric_data ____________[0m
[1m[31mapp/domain/services/biometric_integration_service.py[0m:98: in add_biometric_data
    [0mdata_point = BiometricDataPoint([90m[39;49;00m
[1m[31mE   pydantic_core._pydantic_core.ValidationError: 2 validation errors for BiometricDataPoint[0m
[1m[31mE   data_id[0m
[1m[31mE     Field required [type=missing, input_value={'data_type': 'heart_rate...g'}, 'confidence': 0.95}, input_type=dict][0m
[1m[31mE       For further information visit https://errors.pydantic.dev/2.8/v/missing[0m
[1m[31mE   patient_id[0m
[1m[31mE     Field required [type=missing, input_value={'data_type': 'heart_rate...g'}, 'confidence': 0.95}, input_type=dict][0m
[1m[31mE       For further information visit https://errors.pydantic.dev/2.8/v/missing[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/domain/services/test_biometric_integration_service.py[0m:108: in test_add_biometric_data
    [0mdata_point = [94mawait[39;49;00m service.add_biometric_data([90m[39;49;00m
[1m[31mapp/domain/services/biometric_integration_service.py[0m:114: in add_biometric_data
    [0m[94mraise[39;49;00m DomainError([33mf[39;49;00m[33m"[39;49;00m[33mFailed to add biometric data: [39;49;00m[33m{[39;49;00me[33m!s}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.domain.exceptions.base.DomainException: Failed to add biometric data: 2 validation errors for BiometricDataPoint[0m
[1m[31mE   data_id[0m
[1m[31mE     Field required [type=missing, input_value={'data_type': 'heart_rate...g'}, 'confidence': 0.95}, input_type=dict][0m
[1m[31mE       For further information visit https://errors.pydantic.dev/2.8/v/missing[0m
[1m[31mE   patient_id[0m
[1m[31mE     Field required [type=missing, input_value={'data_type': 'heart_rate...g'}, 'confidence': 0.95}, input_type=dict][0m
[1m[31mE       For further information visit https://errors.pydantic.dev/2.8/v/missing[0m
[31m[1m________ TestBiometricIntegrationService.test_batch_add_biometric_data _________[0m
[1m[31mapp/domain/services/biometric_integration_service.py[0m:140: in batch_add_biometric_data
    [0mdata_point = BiometricDataPoint([90m[39;49;00m
[1m[31mE   pydantic_core._pydantic_core.ValidationError: 2 validation errors for BiometricDataPoint[0m
[1m[31mE   data_id[0m
[1m[31mE     Field required [type=missing, input_value={'data_type': 'heart_rate...: {}, 'confidence': 1.0}, input_type=dict][0m
[1m[31mE       For further information visit https://errors.pydantic.dev/2.8/v/missing[0m
[1m[31mE   patient_id[0m
[1m[31mE     Field required [type=missing, input_value={'data_type': 'heart_rate...: {}, 'confidence': 1.0}, input_type=dict][0m
[1m[31mE       For further information visit https://errors.pydantic.dev/2.8/v/missing[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/domain/services/test_biometric_integration_service.py[0m:180: in test_batch_add_biometric_data
    [0mresult = [94mawait[39;49;00m service.batch_add_biometric_data(patient_id, batch_data)[90m[39;49;00m
[1m[31mapp/domain/services/biometric_integration_service.py[0m:157: in batch_add_biometric_data
    [0m[94mraise[39;49;00m DomainError([33mf[39;49;00m[33m"[39;49;00m[33mFailed to batch add biometric data: [39;49;00m[33m{[39;49;00me[33m!s}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.domain.exceptions.base.DomainException: Failed to batch add biometric data: 2 validation errors for BiometricDataPoint[0m
[1m[31mE   data_id[0m
[1m[31mE     Field required [type=missing, input_value={'data_type': 'heart_rate...: {}, 'confidence': 1.0}, input_type=dict][0m
[1m[31mE       For further information visit https://errors.pydantic.dev/2.8/v/missing[0m
[1m[31mE   patient_id[0m
[1m[31mE     Field required [type=missing, input_value={'data_type': 'heart_rate...: {}, 'confidence': 1.0}, input_type=dict][0m
[1m[31mE       For further information visit https://errors.pydantic.dev/2.8/v/missing[0m
[31m[1m___________ TestBiometricIntegrationService.test_get_biometric_data ____________[0m
[1m[31mapp/tests/unit/domain/services/test_biometric_integration_service.py[0m:200: in test_get_biometric_data
    [0mBiometricTwin([90m[39;49;00m
[1m[31mE   TypeError: BiometricTwin.__init__() got an unexpected keyword argument 'data_type'[0m
[31m[1m_______ TestBiometricIntegrationService.test_get_biometric_data_no_twin ________[0m
[1m[31mapp/domain/services/biometric_integration_service.py[0m:189: in get_biometric_data
    [0mfiltered_points = twin.data_points[90m[39;49;00m
[1m[31mE   AttributeError: 'coroutine' object has no attribute 'data_points'[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/domain/services/test_biometric_integration_service.py[0m:265: in test_get_biometric_data_no_twin
    [0mresult = [94mawait[39;49;00m service.get_biometric_data(patient_id=patient_id)[90m[39;49;00m
[1m[31mapp/domain/services/biometric_integration_service.py[0m:206: in get_biometric_data
    [0m[94mraise[39;49;00m DomainError([33mf[39;49;00m[33m"[39;49;00m[33mFailed to retrieve biometric data: [39;49;00m[33m{[39;49;00me[33m!s}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.domain.exceptions.base.DomainException: Failed to retrieve biometric data: 'coroutine' object has no attribute 'data_points'[0m
[31m[1m_____________ TestBiometricIntegrationService.test_analyze_trends ______________[0m
[1m[31mapp/tests/unit/domain/services/test_biometric_integration_service.py[0m:279: in test_analyze_trends
    [0mBiometricTwin([90m[39;49;00m
[1m[31mE   TypeError: BiometricTwin.__init__() got an unexpected keyword argument 'data_type'[0m
[31m[1m___________ TestBiometricIntegrationService.test_detect_correlations ___________[0m
[1m[31mapp/tests/unit/domain/services/test_biometric_integration_service.py[0m:366: in test_detect_correlations
    [0mBiometricTwin([90m[39;49;00m
[1m[31mE   TypeError: BiometricTwin.__init__() got an unexpected keyword argument 'data_type'[0m
[31m[1m_____________ TestBiometricIntegrationService.test_connect_device ______________[0m
[1m[31mapp/domain/services/biometric_integration_service.py[0m:400: in connect_device
    [0mtwin.connect_device(device_id)[90m[39;49;00m
[1m[31mE   AttributeError: 'coroutine' object has no attribute 'connect_device'[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/domain/services/test_biometric_integration_service.py[0m:426: in test_connect_device
    [0mresult = [94mawait[39;49;00m service.connect_device([90m[39;49;00m
[1m[31mapp/domain/services/biometric_integration_service.py[0m:416: in connect_device
    [0m[94mraise[39;49;00m DomainError([33mf[39;49;00m[33m"[39;49;00m[33mFailed to connect device: [39;49;00m[33m{[39;49;00me[33m!s}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.domain.exceptions.base.DomainException: Failed to connect device: 'coroutine' object has no attribute 'connect_device'[0m
[31m[1m___________ TestClinicalRuleEngine.test_get_active_rules_for_patient ___________[0m
[1m[31mapp/tests/unit/domain/services/test_clinical_rule_engine.py[0m:397: in test_get_active_rules_for_patient
    [0m[94massert[39;49;00m global_rule [95min[39;49;00m result[90m[39;49;00m
[1m[31m<string>[0m:4: in __eq__
    [0m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'BiometricRule' object has no attribute 'created_at'[0m
[31m[1m_____________ TestBiometricAlert.test_biometric_alert_acknowledged _____________[0m
[1m[31mapp/tests/unit/domain/test_biometric_alert.py[0m:105: in test_biometric_alert_acknowledged
    [0msample_biometric_alert.acknowledge(provider_id, ack_time)[90m[39;49;00m
[1m[31mE   TypeError: BiometricAlert.acknowledge() takes 2 positional arguments but 3 were given[0m
[31m[1m_______________ TestBiometricAlert.test_biometric_alert_resolved _______________[0m
[1m[31mapp/tests/unit/domain/test_biometric_alert.py[0m:120: in test_biometric_alert_resolved
    [0msample_biometric_alert.resolve(provider_id, resolution_time, resolution_note)[90m[39;49;00m
[1m[31mE   AttributeError: 'BiometricAlert' object has no attribute 'resolve'[0m
[31m[1m_____________________________ test_create_patient ______________________________[0m
[1m[31mapp/tests/unit/domain/test_patient.py[0m:57: in test_create_patient
    [0m[94massert[39;49;00m patient.contact_info.email == [33m"[39;49;00m[33mjohn.doe@example.com[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError: assert None == 'john.doe@example.com'[0m
[1m[31mE    +  where None = <class 'app.domain.entities.patient.ContactInfo'>.email[0m
[1m[31mE    +    where <class 'app.domain.entities.patient.ContactInfo'> = Patient(id=UUID('12345678-1234-5678-1234-567812345678'), name='John Doe', first_name='John', last_name='Doe').contact_info[0m
[31m[1m_____________________________ test_update_patient ______________________________[0m
[1m[31mapp/tests/unit/domain/test_patient.py[0m:93: in test_update_patient
    [0m[94massert[39;49;00m patient.contact_info.email == [33m"[39;49;00m[33mjane.smith@example.com[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError: assert None == 'jane.smith@example.com'[0m
[1m[31mE    +  where None = <class 'app.domain.entities.patient.ContactInfo'>.email[0m
[1m[31mE    +    where <class 'app.domain.entities.patient.ContactInfo'> = Patient(id=UUID('12345678-1234-5678-1234-567812345678'), name='John Doe', first_name='Jane', last_name='Smith').contact_info[0m
[31m[1m_____________ TestEmergencyContact.test_emergency_contact_creation _____________[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:49: in test_emergency_contact_creation
    [0m[94massert[39;49;00m [96misinstance[39;49;00m(contact.address, Address)[90m[39;49;00m
[1m[31mE   AssertionError: assert False[0m
[1m[31mE    +  where False = isinstance({'city': 'Boston', 'country': 'USA', 'state': 'MA', 'street': '123 Main St', ...}, Address)[0m
[1m[31mE    +    where {'city': 'Boston', 'country': 'USA', 'state': 'MA', 'street': '123 Main St', ...} = EmergencyContact(name='Jane Doe', relationship='Spouse', phone='555-123-4567', email='jane.doe@example.com', address={'street': '123 Main St', 'city': 'Boston', 'state': 'MA', 'zip_code': '02115', 'country': 'USA'}).address[0m
[31m[1m____________ TestEmergencyContact.test_emergency_contact_validation ____________[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:57: in test_emergency_contact_validation
    [0mEmergencyContact([90m[39;49;00m
[1m[31m<string>[0m:8: in __init__
    [0m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[90m[39;49;00m
[1m[31mapp/domain/value_objects/emergency_contact.py[0m:25: in __post_init__
    [0m[94mraise[39;49;00m [96mValueError[39;49;00m([33m"[39;49;00m[33mEmergency contact name is required[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   ValueError: Emergency contact name is required[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:56: in test_emergency_contact_validation
    [0m[94mwith[39;49;00m pytest.raises([96mValueError[39;49;00m, match=[33m"[39;49;00m[33mName cannot be empty[39;49;00m[33m"[39;49;00m):[90m[39;49;00m
[1m[31mE   AssertionError: Regex pattern did not match.[0m
[1m[31mE    Regex: 'Name cannot be empty'[0m
[1m[31mE    Input: 'Emergency contact name is required'[0m
[31m[1m_____________ TestEmergencyContact.test_emergency_contact_to_dict ______________[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:134: in test_emergency_contact_to_dict
    [0m[94massert[39;49;00m contact_dict[[33m"[39;49;00m[33mname[39;49;00m[33m"[39;49;00m] == valid_contact_data[[33m"[39;49;00m[33mname[39;49;00m[33m"[39;49;00m][90m[39;49;00m
[1m[31mE   AssertionError: assert '[REDACTED]' == 'Jane Doe'[0m
[1m[31mE     [0m
[1m[31mE     - Jane Doe[0m
[1m[31mE     + [REDACTED][0m
[31m[1m________ TestPsychiatricAssessment.test_psychiatric_assessment_creation ________[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:157: in test_psychiatric_assessment_creation
    [0massessment = PsychiatricAssessment(**valid_assessment_data)[90m[39;49;00m
[1m[31mE   TypeError: PsychiatricAssessment.__init__() got an unexpected keyword argument 'diagnosis'[0m
[31m[1m_______ TestPsychiatricAssessment.test_psychiatric_assessment_validation _______[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:170: in test_psychiatric_assessment_validation
    [0mPsychiatricAssessment([90m[39;49;00m
[1m[31mE   TypeError: PsychiatricAssessment.__init__() got an unexpected keyword argument 'diagnosis'[0m
[31m[1m____ TestPsychiatricAssessment.test_psychiatric_assessment_optional_fields _____[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:198: in test_psychiatric_assessment_optional_fields
    [0massessment = PsychiatricAssessment(**data)[90m[39;49;00m
[1m[31mE   TypeError: PsychiatricAssessment.__init__() got an unexpected keyword argument 'diagnosis'[0m
[31m[1m________ TestPsychiatricAssessment.test_psychiatric_assessment_equality ________[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:203: in test_psychiatric_assessment_equality
    [0massessment1 = PsychiatricAssessment(**valid_assessment_data,)[90m[39;49;00m
[1m[31mE   TypeError: PsychiatricAssessment.__init__() got an unexpected keyword argument 'diagnosis'[0m
[31m[1m__________ TestPsychiatricAssessment.test_psychiatric_assessment_repr __________[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:217: in test_psychiatric_assessment_repr
    [0massessment = PsychiatricAssessment(**valid_assessment_data,)[90m[39;49;00m
[1m[31mE   TypeError: PsychiatricAssessment.__init__() got an unexpected keyword argument 'diagnosis'[0m
[31m[1m________ TestPsychiatricAssessment.test_psychiatric_assessment_to_dict _________[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:227: in test_psychiatric_assessment_to_dict
    [0massessment = PsychiatricAssessment(**valid_assessment_data,)[90m[39;49;00m
[1m[31mE   TypeError: PsychiatricAssessment.__init__() got an unexpected keyword argument 'diagnosis'[0m
[31m[1m_______ TestPsychiatricAssessment.test_psychiatric_assessment_from_dict ________[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:243: in test_psychiatric_assessment_from_dict
    [0massessment = PsychiatricAssessment.from_dict(dict_data)[90m[39;49;00m
[1m[31mE   AttributeError: type object 'PsychiatricAssessment' has no attribute 'from_dict'. Did you mean: 'to_dict'?[0m
[31m[1m_________ TestContactInfoValueObject.test_contact_info_optional_fields _________[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:356: in test_contact_info_optional_fields
    [0mcontact_info = ContactInfo(**data)[90m[39;49;00m
[1m[31mE   TypeError: ContactInfo.__init__() missing 1 required positional argument: 'email'[0m
[31m[1m_____________ TestContactInfoValueObject.test_contact_info_to_dict _____________[0m
[1m[31mapp/tests/unit/domain/value_objects/test_value_objects_enhanced.py[0m:371: in test_contact_info_to_dict
    [0m[94massert[39;49;00m contact_info_dict == valid_contact_info_data[90m[39;49;00m
[1m[31mE   AssertionError: assert {'email': 'pa...555-123-4567'} == {'email': 'pa...hod': 'email'}[0m
[1m[31mE     [0m
[1m[31mE     Omitting 2 identical items, use -vv to show[0m
[1m[31mE     Right contains 1 more item:[0m
[1m[31mE     [0m{[33m'[39;49;00m[33mpreferred_contact_method[39;49;00m[33m'[39;49;00m: [33m'[39;49;00m[33memail[39;49;00m[33m'[39;49;00m}[90m[39;49;00m[0m
[1m[31mE     Use -v to get more diff[0m
[31m[1m___________________ TestRedisCache.test_get_nonexistent_key ____________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:960: in assert_called_once_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'get' to be called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:47: in test_get_nonexistent_key
    [0mmock_redis_client.get.assert_called_once_with([33m"[39;49;00m[33mnonexistent-key[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'get' to be called once. Called 0 times.[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:50] [INFO] [app.infrastructure.cache.redis_cache] - Connected to Redis at redis://mocked:6379/0
[2025-05-02 21:52:50] [ERROR] [app.infrastructure.cache.redis_cache] - Error retrieving key nonexistent-key from cache: Error 8 connecting to mocked:6379. 8.
[31m[1m_____________________ TestRedisCache.test_get_existing_key _____________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:57: in test_get_existing_key
    [0m[94massert[39;49;00m result == mock_data[90m[39;49;00m
[1m[31mE   AssertionError: assert None == {'nested': {'data': 123}, 'test': 'value'}[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:50] [INFO] [app.infrastructure.cache.redis_cache] - Connected to Redis at redis://mocked:6379/0
[2025-05-02 21:52:50] [ERROR] [app.infrastructure.cache.redis_cache] - Error retrieving key existing-key from cache: Error 8 connecting to mocked:6379. 8.
[31m[1m_____________________ TestRedisCache.test_get_invalid_json _____________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:960: in assert_called_once_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'get' to be called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:68: in test_get_invalid_json
    [0mmock_redis_client.get.assert_called_once_with([33m"[39;49;00m[33minvalid-key[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'get' to be called once. Called 0 times.[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:50] [INFO] [app.infrastructure.cache.redis_cache] - Connected to Redis at redis://mocked:6379/0
[2025-05-02 21:52:50] [ERROR] [app.infrastructure.cache.redis_cache] - Error retrieving key invalid-key from cache: Error 8 connecting to mocked:6379. 8.
[31m[1m_____________________ TestRedisCache.test_set_simple_value _____________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:78: in test_set_simple_value
    [0m[94massert[39;49;00m success [95mis[39;49;00m [94mTrue[39;49;00m[90m[39;49;00m
[1m[31mE   assert False is True[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:50] [INFO] [app.infrastructure.cache.redis_cache] - Connected to Redis at redis://mocked:6379/0
[2025-05-02 21:52:50] [ERROR] [app.infrastructure.cache.redis_cache] - Error setting key test-key in cache: Error 8 connecting to mocked:6379. 8.
[31m[1m____________________ TestRedisCache.test_set_complex_value _____________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:95: in test_set_complex_value
    [0m[94massert[39;49;00m success [95mis[39;49;00m [94mTrue[39;49;00m[90m[39;49;00m
[1m[31mE   assert False is True[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:50] [INFO] [app.infrastructure.cache.redis_cache] - Connected to Redis at redis://mocked:6379/0
[2025-05-02 21:52:50] [ERROR] [app.infrastructure.cache.redis_cache] - Error setting key complex-key in cache: Error 8 connecting to mocked:6379. 8.
[31m[1m_____________________ TestRedisCache.test_set_redis_error ______________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:928: in assert_called_once
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'setex' to have been called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:124: in test_set_redis_error
    [0mmock_redis_client.setex.assert_called_once()[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'setex' to have been called once. Called 0 times.[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:50] [INFO] [app.infrastructure.cache.redis_cache] - Connected to Redis at redis://mocked:6379/0
[2025-05-02 21:52:50] [ERROR] [app.infrastructure.cache.redis_cache] - Error setting key error-key in cache: Error 8 connecting to mocked:6379. 8.
[31m[1m___________________ TestRedisCache.test_delete_existing_key ____________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:133: in test_delete_existing_key
    [0m[94massert[39;49;00m success [95mis[39;49;00m [94mTrue[39;49;00m[90m[39;49;00m
[1m[31mE   assert 0 is True[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:50] [INFO] [app.infrastructure.cache.redis_cache] - Connected to Redis at redis://mocked:6379/0
[2025-05-02 21:52:50] [ERROR] [app.infrastructure.cache.redis_cache] - Error deleting key existing-key from cache: Error 8 connecting to mocked:6379. 8.
[31m[1m__________________ TestRedisCache.test_delete_nonexistent_key __________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:143: in test_delete_nonexistent_key
    [0m[94massert[39;49;00m success [95mis[39;49;00m [94mTrue[39;49;00m  [90m# We consider this a success since the key doesn't exist[39;49;00m[90m[39;49;00m
[1m[31mE   assert 0 is True[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:50] [INFO] [app.infrastructure.cache.redis_cache] - Connected to Redis at redis://mocked:6379/0
[2025-05-02 21:52:50] [ERROR] [app.infrastructure.cache.redis_cache] - Error deleting key nonexistent-key from cache: Error 8 connecting to mocked:6379. 8.
[31m[1m____________________ TestRedisCache.test_delete_redis_error ____________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:153: in test_delete_redis_error
    [0m[94massert[39;49;00m success [95mis[39;49;00m [94mFalse[39;49;00m[90m[39;49;00m
[1m[31mE   assert 0 is False[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:50] [INFO] [app.infrastructure.cache.redis_cache] - Connected to Redis at redis://mocked:6379/0
[2025-05-02 21:52:50] [ERROR] [app.infrastructure.cache.redis_cache] - Error deleting key error-key from cache: Error 8 connecting to mocked:6379. 8.
[31m[1m_______________________ TestRedisCache.test_exists_true ________________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:163: in test_exists_true
    [0m[94massert[39;49;00m exists [95mis[39;49;00m [94mTrue[39;49;00m[90m[39;49;00m
[1m[31mE   assert False is True[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:50] [INFO] [app.infrastructure.cache.redis_cache] - Connected to Redis at redis://mocked:6379/0
[2025-05-02 21:52:50] [ERROR] [app.infrastructure.cache.redis_cache] - Error checking if key existing-key exists in cache: Error 8 connecting to mocked:6379. 8.
[31m[1m_______________________ TestRedisCache.test_exists_false _______________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:960: in assert_called_once_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'exists' to be called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:174: in test_exists_false
    [0mmock_redis_client.exists.assert_called_once_with([33m"[39;49;00m[33mnonexistent-key[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'exists' to be called once. Called 0 times.[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:50] [INFO] [app.infrastructure.cache.redis_cache] - Connected to Redis at redis://mocked:6379/0
[2025-05-02 21:52:50] [ERROR] [app.infrastructure.cache.redis_cache] - Error checking if key nonexistent-key exists in cache: Error 8 connecting to mocked:6379. 8.
[31m[1m____________________ TestRedisCache.test_exists_redis_error ____________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:960: in assert_called_once_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'exists' to be called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:184: in test_exists_redis_error
    [0mmock_redis_client.exists.assert_called_once_with([33m"[39;49;00m[33merror-key[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'exists' to be called once. Called 0 times.[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:50] [INFO] [app.infrastructure.cache.redis_cache] - Connected to Redis at redis://mocked:6379/0
[2025-05-02 21:52:50] [ERROR] [app.infrastructure.cache.redis_cache] - Error checking if key error-key exists in cache: Error 8 connecting to mocked:6379. 8.
[31m[1m____________________ TestRedisCache.test_increment_success _____________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:191: in test_increment_success
    [0mnew_value = [94mawait[39;49;00m redis_cache.increment([33m"[39;49;00m[33mcounter-key[39;49;00m[33m"[39;49;00m, [94m5[39;49;00m)[90m[39;49;00m
[1m[31mE   TypeError: RedisCache.increment() takes 2 positional arguments but 3 were given[0m
[31m[1m__________________ TestRedisCache.test_increment_redis_error ___________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:201: in test_increment_redis_error
    [0mnew_value = [94mawait[39;49;00m redis_cache.increment([33m"[39;49;00m[33merror-key[39;49;00m[33m"[39;49;00m, [94m1[39;49;00m)[90m[39;49;00m
[1m[31mE   TypeError: RedisCache.increment() takes 2 positional arguments but 3 were given[0m
[31m[1m_____________________ TestRedisCache.test_get_ttl_success ______________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:211: in test_get_ttl_success
    [0mttl = [94mawait[39;49;00m redis_cache.get_ttl([33m"[39;49;00m[33mtest-key[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'RedisCache' object has no attribute 'get_ttl'[0m
[31m[1m_________________ TestRedisCache.test_get_ttl_nonexistent_key __________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:221: in test_get_ttl_nonexistent_key
    [0mttl = [94mawait[39;49;00m redis_cache.get_ttl([33m"[39;49;00m[33mnonexistent-key[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'RedisCache' object has no attribute 'get_ttl'[0m
[31m[1m__________________ TestRedisCache.test_get_ttl_persistent_key __________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:231: in test_get_ttl_persistent_key
    [0mttl = [94mawait[39;49;00m redis_cache.get_ttl([33m"[39;49;00m[33mpersistent-key[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'RedisCache' object has no attribute 'get_ttl'[0m
[31m[1m___________________ TestRedisCache.test_get_ttl_redis_error ____________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:241: in test_get_ttl_redis_error
    [0mttl = [94mawait[39;49;00m redis_cache.get_ttl([33m"[39;49;00m[33merror-key[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'RedisCache' object has no attribute 'get_ttl'[0m
[31m[1m___________________________ test_no_redis_available ____________________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:251: in test_no_redis_available
    [0m[94massert[39;49;00m cache.redis_client [95mis[39;49;00m [94mNone[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'RedisCache' object has no attribute 'redis_client'[0m
[31m[1m______________________ test_methods_with_no_redis_client _______________________[0m
[1m[31mapp/tests/unit/infrastructure/cache/test_redis_cache.py[0m:260: in test_methods_with_no_redis_client
    [0m[94massert[39;49;00m cache.redis_client [95mis[39;49;00m [94mNone[39;49;00m [90m# Ensure client is None[39;49;00m[90m[39;49;00m
[1m[31mE   AttributeError: 'RedisCache' object has no attribute 'redis_client'[0m
[31m[1m___________________ TestPHIDetectionService.test_redact_phi ____________________[0m
[1m[31mapp/tests/unit/infrastructure/ml/phi_detection/test_phi_detection_service.py[0m:104: in test_redact_phi
    [0m[94massert[39;49;00m [33m"[39;49;00m[33m[REDACTED:[39;49;00m[33m"[39;49;00m [95min[39;49;00m redacted[90m[39;49;00m
[1m[31mE   AssertionError: assert '[REDACTED:' in '[REDACTED] [REDACTED] ([REDACTED].'[0m
[31m[1m_________________ TestPHIDetectionService.test_error_handling __________________[0m
[1m[31mapp/infrastructure/ml/phi_detection/service.py[0m:212: in contains_phi
    [0m[96mself[39;49;00m.ensure_initialized()[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/patients.py[0m:105: in _magicmock_call
    [0m[94mreturn[39;49;00m _original_magicmock_call([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1139: in __call__
    [0m[94mreturn[39;49;00m [96mself[39;49;00m._mock_call(*args, **kwargs)[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1143: in _mock_call
    [0m[94mreturn[39;49;00m [96mself[39;49;00m._execute_mock_call(*args, **kwargs)[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1198: in _execute_mock_call
    [0m[94mraise[39;49;00m effect[90m[39;49;00m
[1m[31mE   Exception: Test error[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/infrastructure/ml/phi_detection/test_phi_detection_service.py[0m:121: in test_error_handling
    [0mphi_detection_service.contains_phi([33m"[39;49;00m[33mTest text[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mapp/infrastructure/ml/phi_detection/service.py[0m:221: in contains_phi
    [0m[94mraise[39;49;00m PHISecurityError([33mf[39;49;00m[33m"[39;49;00m[33mFailed to detect PHI: [39;49;00m[33m{[39;49;00m[96mstr[39;49;00m(e)[33m}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.core.exceptions.ml_exceptions.PHISecurityError: Failed to detect PHI: Test error[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:51] [ERROR] [app.infrastructure.ml.phi_detection.service] - Error detecting PHI: Test error
[31m[1m_______________ TestXGBoostSymptomModel.test_load_model_success ________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:960: in assert_called_once_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'load' to be called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/infrastructure/ml/symptom_forecasting/test_xgboost_model.py[0m:59: in test_load_model_success
    [0mmock_joblib.load.assert_called_once_with([33m"[39;49;00m[33mtest/model/path.json[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'load' to be called once. Called 0 times.[0m
[31m[1m____________ TestXGBoostSymptomModel.test_load_model_file_not_found ____________[0m
[1m[31mapp/tests/unit/infrastructure/ml/symptom_forecasting/test_xgboost_model.py[0m:69: in test_load_model_file_not_found
    [0m[94mwith[39;49;00m pytest.raises([96mFileNotFoundError[39;49;00m):[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'FileNotFoundError'>[0m
[31m[1m_____________ TestXGBoostSymptomModel.test_get_feature_importance ______________[0m
[1m[31mapp/tests/unit/infrastructure/ml/symptom_forecasting/test_xgboost_model.py[0m:133: in test_get_feature_importance
    [0m[94massert[39;49;00m result[[33m"[39;49;00m[33mdepression_score[39;49;00m[33m"[39;49;00m][[33m"[39;49;00m[33mmedication_adherence[39;49;00m[33m"[39;49;00m] == [94m25.7[39;49;00m[90m[39;49;00m
[1m[31mE   TypeError: 'types.SimpleNamespace' object is not subscriptable[0m
[31m[1m______________________ TestXGBoostSymptomModel.test_train ______________________[0m
[1m[31mapp/tests/unit/infrastructure/ml/symptom_forecasting/test_xgboost_model.py[0m:183: in test_train
    [0mresult = model.train(X_train, y_train, optimize=[94mFalse[39;49;00m)[90m[39;49;00m
[1m[31mapp/infrastructure/ml/symptom_forecasting/xgboost_model.py[0m:308: in train
    [0mimportance = model.get_score(importance_type=[33m"[39;49;00m[33mgain[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AttributeError: 'types.SimpleNamespace' object has no attribute 'get_score'[0m
[31m[1m_ TestDigitalTwinIntegrationService.test_generate_comprehensive_insights_all_services _[0m
[1m[31mapp/tests/unit/infrastructure/ml/test_digital_twin_integration_service.py[0m:229: in test_generate_comprehensive_insights_all_services
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mmedication_predictions[39;49;00m[33m"[39;49;00m [95min[39;49;00m result[90m[39;49;00m
[1m[31mE   AssertionError: assert 'medication_predictions' in {'biometric_correlations': {'correlations': [{'biometric_type': 'heart_rate_variability', 'coefficient': -0.72, 'confi...e': ['Critical for treatment efficacy', 'Current phase of treatment is adherence-sensitive'], 'type': 'general'}], ...}[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:51] [ERROR] [app.infrastructure.ml.digital_twin_integration_service] - Error retrieving patient data: 'DigitalTwinIntegrationService' object has no attribute 'patient_repository'
[2025-05-02 21:52:51] [ERROR] [app.infrastructure.ml.digital_twin_integration_service] - Error predicting medication response: 'DigitalTwinIntegrationService' object has no attribute 'medication_response_service'
[31m[1m_ TestDigitalTwinIntegrationService.test_generate_comprehensive_insights_partial_services _[0m
[1m[31mapp/tests/unit/infrastructure/ml/test_digital_twin_integration_service.py[0m:257: in test_generate_comprehensive_insights_partial_services
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mmedication_predictions[39;49;00m[33m"[39;49;00m [95min[39;49;00m result[90m[39;49;00m
[1m[31mE   assert 'medication_predictions' in {'errors': {'medication_predictions': "'DigitalTwinIntegrationService' object has no attribute 'medication_response_se... of treatment is adherence-sensitive'], 'type': 'general'}], 'patient_id': '873772a5-6cf5-4135-8d33-7c5a8f51a3ca', ...}[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:51] [ERROR] [app.infrastructure.ml.digital_twin_integration_service] - Error retrieving patient data: 'DigitalTwinIntegrationService' object has no attribute 'patient_repository'
[2025-05-02 21:52:51] [ERROR] [app.infrastructure.ml.digital_twin_integration_service] - Error predicting medication response: 'DigitalTwinIntegrationService' object has no attribute 'medication_response_service'
[31m[1m_ TestDigitalTwinIntegrationService.test_generate_comprehensive_insights_handles_service_errors _[0m
[1m[31mapp/tests/unit/infrastructure/ml/test_digital_twin_integration_service.py[0m:289: in test_generate_comprehensive_insights_handles_service_errors
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mmedication_predictions[39;49;00m[33m"[39;49;00m [95min[39;49;00m result[90m[39;49;00m
[1m[31mE   AssertionError: assert 'medication_predictions' in {'biometric_correlations': {'correlations': [{'biometric_type': 'heart_rate_variability', 'coefficient': -0.72, 'confi...e': ['Critical for treatment efficacy', 'Current phase of treatment is adherence-sensitive'], 'type': 'general'}], ...}[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:51] [ERROR] [app.infrastructure.ml.digital_twin_integration_service] - Error retrieving patient data: 'DigitalTwinIntegrationService' object has no attribute 'patient_repository'
[2025-05-02 21:52:51] [ERROR] [app.infrastructure.ml.digital_twin_integration_service] - Error generating symptom forecast: Service error
[2025-05-02 21:52:51] [ERROR] [app.infrastructure.ml.digital_twin_integration_service] - Error predicting medication response: 'DigitalTwinIntegrationService' object has no attribute 'medication_response_service'
[31m[1m___________ TestDigitalTwinIntegrationService.test_get_patient_data ____________[0m
[1m[31mapp/tests/unit/infrastructure/ml/test_digital_twin_integration_service.py[0m:382: in test_get_patient_data
    [0mpatient_data = [94mawait[39;49;00m integration_service._get_patient_data(sample_patient_id)[90m[39;49;00m
[1m[31mapp/infrastructure/ml/digital_twin_integration_service.py[0m:348: in _get_patient_data
    [0mpatient_data = [94mawait[39;49;00m [96mself[39;49;00m.patient_repository.get_by_id(patient_id)[90m[39;49;00m
[1m[31mE   AttributeError: 'DigitalTwinIntegrationService' object has no attribute 'patient_repository'[0m
[31m[1m_ TestDigitalTwinIntegrationService.test_get_patient_data_handles_missing_patient _[0m
[1m[31mapp/tests/unit/infrastructure/ml/test_digital_twin_integration_service.py[0m:399: in test_get_patient_data_handles_missing_patient
    [0m[94mawait[39;49;00m integration_service._get_patient_data(sample_patient_id)[90m[39;49;00m
[1m[31mapp/infrastructure/ml/digital_twin_integration_service.py[0m:348: in _get_patient_data
    [0mpatient_data = [94mawait[39;49;00m [96mself[39;49;00m.patient_repository.get_by_id(patient_id)[90m[39;49;00m
[1m[31mE   AttributeError: 'DigitalTwinIntegrationService' object has no attribute 'patient_repository'[0m
[31m[1m__________ TestUserModelValidation.test_domain_to_persistence_mapping __________[0m
[1m[31mapp/tests/unit/infrastructure/persistence/sqlalchemy/models/test_model_validation.py[0m:46: in test_domain_to_persistence_mapping
    [0m[94massert[39;49;00m persistence_model.hashed_password == domain_user.hashed_password[90m[39;49;00m
[1m[31mE   AttributeError: 'User' object has no attribute 'hashed_password'[0m
[31m[1m__________ TestUserModelValidation.test_persistence_to_domain_mapping __________[0m
[1m[31mapp/tests/unit/infrastructure/persistence/sqlalchemy/models/test_model_validation.py[0m:53: in test_persistence_to_domain_mapping
    [0mpersistence_model = UserModel([90m[39;49;00m
[1m[31m<string>[0m:4: in __init__
    [0m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[04m[91m?[39;49;00m[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/state.py[0m:571: in _initialize_instance
    [0m[94mwith[39;49;00m util.safe_reraise():[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/util/langhelpers.py[0m:146: in __exit__
    [0m[94mraise[39;49;00m exc_value.with_traceback(exc_tb)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/state.py[0m:569: in _initialize_instance
    [0mmanager.original_init(*mixed[[94m1[39;49;00m:], **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/sqlalchemy/orm/decl_base.py[0m:2167: in _declarative_constructor
    [0m[94mraise[39;49;00m [96mTypeError[39;49;00m([90m[39;49;00m
[1m[31mE   TypeError: 'hashed_password' is an invalid keyword argument for User[0m
[31m[1m__________ TestSQLAlchemyBiometricAlertRepository.test_save_new_alert __________[0m
[1m[31mapp/tests/unit/infrastructure/persistence/sqlalchemy/repositories/test_biometric_alert_repository_infra.py[0m:253: in test_save_new_alert
    [0m[94mwith[39;49;00m patch.object(SQLAlchemyBiometricAlertRepository, [33m'[39;49;00m[33m_map_to_model[39;49;00m[33m'[39;49;00m) [94mas[39;49;00m mock_map_to_model, \
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1467: in __enter__
    [0moriginal, local = [96mself[39;49;00m.get_original()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1437: in get_original
    [0m[94mraise[39;49;00m [96mAttributeError[39;49;00m([90m[39;49;00m
[1m[31mE   AttributeError: <class 'app.tests.unit.infrastructure.persistence.sqlalchemy.repositories.test_biometric_alert_repository_infra.SQLAlchemyBiometricAlertRepository'> does not have the attribute '_map_to_model'[0m
[31m[1m_________ TestSQLAlchemyBiometricAlertRepository.test_get_alert_by_id __________[0m
[1m[31mapp/tests/unit/infrastructure/persistence/sqlalchemy/repositories/test_biometric_alert_repository_infra.py[0m:297: in test_get_alert_by_id
    [0m[94mwith[39;49;00m patch.object(SQLAlchemyBiometricAlertRepository, [33m'[39;49;00m[33m_map_to_entity[39;49;00m[33m'[39;49;00m) [94mas[39;49;00m mock_map_to_entity:[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1467: in __enter__
    [0moriginal, local = [96mself[39;49;00m.get_original()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1437: in get_original
    [0m[94mraise[39;49;00m [96mAttributeError[39;49;00m([90m[39;49;00m
[1m[31mE   AttributeError: <class 'app.tests.unit.infrastructure.persistence.sqlalchemy.repositories.test_biometric_alert_repository_infra.SQLAlchemyBiometricAlertRepository'> does not have the attribute '_map_to_entity'[0m
[31m[1m____ TestSQLAlchemyBiometricAlertRepository.test_get_alert_by_id_not_found _____[0m
[1m[31mapp/tests/unit/infrastructure/persistence/sqlalchemy/repositories/test_biometric_alert_repository_infra.py[0m:321: in test_get_alert_by_id_not_found
    [0m[94mwith[39;49;00m pytest.raises(EntityNotFoundError):[90m[39;49;00m
[1m[31mE   Failed: DID NOT RAISE <class 'app.tests.unit.infrastructure.persistence.sqlalchemy.repositories.test_biometric_alert_repository_infra.EntityNotFoundError'>[0m
[31m[1m______ TestSQLAlchemyBiometricAlertRepository.test_get_alerts_for_patient ______[0m
[1m[31mapp/tests/unit/infrastructure/persistence/sqlalchemy/repositories/test_biometric_alert_repository_infra.py[0m:338: in test_get_alerts_for_patient
    [0m[94mwith[39;49;00m patch.object(SQLAlchemyBiometricAlertRepository, [33m'[39;49;00m[33m_map_to_entity[39;49;00m[33m'[39;49;00m) [94mas[39;49;00m mock_map_to_entity:[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1467: in __enter__
    [0moriginal, local = [96mself[39;49;00m.get_original()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1437: in get_original
    [0m[94mraise[39;49;00m [96mAttributeError[39;49;00m([90m[39;49;00m
[1m[31mE   AttributeError: <class 'app.tests.unit.infrastructure.persistence.sqlalchemy.repositories.test_biometric_alert_repository_infra.SQLAlchemyBiometricAlertRepository'> does not have the attribute '_map_to_entity'[0m
[31m[1m_________________ TestAuthMiddleware.test_valid_authentication _________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_auth_middleware_unit.py[0m:253: in test_valid_authentication
    [0m[94massert[39;49;00m response.status_code == [94m200[39;49;00m[90m[39;49;00m
[1m[31mE   assert 500 == 200[0m
[1m[31mE    +  where 500 = <starlette.responses.JSONResponse object at 0x30a53c380>.status_code[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:56] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/redoc', '/docs', '/']
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:56] [ERROR] [app.presentation.middleware.authentication_middleware] - Unexpected internal error during authentication for path /api/patients: 'function' object has no attribute 'verify_token'
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 295, in dispatch
    user = await self.validate_token_and_get_user(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 237, in validate_token_and_get_user
    token_payload = await self._jwt_service_instance.verify_token(token)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'function' object has no attribute 'verify_token'
[31m[1m____________________ TestAuthMiddleware.test_invalid_token _____________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_auth_middleware_unit.py[0m:295: in test_invalid_token
    [0m[94massert[39;49;00m response.status_code == status.HTTP_401_UNAUTHORIZED[90m[39;49;00m
[1m[31mE   assert 500 == 401[0m
[1m[31mE    +  where 500 = <starlette.responses.JSONResponse object at 0x30a5c9e20>.status_code[0m
[1m[31mE    +  and   401 = status.HTTP_401_UNAUTHORIZED[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:56] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/redoc', '/docs', '/']
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:56] [ERROR] [app.presentation.middleware.authentication_middleware] - Unexpected internal error during authentication for path /api/patients: 'function' object has no attribute 'verify_token'
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 295, in dispatch
    user = await self.validate_token_and_get_user(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 237, in validate_token_and_get_user
    token_payload = await self._jwt_service_instance.verify_token(token)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'function' object has no attribute 'verify_token'
[31m[1m____________________ TestAuthMiddleware.test_expired_token _____________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_auth_middleware_unit.py[0m:317: in test_expired_token
    [0m[94massert[39;49;00m response.status_code == status.HTTP_401_UNAUTHORIZED[90m[39;49;00m
[1m[31mE   assert 500 == 401[0m
[1m[31mE    +  where 500 = <starlette.responses.JSONResponse object at 0x3040356d0>.status_code[0m
[1m[31mE    +  and   401 = status.HTTP_401_UNAUTHORIZED[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:56] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/redoc', '/docs', '/']
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:56] [ERROR] [app.presentation.middleware.authentication_middleware] - Unexpected internal error during authentication for path /api/patients: 'function' object has no attribute 'verify_token'
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 295, in dispatch
    user = await self.validate_token_and_get_user(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 237, in validate_token_and_get_user
    token_payload = await self._jwt_service_instance.verify_token(token)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'function' object has no attribute 'verify_token'
[31m[1m__________ TestAuthMiddleware.test_authentication_with_roles_success ___________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_auth_middleware_unit.py[0m:379: in test_authentication_with_roles_success
    [0m[94massert[39;49;00m response.status_code == [94m200[39;49;00m[90m[39;49;00m
[1m[31mE   assert 500 == 200[0m
[1m[31mE    +  where 500 = <starlette.responses.JSONResponse object at 0x30a56f0b0>.status_code[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:56] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/redoc', '/docs', '/']
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:56] [ERROR] [app.presentation.middleware.authentication_middleware] - Unexpected internal error during authentication for path /api/patients: 'function' object has no attribute 'verify_token'
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 295, in dispatch
    user = await self.validate_token_and_get_user(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 237, in validate_token_and_get_user
    token_payload = await self._jwt_service_instance.verify_token(token)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'function' object has no attribute 'verify_token'
[31m[1m_________ TestAuthMiddleware.test_inactive_user_authentication_failure _________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_auth_middleware_unit.py[0m:408: in test_inactive_user_authentication_failure
    [0m[94massert[39;49;00m response.status_code == status.HTTP_403_FORBIDDEN [90m# Specific code for inactive[39;49;00m[90m[39;49;00m
[1m[31mE   assert 500 == 403[0m
[1m[31mE    +  where 500 = <starlette.responses.JSONResponse object at 0x30a541df0>.status_code[0m
[1m[31mE    +  and   403 = status.HTTP_403_FORBIDDEN[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:56] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/redoc', '/docs', '/']
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:56] [ERROR] [app.presentation.middleware.authentication_middleware] - Unexpected internal error during authentication for path /api/patients: 'function' object has no attribute 'verify_token'
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 295, in dispatch
    user = await self.validate_token_and_get_user(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 237, in validate_token_and_get_user
    token_payload = await self._jwt_service_instance.verify_token(token)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'function' object has no attribute 'verify_token'
[31m[1m________ TestAuthMiddleware.test_user_not_found_authentication_failure _________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_auth_middleware_unit.py[0m:435: in test_user_not_found_authentication_failure
    [0m[94massert[39;49;00m response.status_code == status.HTTP_401_UNAUTHORIZED [90m# Standard unauthorized[39;49;00m[90m[39;49;00m
[1m[31mE   assert 500 == 401[0m
[1m[31mE    +  where 500 = <starlette.responses.JSONResponse object at 0x30a540e00>.status_code[0m
[1m[31mE    +  and   401 = status.HTTP_401_UNAUTHORIZED[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:56] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/redoc', '/docs', '/']
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:56] [ERROR] [app.presentation.middleware.authentication_middleware] - Unexpected internal error during authentication for path /api/patients: 'function' object has no attribute 'verify_token'
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 295, in dispatch
    user = await self.validate_token_and_get_user(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 237, in validate_token_and_get_user
    token_payload = await self._jwt_service_instance.verify_token(token)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'function' object has no attribute 'verify_token'
[31m[1m________________ TestAuthMiddleware.test_token_parsing_failure _________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_auth_middleware_unit.py[0m:461: in test_token_parsing_failure
    [0m[94massert[39;49;00m response.status_code == status.HTTP_401_UNAUTHORIZED[90m[39;49;00m
[1m[31mE   assert 500 == 401[0m
[1m[31mE    +  where 500 = <starlette.responses.JSONResponse object at 0x3046a2db0>.status_code[0m
[1m[31mE    +  and   401 = status.HTTP_401_UNAUTHORIZED[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:56] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/redoc', '/docs', '/']
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:56] [ERROR] [app.presentation.middleware.authentication_middleware] - Unexpected internal error during authentication for path /api/patients: 'function' object has no attribute 'verify_token'
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 295, in dispatch
    user = await self.validate_token_and_get_user(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 237, in validate_token_and_get_user
    token_payload = await self._jwt_service_instance.verify_token(token)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'function' object has no attribute 'verify_token'
[31m[1m______________ TestAuthMiddleware.test_unexpected_error_handling _______________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:2362: in assert_awaited_once_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected verify_token to have been awaited once. Awaited 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/infrastructure/security/test_auth_middleware_unit.py[0m:493: in test_unexpected_error_handling
    [0mmock_jwt_service.verify_token.assert_awaited_once_with([33m"[39;49;00m[33muser_auth_error_user[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: Expected verify_token to have been awaited once. Awaited 0 times.[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:56] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/openapi.json', '/health', '/redoc', '/docs', '/']
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:56] [ERROR] [app.presentation.middleware.authentication_middleware] - Unexpected internal error during authentication for path /api/patients: 'function' object has no attribute 'verify_token'
Traceback (most recent call last):
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 295, in dispatch
    user = await self.validate_token_and_get_user(token)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 237, in validate_token_and_get_user
    token_payload = await self._jwt_service_instance.verify_token(token)
                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'function' object has no attribute 'verify_token'
[31m[1m________________ TestEncryptionUtils.test_decrypt_invalid_token ________________[0m
[1m[31mapp/infrastructure/security/encryption/base_encryption_service.py[0m:276: in decrypt
    [0mdecrypted_bytes = [96mself[39;49;00m.cipher.decrypt(encrypted_data)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/cryptography/fernet.py[0m:84: in decrypt
    [0mtimestamp, data = Fernet._get_unverified_token_data(token)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/cryptography/fernet.py[0m:118: in _get_unverified_token_data
    [0m[94mraise[39;49;00m InvalidToken[90m[39;49;00m
[1m[31mE   cryptography.fernet.InvalidToken[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/infrastructure/security/encryption/base_encryption_service.py[0m:283: in decrypt
    [0mdecrypted_bytes = prev_cipher.decrypt(encrypted_data)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/cryptography/fernet.py[0m:84: in decrypt
    [0mtimestamp, data = Fernet._get_unverified_token_data(token)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/cryptography/fernet.py[0m:118: in _get_unverified_token_data
    [0m[94mraise[39;49;00m InvalidToken[90m[39;49;00m
[1m[31mE   cryptography.fernet.InvalidToken[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/infrastructure/security/test_encryption_enhanced.py[0m:71: in test_decrypt_invalid_token
    [0mencryption_service.decrypt(invalid_encrypted_data) [90m# Use service method[39;49;00m[90m[39;49;00m
[1m[31mapp/infrastructure/security/encryption/base_encryption_service.py[0m:287: in decrypt
    [0m[94mraise[39;49;00m [96mValueError[39;49;00m([33m"[39;49;00m[33mInvalid Token: Decryption failed with all available keys.[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   ValueError: Invalid Token: Decryption failed with all available keys.[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:56] [WARNING] [app.infrastructure.security.encryption.base_encryption_service] - Raw key material is more than 32 bytes, truncating.
[2025-05-02 21:52:56] [ERROR] [app.infrastructure.security.encryption.base_encryption_service] - Decryption failed with both primary and previous keys.
[31m[1m___________ TestEnhancedEncryptionService.test_encrypt_decrypt_dict ____________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_encryption_enhanced.py[0m:168: in test_encrypt_decrypt_dict
    [0m[94massert[39;49;00m [96misinstance[39;49;00m(encrypted[[33m"[39;49;00m[33maddress[39;49;00m[33m"[39;49;00m][[33m"[39;49;00m[33mstreet[39;49;00m[33m"[39;49;00m], [96mstr[39;49;00m) [95mand[39;49;00m encrypted[[33m"[39;49;00m[33maddress[39;49;00m[33m"[39;49;00m][[33m"[39;49;00m[33mstreet[39;49;00m[33m"[39;49;00m].startswith([33m"[39;49;00m[33mv1:[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: assert (True and False)[0m
[1m[31mE    +  where True = isinstance('123 Main St', str)[0m
[1m[31mE    +  and   False = <built-in method startswith of str object at 0x167dadff0>('v1:')[0m
[1m[31mE    +    where <built-in method startswith of str object at 0x167dadff0> = '123 Main St'.startswith[0m
[31m[1m_______________ TestEnhancedEncryptionService.test_key_rotation ________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_encryption_enhanced.py[0m:202: in test_key_rotation
    [0m[94mwith[39;49;00m patch([33m"[39;49;00m[33mapp.infrastructure.security.encryption.get_settings[39;49;00m[33m"[39;49;00m, return_value=MagicMock(ENCRYPTION_KEY=original_key.decode(), ENCRYPTION_SALT=original_salt.hex())):[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1467: in __enter__
    [0moriginal, local = [96mself[39;49;00m.get_original()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:1437: in get_original
    [0m[94mraise[39;49;00m [96mAttributeError[39;49;00m([90m[39;49;00m
[1m[31mE   AttributeError: <module 'app.infrastructure.security.encryption' from '/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/security/encryption/__init__.py'> does not have the attribute 'get_settings'[0m
[31m[1m______________ TestEnhancedEncryptionService.test_file_encryption ______________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_encryption_enhanced.py[0m:252: in test_file_encryption
    [0mencryption_service.encrypt_file([96mstr[39;49;00m(test_file), [96mstr[39;49;00m(encrypted_file))[90m[39;49;00m
[1m[31mE   AttributeError: 'BaseEncryptionService' object has no attribute 'encrypt_file'. Did you mean: 'encrypt_field'?[0m
[31m[1m_________ TestEnhancedEncryptionService.test_encrypt_file_nonexistent __________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_encryption_enhanced.py[0m:276: in test_encrypt_file_nonexistent
    [0mencryption_service.encrypt_file([96mstr[39;49;00m(nonexistent_file), [96mstr[39;49;00m(output_file))[90m[39;49;00m
[1m[31mE   AttributeError: 'BaseEncryptionService' object has no attribute 'encrypt_file'. Did you mean: 'encrypt_field'?[0m
[31m[1m_________ TestEnhancedEncryptionService.test_decrypt_file_nonexistent __________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_encryption_enhanced.py[0m:286: in test_decrypt_file_nonexistent
    [0mencryption_service.decrypt_file([96mstr[39;49;00m(nonexistent_file), [96mstr[39;49;00m(output_file))[90m[39;49;00m
[1m[31mE   AttributeError: 'BaseEncryptionService' object has no attribute 'decrypt_file'. Did you mean: 'decrypt_field'?[0m
[31m[1m_______ TestEnhancedEncryptionService.test_decrypt_invalid_file_content ________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_encryption_enhanced.py[0m:298: in test_decrypt_invalid_file_content
    [0mencryption_service.decrypt_file([96mstr[39;49;00m(invalid_encrypted_file), [96mstr[39;49;00m(output_file))[90m[39;49;00m
[1m[31mE   AttributeError: 'BaseEncryptionService' object has no attribute 'decrypt_file'. Did you mean: 'decrypt_field'?[0m
[31m[1m__________________ TestJWTService.test_decode_malformed_token __________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_jwt_handler.py[0m:168: in test_decode_malformed_token
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mNot enough segments[39;49;00m[33m"[39;49;00m [95min[39;49;00m [96mstr[39;49;00m(exc_info.value)[90m[39;49;00m
[1m[31mE   assert 'Not enough segments' in "Invalid token: Invalid header string: 'utf-8' codec can't decode byte 0x8a in position 0: invalid start byte"[0m
[1m[31mE    +  where "Invalid token: Invalid header string: 'utf-8' codec can't decode byte 0x8a in position 0: invalid start byte" = str(InvalidTokenException("Invalid token: Invalid header string: 'utf-8' codec can't decode byte 0x8a in position 0: invalid start byte"))[0m
[1m[31mE    +    where InvalidTokenException("Invalid token: Invalid header string: 'utf-8' codec can't decode byte 0x8a in position 0: invalid start byte") = <ExceptionInfo InvalidTokenException("Invalid token: Invalid header string: 'utf-8' codec can't decode byte 0x8a in position 0: invalid start byte") tblen=2>.value[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:57] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:57] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Invalid header string: 'utf-8' codec can't decode byte 0x8a in position 0: invalid start byte
[31m[1m___________ TestJWTService.test_decode_token_missing_required_claims ___________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_jwt_handler.py[0m:199: in test_decode_token_missing_required_claims
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mvalidation error[39;49;00m[33m"[39;49;00m [95min[39;49;00m [96mstr[39;49;00m(exc_info.value).lower() [95mor[39;49;00m [33m"[39;49;00m[33mmissing field[39;49;00m[33m"[39;49;00m [95min[39;49;00m [96mstr[39;49;00m(exc_info.value).lower()[90m[39;49;00m
[1m[31mE   AssertionError: assert ('validation error' in 'invalid token: invalid issuer' or 'missing field' in 'invalid token: invalid issuer')[0m
[1m[31mE    +  where 'invalid token: invalid issuer' = <built-in method lower of str object at 0x3041a4d50>()[0m
[1m[31mE    +    where <built-in method lower of str object at 0x3041a4d50> = 'Invalid token: Invalid issuer'.lower[0m
[1m[31mE    +      where 'Invalid token: Invalid issuer' = str(InvalidTokenException('Invalid token: Invalid issuer'))[0m
[1m[31mE    +        where InvalidTokenException('Invalid token: Invalid issuer') = <ExceptionInfo InvalidTokenException('Invalid token: Invalid issuer') tblen=2>.value[0m
[1m[31mE    +  and   'invalid token: invalid issuer' = <built-in method lower of str object at 0x3041a4d50>()[0m
[1m[31mE    +    where <built-in method lower of str object at 0x3041a4d50> = 'Invalid token: Invalid issuer'.lower[0m
[1m[31mE    +      where 'Invalid token: Invalid issuer' = str(InvalidTokenException('Invalid token: Invalid issuer'))[0m
[1m[31mE    +        where InvalidTokenException('Invalid token: Invalid issuer') = <ExceptionInfo InvalidTokenException('Invalid token: Invalid issuer') tblen=2>.value[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:57] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:57] [WARNING] [app.infrastructure.security.jwt.jwt_service] - JWT decoding error: Invalid issuer
[31m[1m___________________ TestJWTService.test_create_access_token ____________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_jwt_service_enhanced.py[0m:109: in test_create_access_token
    [0m[94massert[39;49;00m [94m29[39;49;00m * [94m60[39;49;00m <= time_diff <= [94m31[39;49;00m * [94m60[39;49;00m[90m[39;49;00m
[1m[31mE   assert (29 * 60) <= 899.8313059806824[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:57] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[31m[1m____________________ TestJWTService.test_verify_token_valid ____________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_jwt_service_enhanced.py[0m:152: in test_verify_token_valid
    [0mpayload = [94mawait[39;49;00m jwt_service.verify_token(token)[90m[39;49;00m
[1m[31mE   AttributeError: 'JWTService' object has no attribute 'verify_token'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:57] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[31m[1m___________________ TestJWTService.test_verify_token_expired ___________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_jwt_service_enhanced.py[0m:170: in test_verify_token_expired
    [0m[94mawait[39;49;00m jwt_service.verify_token(expired_token)[90m[39;49;00m
[1m[31mE   AttributeError: 'JWTService' object has no attribute 'verify_token'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:57] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[31m[1m______________ TestJWTService.test_verify_token_invalid_signature ______________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_jwt_service_enhanced.py[0m:187: in test_verify_token_invalid_signature
    [0m[94mawait[39;49;00m jwt_service.verify_token(tampered_token)[90m[39;49;00m
[1m[31mE   AttributeError: 'JWTService' object has no attribute 'verify_token'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:57] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[31m[1m__________________ TestJWTService.test_verify_token_malformed __________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_jwt_service_enhanced.py[0m:234: in test_verify_token_malformed
    [0m[94mawait[39;49;00m jwt_service.verify_token(malformed_token)[90m[39;49;00m
[1m[31mE   AttributeError: 'JWTService' object has no attribute 'verify_token'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:57] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[31m[1m___________________ TestJWTService.test_refresh_access_token ___________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_jwt_service_enhanced.py[0m:243: in test_refresh_access_token
    [0mnew_access_token = [94mawait[39;49;00m jwt_service.refresh_access_token(refresh_token)[90m[39;49;00m
[1m[31mE   AttributeError: 'JWTService' object has no attribute 'refresh_access_token'. Did you mean: 'create_access_token'?[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:57] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[31m[1m_______ TestJWTService.test_refresh_access_token_with_non_refresh_token ________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_jwt_service_enhanced.py[0m:262: in test_refresh_access_token_with_non_refresh_token
    [0m[94mawait[39;49;00m jwt_service.refresh_access_token(access_token)[90m[39;49;00m
[1m[31mE   AttributeError: 'JWTService' object has no attribute 'refresh_access_token'. Did you mean: 'create_access_token'?[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:57] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[31m[1m____________________ TestJWTService.test_get_token_identity ____________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_jwt_service_enhanced.py[0m:272: in test_get_token_identity
    [0midentity = [94mawait[39;49;00m jwt_service.get_token_identity(token)[90m[39;49;00m
[1m[31mE   AttributeError: 'JWTService' object has no attribute 'get_token_identity'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:57] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[31m[1m______________ TestJWTService.test_get_token_identity_missing_sub ______________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_jwt_service_enhanced.py[0m:295: in test_get_token_identity_missing_sub
    [0m[94mawait[39;49;00m jwt_service.get_token_identity(token)[90m[39;49;00m
[1m[31mE   AttributeError: 'JWTService' object has no attribute 'get_token_identity'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:52:57] [INFO] [app.infrastructure.security.jwt.jwt_service] - JWT service initialized with algorithm HS256
[31m[1m________________________ TestMFAService.test_setup_totp ________________________[0m
[1m[31mapp/infrastructure/security/auth/mfa_service.py[0m:174: in setup_totp
    [0mprovisioning_uri = totp.provisioning_uri([90m[39;49;00m
[1m[31mE   AttributeError: 'types.SimpleNamespace' object has no attribute 'provisioning_uri'[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/infrastructure/security/test_mfa_service.py[0m:66: in test_setup_totp
    [0mresult = mfa_service.setup_totp([33m"[39;49;00m[33muser123[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mtest@example.com[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mapp/infrastructure/security/auth/mfa_service.py[0m:207: in setup_totp
    [0m[94mraise[39;49;00m MFASetupException([33mf[39;49;00m[33m"[39;49;00m[33mFailed to set up TOTP: [39;49;00m[33m{[39;49;00m[96mstr[39;49;00m(e)[33m}[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   app.infrastructure.security.auth.mfa_service.MFASetupException: Failed to set up TOTP: 'types.SimpleNamespace' object has no attribute 'provisioning_uri'[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:52:57] [ERROR] [app.infrastructure.security.auth.mfa_service] - Error setting up TOTP for user: 'types.SimpleNamespace' object has no attribute 'provisioning_uri'
[31m[1m____________________ TestMFAService.test_verify_totp_valid _____________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:960: in assert_called_once_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'TOTP' to be called once. Called 0 times.[0m
[1m[31mE   Calls: [call().verify('123456')].[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/infrastructure/security/test_mfa_service.py[0m:88: in test_verify_totp_valid
    [0mmock_totp.assert_called_once_with(secret_key, digits=[94m6[39;49;00m, interval=[94m30[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'TOTP' to be called once. Called 0 times.[0m
[1m[31mE   Calls: [call().verify('123456')].[0m
[31m[1m___________________ TestMFAService.test_verify_totp_invalid ____________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:960: in assert_called_once_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'TOTP' to be called once. Called 0 times.[0m
[1m[31mE   Calls: [call().verify('654321')].[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/infrastructure/security/test_mfa_service.py[0m:100: in test_verify_totp_invalid
    [0mmock_totp.assert_called_once_with(secret_key, digits=[94m6[39;49;00m, interval=[94m30[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'TOTP' to be called once. Called 0 times.[0m
[1m[31mE   Calls: [call().verify('654321')].[0m
[31m[1m_____________________ TestMFAService.test_get_backup_codes _____________________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_mfa_service.py[0m:165: in test_get_backup_codes
    [0m[94massert[39;49;00m codes == [[33m"[39;49;00m[33mABCDEF1234[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33m1234ABCDEF[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33mFEDCBA4321[39;49;00m[33m"[39;49;00m][90m[39;49;00m
[1m[31mE   AssertionError: assert ['<MAGICMOCK'... '<MAGICMOCK'] == ['ABCDEF1234'... 'FEDCBA4321'][0m
[1m[31mE     [0m
[1m[31mE     At index 0 diff: [0m[33m'[39;49;00m[33m<MAGICMOCK[39;49;00m[33m'[39;49;00m[90m[39;49;00m != [0m[33m'[39;49;00m[33mABCDEF1234[39;49;00m[33m'[39;49;00m[90m[39;49;00m[0m
[1m[31mE     Use -v to get more diff[0m
[31m[1m_____________ TestPasswordHashing.test_verify_handles_none_values ______________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_password_handler.py[0m:69: in test_verify_handles_none_values
    [0m[94massert[39;49;00m verify_password([94mNone[39;49;00m, [33m"[39;49;00m[33msomehash[39;49;00m[33m"[39;49;00m) [95mis[39;49;00m [94mFalse[39;49;00m[90m[39;49;00m
[1m[31mapp/infrastructure/security/password/hashing.py[0m:26: in verify_password
    [0m[94mreturn[39;49;00m pwd_context.verify(plain_password, hashed_password)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/passlib/context.py[0m:2343: in verify
    [0mrecord = [96mself[39;49;00m._get_or_identify_record([96mhash[39;49;00m, scheme, category)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/passlib/context.py[0m:2031: in _get_or_identify_record
    [0m[94mreturn[39;49;00m [96mself[39;49;00m._identify_record([96mhash[39;49;00m, category)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/passlib/context.py[0m:1132: in identify_record
    [0m[94mraise[39;49;00m exc.UnknownHashError([33m"[39;49;00m[33mhash could not be identified[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   passlib.exc.UnknownHashError: hash could not be identified[0m
[31m[1m______________ TestPasswordStrengthValidation.test_short_password ______________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_password_handler.py[0m:100: in test_short_password
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mlength[39;49;00m[33m"[39;49;00m [95min[39;49;00m message.lower()[90m[39;49;00m
[1m[31mE   AssertionError: assert 'length' in 'password must be at least 12 characters long'[0m
[1m[31mE    +  where 'password must be at least 12 characters long' = <built-in method lower of str object at 0x13037c690>()[0m
[1m[31mE    +    where <built-in method lower of str object at 0x13037c690> = 'Password must be at least 12 characters long'.lower[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:00] [INFO] [app.infrastructure.security.password.password_handler] - PasswordHandler initialized with schemes: ['bcrypt']
[31m[1m_______ TestPasswordStrengthValidation.test_password_without_complexity ________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_password_handler.py[0m:114: in test_password_without_complexity
    [0m[94massert[39;49;00m expected_msg_part [95min[39;49;00m message.lower(), [33mf[39;49;00m[33m"[39;49;00m[33mFeedback for [39;49;00m[33m'[39;49;00m[33m{[39;49;00mpwd[33m}[39;49;00m[33m'[39;49;00m[33m should mention [39;49;00m[33m{[39;49;00mexpected_msg_part[33m}[39;49;00m[33m"[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError: Feedback for 'NoUpper123!' should mention uppercase[0m
[1m[31mE   assert 'uppercase' in 'password must be at least 12 characters long'[0m
[1m[31mE    +  where 'password must be at least 12 characters long' = <built-in method lower of str object at 0x13037c690>()[0m
[1m[31mE    +    where <built-in method lower of str object at 0x13037c690> = 'Password must be at least 12 characters long'.lower[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:00] [INFO] [app.infrastructure.security.password.password_handler] - PasswordHandler initialized with schemes: ['bcrypt']
[31m[1m_____________ TestPasswordStrengthValidation.test_common_password ______________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_password_handler.py[0m:127: in test_common_password
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mcommon[39;49;00m[33m"[39;49;00m [95min[39;49;00m message.lower()[90m[39;49;00m
[1m[31mE   AssertionError: assert 'common' in 'password must be at least 12 characters long'[0m
[1m[31mE    +  where 'password must be at least 12 characters long' = <built-in method lower of str object at 0x13037c690>()[0m
[1m[31mE    +    where <built-in method lower of str object at 0x13037c690> = 'Password must be at least 12 characters long'.lower[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:00] [INFO] [app.infrastructure.security.password.password_handler] - PasswordHandler initialized with schemes: ['bcrypt']
[31m[1m___________ TestPasswordStrengthValidation.test_repeated_characters ____________[0m
[1m[31mapp/tests/unit/infrastructure/security/test_password_handler.py[0m:135: in test_repeated_characters
    [0m[94massert[39;49;00m [33m"[39;49;00m[33mrepeat[39;49;00m[33m"[39;49;00m [95min[39;49;00m message.lower()[90m[39;49;00m
[1m[31mE   AssertionError: assert 'repeat' in 'password must be at least 12 characters long'[0m
[1m[31mE    +  where 'password must be at least 12 characters long' = <built-in method lower of str object at 0x13037c690>()[0m
[1m[31mE    +    where <built-in method lower of str object at 0x13037c690> = 'Password must be at least 12 characters long'.lower[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:00] [INFO] [app.infrastructure.security.password.password_handler] - PasswordHandler initialized with schemes: ['bcrypt']
[31m[1m________________ TestRateLimitFactoryFunctions.test_rate_limit _________________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:960: in assert_called_once_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'RateLimitDependency' to be called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/presentation/api/dependencies/test_rate_limiter_deps.py[0m:256: in test_rate_limit
    [0mmock_dependency_class.assert_called_once_with(requests=[94m20[39;49;00m, window_seconds=[94m40[39;49;00m, block_seconds=[94m60[39;49;00m, scope_key=[33m"[39;49;00m[33mtest[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'RateLimitDependency' to be called once. Called 0 times.[0m
[31m[1m___________ TestRateLimitFactoryFunctions.test_sensitive_rate_limit ____________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:960: in assert_called_once_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'RateLimitDependency' to be called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/presentation/api/dependencies/test_rate_limiter_deps.py[0m:268: in test_sensitive_rate_limit
    [0mmock_dependency_class.assert_called_once_with(requests=[94m5[39;49;00m, window_seconds=[94m60[39;49;00m, block_seconds=[94m300[39;49;00m, error_message=[33m"[39;49;00m[33mToo many attempts. Please try again later.[39;49;00m[33m"[39;49;00m, scope_key=[33m"[39;49;00m[33mcustom[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'RateLimitDependency' to be called once. Called 0 times.[0m
[31m[1m_____________ TestRateLimitFactoryFunctions.test_admin_rate_limit ______________[0m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py[0m:960: in assert_called_once_with
    [0m[94mraise[39;49;00m [96mAssertionError[39;49;00m(msg)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'RateLimitDependency' to be called once. Called 0 times.[0m

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/presentation/api/dependencies/test_rate_limiter_deps.py[0m:280: in test_admin_rate_limit
    [0mmock_dependency_class.assert_called_once_with(requests=[94m100[39;49;00m, window_seconds=[94m60[39;49;00m, block_seconds=[94mNone[39;49;00m, scope_key=[33m"[39;49;00m[33madmin[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: Expected 'RateLimitDependency' to be called once. Called 0 times.[0m
[31m[1m______________ TestAnalyticsEndpoints.test_record_analytics_event ______________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/presentation/api/v1/endpoints/test_analytics_endpoints.py", line 135, in test_record_analytics_event
    |     response = client.post("/analytics/events", json=event_data, headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 633, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1145, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_analytics_endpoints.py[0m:135: in test_record_analytics_event
    [0mresponse = client.post([33m"[39;49;00m[33m/analytics/events[39;49;00m[33m"[39;49;00m, json=event_data, headers=auth_headers)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:633: in post
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1145: in post
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:00] [INFO] [app.presentation.middleware.security_headers_middleware] - SecurityHeadersMiddleware initialized
[2025-05-02 21:53:00] [INFO] [app.presentation.middleware.logging_middleware] - LoggingMiddleware initialized. Excluded paths: ['/metrics', '/health', '/favicon.ico'], Log request body: False, Log response body: False
[2025-05-02 21:53:00] [INFO] [app.presentation.middleware.authentication_middleware] - AuthenticationMiddleware initialized. Public paths: ['/api/0.1.0/docs', '/openapi.json', '/health', '/redoc', '/docs', '/', '/api/0.1.0/auth/login', '/api/0.1.0/auth/register', '/api/0.1.0/auth/refresh', '/api/0.1.0/redoc', '/api/0.1.0/openapi.json']
[31m[1m______________ TestAnalyticsEndpoints.test_record_analytics_batch ______________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/presentation/api/v1/endpoints/test_analytics_endpoints.py", line 195, in test_record_analytics_batch
    |     response = client.post("/analytics/events/batch", json=batch_data, headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 633, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1145, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_analytics_endpoints.py[0m:195: in test_record_analytics_batch
    [0mresponse = client.post([33m"[39;49;00m[33m/analytics/events/batch[39;49;00m[33m"[39;49;00m, json=batch_data, headers=auth_headers)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:633: in post
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1145: in post
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
[31m[1m_________ TestAnalyticsEndpoints.test_phi_detection_in_analytics_event _________[0m
  + Exception Group Traceback (most recent call last):
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 87, in collapse_excgroups
  |     yield
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 190, in __call__
  |     async with anyio.create_task_group() as task_group:
  |                ^^^^^^^^^^^^^^^^^^^^^^^^^
  |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py", line 772, in __aexit__
  |     raise BaseExceptionGroup(
  | ExceptionGroup: unhandled errors in a TaskGroup (1 sub-exception)
  +-+---------------- 1 ----------------
    | Traceback (most recent call last):
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    |     result: Optional[TResult] = func()
    |                                 ^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 241, in <lambda>
    |     lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 87, in pytest_runtest_call
    |     yield from thread_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/threadexception.py", line 63, in thread_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 90, in pytest_runtest_call
    |     yield from unraisable_exception_runtest_hook()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 65, in unraisable_exception_runtest_hook
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 850, in pytest_runtest_call
    |     yield from self._runtest_for(item, "call")
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/logging.py", line 833, in _runtest_for
    |     yield
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/capture.py", line 878, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 167, in _multicall
    |     teardown.throw(outcome._exception)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    |     return (yield)
    |             ^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 183, in pytest_runtest_call
    |     raise e
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/runner.py", line 173, in pytest_runtest_call
    |     item.runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 436, in runtest
    |     super().runtest()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 1632, in runtest
    |     self.ihook.pytest_pyfunc_call(pyfuncitem=self)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    |     return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    |     return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    |     return outcome.get_result()
    |            ^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    |     raise exc.with_traceback(exc.__traceback__)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    |     res = hook_impl.function(*args)
    |           ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/python.py", line 162, in pytest_pyfunc_call
    |     result = testfunction(**testargs)
    |              ^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 902, in inner
    |     _loop.run_until_complete(task)
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/asyncio/base_events.py", line 691, in run_until_complete
    |     return future.result()
    |            ^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/presentation/api/v1/endpoints/test_analytics_endpoints.py", line 252, in test_phi_detection_in_analytics_event
    |     response = client.post("/analytics/events", json=event_data_with_phi, headers=auth_headers)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/api/v1/endpoints/digital_twins.py", line 121, in _patched
    |     resp = original(self, *args, **kwargs)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 633, in post
    |     return super().post(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1145, in post
    |     return self.request(
    |            ^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 516, in request
    |     return super().request(
    |            ^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 827, in request
    |     return self.send(request, auth=auth, follow_redirects=follow_redirects)
    |            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 914, in send
    |     response = self._send_handling_auth(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 942, in _send_handling_auth
    |     response = self._send_handling_redirects(
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 979, in _send_handling_redirects
    |     response = self._send_single_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py", line 1015, in _send_single_request
    |     response = transport.handle_request(request)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 398, in handle_request
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/testclient.py", line 395, in handle_request
    |     portal.call(self.app, scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 290, in call
    |     return cast(T_Retval, self.start_task_soon(func, *args).result())
    |                           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 456, in result
    |     return self.__get_result()
    |            ^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    |     raise self._exception
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/anyio/from_thread.py", line 221, in _call_func
    |     retval = await retval_or_awaitable
    |              ^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/fastapi/applications.py", line 1054, in __call__
    |     await super().__call__(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/applications.py", line 123, in __call__
    |     await self.middleware_stack(scope, receive, send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 186, in __call__
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/errors.py", line 164, in __call__
    |     await self.app(scope, receive, _send)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 189, in __call__
    |     with collapse_excgroups():
    |          ^^^^^^^^^^^^^^^^^^^^
    |   File "/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py", line 158, in __exit__
    |     self.gen.throw(value)
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/_utils.py", line 93, in collapse_excgroups
    |     raise exc
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/middleware/base.py", line 191, in __call__
    |     response = await self.dispatch_func(request, call_next)
    |                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 274, in dispatch
    |     await self._ensure_services_initialized()
    |   File "/Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/presentation/middleware/authentication_middleware.py", line 167, in _ensure_services_initialized
    |     self._auth_service_instance: IAuthenticationService = await auth_service_result
    |                                                           ^^^^^^^^^^^^^^^^^^^^^^^^^
    | RuntimeError: cannot reuse already awaited coroutine
    +------------------------------------

[33mDuring handling of the above exception, another exception occurred:[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_analytics_endpoints.py[0m:252: in test_phi_detection_in_analytics_event
    [0mresponse = client.post([33m"[39;49;00m[33m/analytics/events[39;49;00m[33m"[39;49;00m, json=event_data_with_phi, headers=auth_headers)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/digital_twins.py[0m:121: in _patched
    [0mresp = original([96mself[39;49;00m, *args, **kwargs)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:633: in post
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1145: in post
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:516: in request
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:827: in request
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:914: in send
    [0mresponse = [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:942: in _send_handling_auth
    [0mresponse = [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:979: in _send_handling_redirects
    [0mresponse = [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1015: in _send_single_request
    [0mresponse = transport.handle_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:398: in handle_request
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/testclient.py[0m:395: in handle_request
    [0mportal.call([96mself[39;49;00m.app, scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:290: in call
    [0m[94mreturn[39;49;00m cast(T_Retval, [96mself[39;49;00m.start_task_soon(func, *args).result())[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:456: in result
    [0m[94mreturn[39;49;00m [96mself[39;49;00m.__get_result()[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/concurrent/futures/_base.py[0m:401: in __get_result
    [0m[94mraise[39;49;00m [96mself[39;49;00m._exception[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/from_thread.py[0m:221: in _call_func
    [0mretval = [94mawait[39;49;00m retval_or_awaitable[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:189: in __call__
    [0m[94mwith[39;49;00m collapse_excgroups():[90m[39;49;00m
[1m[31m/opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/contextlib.py[0m:158: in __exit__
    [0m[96mself[39;49;00m.gen.throw(value)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_utils.py[0m:93: in collapse_excgroups
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/base.py[0m:191: in __call__
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m.dispatch_func(request, call_next)[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:274: in dispatch
    [0m[94mawait[39;49;00m [96mself[39;49;00m._ensure_services_initialized()[90m[39;49;00m
[1m[31mapp/presentation/middleware/authentication_middleware.py[0m:167: in _ensure_services_initialized
    [0m[96mself[39;49;00m._auth_service_instance: IAuthenticationService = [94mawait[39;49;00m auth_service_result[90m[39;49;00m
[1m[31mE   RuntimeError: cannot reuse already awaited coroutine[0m
[31m[1m______________ TestBiometricAlertsEndpoints.test_get_alert_rules _______________[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:183: in test_get_alert_rules
    [0mresponse = [94mawait[39;49;00m client.get([33m"[39;49;00m[33m/api/v1/biometric-alerts/rules[39;49;00m[33m"[39;49;00m, headers=headers)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1801: in get
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py[0m:65: in __call__
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions([96mself[39;49;00m.app, conn)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:756: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:776: in app
    [0m[94mawait[39;49;00m route.handle(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:297: in handle
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:77: in app
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions(app, request)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:72: in app
    [0mresponse = [94mawait[39;49;00m func(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/routing.py[0m:269: in app
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:572: in solve_dependencies
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:572: in solve_dependencies
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:600: in solve_dependencies
    [0msolved = [94mawait[39;49;00m call(**sub_values)[90m[39;49;00m
[1m[31mapp/presentation/dependencies/auth.py[0m:44: in get_user_repository
    [0m[94mreturn[39;49;00m SqlAlchemyUserRepositoryImpl(session=db)[90m[39;49;00m
[1m[31mE   TypeError: Can't instantiate abstract class SQLAlchemyUserRepository without an implementation for abstract methods 'count', 'exists', 'exists_by_email'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:00] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m______ TestBiometricAlertsEndpoints.test_create_alert_rule_from_template _______[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:203: in test_create_alert_rule_from_template
    [0mresponse = [94mawait[39;49;00m client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py[0m:65: in __call__
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions([96mself[39;49;00m.app, conn)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:756: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:776: in app
    [0m[94mawait[39;49;00m route.handle(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:297: in handle
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:77: in app
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions(app, request)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:72: in app
    [0mresponse = [94mawait[39;49;00m func(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/routing.py[0m:269: in app
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:602: in solve_dependencies
    [0msolved = [94mawait[39;49;00m run_in_threadpool(call, **sub_values)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/concurrency.py[0m:42: in run_in_threadpool
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m anyio.to_thread.run_sync(func, *args)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/to_thread.py[0m:56: in run_sync
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m get_async_backend().run_sync_in_worker_thread([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py[0m:2470: in run_sync_in_worker_thread
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m future[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py[0m:967: in run
    [0mresult = context.run(func, *args)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/biometric_alert_rules.py[0m:47: in get_clinical_rule_engine
    [0m[94mreturn[39;49;00m get_service(ClinicalRuleEngine)[90m[39;49;00m
[1m[31mapp/infrastructure/di/container.py[0m:505: in get_service
    [0m[94mreturn[39;49;00m container.resolve(service_type)[90m[39;49;00m
[1m[31mapp/infrastructure/di/container.py[0m:314: in resolve
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().resolve(interface_type)[90m[39;49;00m
[1m[31mapp/infrastructure/di/container.py[0m:165: in resolve
    [0m[94mraise[39;49;00m [96mTypeError[39;49;00m([33mf[39;49;00m[33m"[39;49;00m[33mType [39;49;00m[33m{[39;49;00minterface_type[33m}[39;49;00m[33m not registered.[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   TypeError: Type <class 'app.domain.services.clinical_rule_engine.ClinicalRuleEngine'> not registered.[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:00] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:00] [ERROR] [app.infrastructure.di.container] - Type <class 'app.domain.services.clinical_rule_engine.ClinicalRuleEngine'> not registered in DI container.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m______ TestBiometricAlertsEndpoints.test_create_alert_rule_from_condition ______[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:236: in test_create_alert_rule_from_condition
    [0mresponse = [94mawait[39;49;00m client.post([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1892: in post
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py[0m:65: in __call__
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions([96mself[39;49;00m.app, conn)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:756: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:776: in app
    [0m[94mawait[39;49;00m route.handle(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:297: in handle
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:77: in app
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions(app, request)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:72: in app
    [0mresponse = [94mawait[39;49;00m func(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/routing.py[0m:269: in app
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:602: in solve_dependencies
    [0msolved = [94mawait[39;49;00m run_in_threadpool(call, **sub_values)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/concurrency.py[0m:42: in run_in_threadpool
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m anyio.to_thread.run_sync(func, *args)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/to_thread.py[0m:56: in run_sync
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m get_async_backend().run_sync_in_worker_thread([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py[0m:2470: in run_sync_in_worker_thread
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m future[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py[0m:967: in run
    [0mresult = context.run(func, *args)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/biometric_alert_rules.py[0m:47: in get_clinical_rule_engine
    [0m[94mreturn[39;49;00m get_service(ClinicalRuleEngine)[90m[39;49;00m
[1m[31mapp/infrastructure/di/container.py[0m:505: in get_service
    [0m[94mreturn[39;49;00m container.resolve(service_type)[90m[39;49;00m
[1m[31mapp/infrastructure/di/container.py[0m:314: in resolve
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().resolve(interface_type)[90m[39;49;00m
[1m[31mapp/infrastructure/di/container.py[0m:165: in resolve
    [0m[94mraise[39;49;00m [96mTypeError[39;49;00m([33mf[39;49;00m[33m"[39;49;00m[33mType [39;49;00m[33m{[39;49;00minterface_type[33m}[39;49;00m[33m not registered.[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   TypeError: Type <class 'app.domain.services.clinical_rule_engine.ClinicalRuleEngine'> not registered.[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:00] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:00] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:00] [ERROR] [app.infrastructure.di.container] - Type <class 'app.domain.services.clinical_rule_engine.ClinicalRuleEngine'> not registered in DI container.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_______________ TestBiometricAlertsEndpoints.test_get_alert_rule _______________[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:273: in test_get_alert_rule
    [0mresponse = [94mawait[39;49;00m client.get([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1801: in get
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py[0m:65: in __call__
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions([96mself[39;49;00m.app, conn)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:756: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:776: in app
    [0m[94mawait[39;49;00m route.handle(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:297: in handle
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:77: in app
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions(app, request)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:72: in app
    [0mresponse = [94mawait[39;49;00m func(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/routing.py[0m:269: in app
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:572: in solve_dependencies
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:572: in solve_dependencies
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:600: in solve_dependencies
    [0msolved = [94mawait[39;49;00m call(**sub_values)[90m[39;49;00m
[1m[31mapp/presentation/dependencies/auth.py[0m:44: in get_user_repository
    [0m[94mreturn[39;49;00m SqlAlchemyUserRepositoryImpl(session=db)[90m[39;49;00m
[1m[31mE   TypeError: Can't instantiate abstract class SQLAlchemyUserRepository without an implementation for abstract methods 'count', 'exists', 'exists_by_email'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:01] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m__________ TestBiometricAlertsEndpoints.test_get_alert_rule_not_found __________[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:287: in test_get_alert_rule_not_found
    [0mresponse = [94mawait[39;49;00m client.get([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1801: in get
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py[0m:65: in __call__
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions([96mself[39;49;00m.app, conn)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:756: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:776: in app
    [0m[94mawait[39;49;00m route.handle(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:297: in handle
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:77: in app
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions(app, request)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:72: in app
    [0mresponse = [94mawait[39;49;00m func(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/routing.py[0m:269: in app
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:572: in solve_dependencies
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:572: in solve_dependencies
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:600: in solve_dependencies
    [0msolved = [94mawait[39;49;00m call(**sub_values)[90m[39;49;00m
[1m[31mapp/presentation/dependencies/auth.py[0m:44: in get_user_repository
    [0m[94mreturn[39;49;00m SqlAlchemyUserRepositoryImpl(session=db)[90m[39;49;00m
[1m[31mE   TypeError: Can't instantiate abstract class SQLAlchemyUserRepository without an implementation for abstract methods 'count', 'exists', 'exists_by_email'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:01] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_____________ TestBiometricAlertsEndpoints.test_update_alert_rule ______________[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:316: in test_update_alert_rule
    [0mresponse = [94mawait[39;49;00m client.put([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1929: in put
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py[0m:65: in __call__
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions([96mself[39;49;00m.app, conn)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:756: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:776: in app
    [0m[94mawait[39;49;00m route.handle(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:297: in handle
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:77: in app
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions(app, request)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:72: in app
    [0mresponse = [94mawait[39;49;00m func(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/routing.py[0m:269: in app
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:602: in solve_dependencies
    [0msolved = [94mawait[39;49;00m run_in_threadpool(call, **sub_values)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/concurrency.py[0m:42: in run_in_threadpool
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m anyio.to_thread.run_sync(func, *args)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/to_thread.py[0m:56: in run_sync
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m get_async_backend().run_sync_in_worker_thread([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py[0m:2470: in run_sync_in_worker_thread
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m future[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/anyio/_backends/_asyncio.py[0m:967: in run
    [0mresult = context.run(func, *args)[90m[39;49;00m
[1m[31mapp/presentation/api/v1/endpoints/biometric_alert_rules.py[0m:47: in get_clinical_rule_engine
    [0m[94mreturn[39;49;00m get_service(ClinicalRuleEngine)[90m[39;49;00m
[1m[31mapp/infrastructure/di/container.py[0m:505: in get_service
    [0m[94mreturn[39;49;00m container.resolve(service_type)[90m[39;49;00m
[1m[31mapp/infrastructure/di/container.py[0m:314: in resolve
    [0m[94mreturn[39;49;00m [96msuper[39;49;00m().resolve(interface_type)[90m[39;49;00m
[1m[31mapp/infrastructure/di/container.py[0m:165: in resolve
    [0m[94mraise[39;49;00m [96mTypeError[39;49;00m([33mf[39;49;00m[33m"[39;49;00m[33mType [39;49;00m[33m{[39;49;00minterface_type[33m}[39;49;00m[33m not registered.[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   TypeError: Type <class 'app.domain.services.clinical_rule_engine.ClinicalRuleEngine'> not registered.[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:01] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:01] [ERROR] [app.infrastructure.di.container] - Type <class 'app.domain.services.clinical_rule_engine.ClinicalRuleEngine'> not registered in DI container.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_____________ TestBiometricAlertsEndpoints.test_delete_alert_rule ______________[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:334: in test_delete_alert_rule
    [0mresponse = [94mawait[39;49;00m client.delete([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1999: in delete
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py[0m:65: in __call__
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions([96mself[39;49;00m.app, conn)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:756: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:776: in app
    [0m[94mawait[39;49;00m route.handle(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:297: in handle
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:77: in app
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions(app, request)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:72: in app
    [0mresponse = [94mawait[39;49;00m func(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/routing.py[0m:269: in app
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:572: in solve_dependencies
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:572: in solve_dependencies
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:600: in solve_dependencies
    [0msolved = [94mawait[39;49;00m call(**sub_values)[90m[39;49;00m
[1m[31mapp/presentation/dependencies/auth.py[0m:44: in get_user_repository
    [0m[94mreturn[39;49;00m SqlAlchemyUserRepositoryImpl(session=db)[90m[39;49;00m
[1m[31mE   TypeError: Can't instantiate abstract class SQLAlchemyUserRepository without an implementation for abstract methods 'count', 'exists', 'exists_by_email'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:01] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_____________ TestBiometricAlertsEndpoints.test_get_rule_templates _____________[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:346: in test_get_rule_templates
    [0mresponse = [94mawait[39;49;00m client.get([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1801: in get
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.request([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1574: in request
    [0m[94mreturn[39;49;00m [94mawait[39;49;00m [96mself[39;49;00m.send(request, auth=auth, follow_redirects=follow_redirects)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1661: in send
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_auth([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1689: in _send_handling_auth
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_handling_redirects([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1726: in _send_handling_redirects
    [0mresponse = [94mawait[39;49;00m [96mself[39;49;00m._send_single_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_client.py[0m:1763: in _send_single_request
    [0mresponse = [94mawait[39;49;00m transport.handle_async_request(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/httpx/_transports/asgi.py[0m:164: in handle_async_request
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/applications.py[0m:1054: in __call__
    [0m[94mawait[39;49;00m [96msuper[39;49;00m().[92m__call__[39;49;00m(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/applications.py[0m:123: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:186: in __call__
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/errors.py[0m:164: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, _send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/middleware/exceptions.py[0m:65: in __call__
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions([96mself[39;49;00m.app, conn)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:756: in __call__
    [0m[94mawait[39;49;00m [96mself[39;49;00m.middleware_stack(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:776: in app
    [0m[94mawait[39;49;00m route.handle(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:297: in handle
    [0m[94mawait[39;49;00m [96mself[39;49;00m.app(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:77: in app
    [0m[94mawait[39;49;00m wrap_app_handling_exceptions(app, request)(scope, receive, send)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:64: in wrapped_app
    [0m[94mraise[39;49;00m exc[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/_exception_handler.py[0m:53: in wrapped_app
    [0m[94mawait[39;49;00m app(scope, receive, sender)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/starlette/routing.py[0m:72: in app
    [0mresponse = [94mawait[39;49;00m func(request)[90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/routing.py[0m:269: in app
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:572: in solve_dependencies
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:572: in solve_dependencies
    [0msolved_result = [94mawait[39;49;00m solve_dependencies([90m[39;49;00m
[1m[31m.venv/lib/python3.12/site-packages/fastapi/dependencies/utils.py[0m:600: in solve_dependencies
    [0msolved = [94mawait[39;49;00m call(**sub_values)[90m[39;49;00m
[1m[31mapp/presentation/dependencies/auth.py[0m:44: in get_user_repository
    [0m[94mreturn[39;49;00m SqlAlchemyUserRepositoryImpl(session=db)[90m[39;49;00m
[1m[31mE   TypeError: Can't instantiate abstract class SQLAlchemyUserRepository without an implementation for abstract methods 'count', 'exists', 'exists_by_email'[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:01] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_________________ TestBiometricAlertsEndpoints.test_get_alerts _________________[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:361: in test_get_alerts
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   assert 404 == 200[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   200 = status.HTTP_200_OK[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:01] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:01] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/biometric-alerts/ "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/biometric-alerts/ "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m__________ TestBiometricAlertsEndpoints.test_get_alerts_with_filters ___________[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:389: in test_get_alerts_with_filters
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   assert 404 == 200[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   200 = status.HTTP_200_OK[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:01] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:01] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/biometric-alerts/?patient_id=abcdef12-e89b-12d3-a456-426614174abc&status=triggered&priority=warning&start_time=2025-05-03T00%3A53%3A01.843406%2B00%3A00&end_time=2025-05-03T01%3A53%3A01.843417%2B00%3A00&page=2&page_size=5 "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/biometric-alerts/?patient_id=abcdef12-e89b-12d3-a456-426614174abc&status=triggered&priority=warning&start_time=2025-05-03T00%3A53%3A01.843406%2B00%3A00&end_time=2025-05-03T01%3A53%3A01.843417%2B00%3A00&page=2&page_size=5 "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m______ TestBiometricAlertsEndpoints.test_update_alert_status_acknowledge _______[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:408: in test_update_alert_status_acknowledge
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   assert 404 == 200[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   200 = status.HTTP_200_OK[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:01] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:01] [INFO] [httpx] - HTTP Request: PATCH http://test/api/v1/biometric-alerts/abcdef12-e89b-12d3-a456-426614174abc/status "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: PATCH http://test/api/v1/biometric-alerts/abcdef12-e89b-12d3-a456-426614174abc/status "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m________ TestBiometricAlertsEndpoints.test_update_alert_status_resolve _________[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:428: in test_update_alert_status_resolve
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   assert 404 == 200[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   200 = status.HTTP_200_OK[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:01] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:01] [INFO] [httpx] - HTTP Request: PATCH http://test/api/v1/biometric-alerts/abcdef12-e89b-12d3-a456-426614174abc/status "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: PATCH http://test/api/v1/biometric-alerts/abcdef12-e89b-12d3-a456-426614174abc/status "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:01] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_________ TestBiometricAlertsEndpoints.test_get_patient_alert_summary __________[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:457: in test_get_patient_alert_summary
    [0m[94massert[39;49;00m response.status_code == status.HTTP_200_OK[90m[39;49;00m
[1m[31mE   assert 404 == 200[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   200 = status.HTTP_200_OK[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:02] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:02] [INFO] [httpx] - HTTP Request: GET http://test/api/v1/biometric-alerts/patients/abcdef12-e89b-12d3-a456-426614174abc/summary "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: GET http://test/api/v1/biometric-alerts/patients/abcdef12-e89b-12d3-a456-426614174abc/summary "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_________ TestBiometricAlertsEndpoints.test_create_alert_rule_template _________[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:503: in test_create_alert_rule_template
    [0m[94massert[39;49;00m response.status_code == status.HTTP_201_CREATED[90m[39;49;00m
[1m[31mE   assert 405 == 201[0m
[1m[31mE    +  where 405 = <Response [405 Method Not Allowed]>.status_code[0m
[1m[31mE    +  and   201 = status.HTTP_201_CREATED[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:02] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:02] [INFO] [httpx] - HTTP Request: POST http://test/api/v1/biometric-alerts/rules/templates "HTTP/1.1 405 [REDACTED NAME] Allowed"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: POST http://test/api/v1/biometric-alerts/rules/templates "HTTP/1.1 405 [REDACTED NAME] Allowed"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m______ TestBiometricAlertsEndpoints.test_update_alert_status_unauthorized ______[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:518: in test_update_alert_status_unauthorized
    [0m[94massert[39;49;00m response.status_code == status.HTTP_401_UNAUTHORIZED[90m[39;49;00m
[1m[31mE   assert 404 == 401[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   401 = status.HTTP_401_UNAUTHORIZED[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:02] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:02] [INFO] [httpx] - HTTP Request: PATCH http://test/api/v1/biometric-alerts/abcdef12-e89b-12d3-a456-426614174abc/status "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: PATCH http://test/api/v1/biometric-alerts/abcdef12-e89b-12d3-a456-426614174abc/status "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m____ TestBiometricAlertsEndpoints.test_update_alert_status_invalid_payload _____[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:534: in test_update_alert_status_invalid_payload
    [0m[94massert[39;49;00m response.status_code == status.HTTP_422_UNPROCESSABLE_ENTITY[90m[39;49;00m
[1m[31mE   assert 404 == 422[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   422 = status.HTTP_422_UNPROCESSABLE_ENTITY[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:02] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:02] [INFO] [httpx] - HTTP Request: PATCH http://test/api/v1/biometric-alerts/abcdef12-e89b-12d3-a456-426614174abc/status "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: PATCH http://test/api/v1/biometric-alerts/abcdef12-e89b-12d3-a456-426614174abc/status "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m_______ TestBiometricAlertsEndpoints.test_trigger_alert_manually_success _______[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py[0m:554: in test_trigger_alert_manually_success
    [0m[94massert[39;49;00m response.status_code == status.HTTP_201_CREATED[90m[39;49;00m
[1m[31mE   assert 404 == 201[0m
[1m[31mE    +  where 404 = <Response [404 Not Found]>.status_code[0m
[1m[31mE    +  and   201 = status.HTTP_201_CREATED[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> Creating MINIMAL initialized_app fixture (NO AUTH MIDDLEWARE)... 
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> [REDACTED NAME], [REDACTED NAME]/Rules, and [REDACTED NAME].
[2025-05-02 21:53:02] [ERROR] [app.tests.conftest] - Cannot find get_analytics_service_provider. Override may fail!
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - MINIMAL App middleware BEFORE yield: []
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - MINIMAL App routes BEFORE yield: ['/openapi.json', '/docs', '/docs/oauth2-redirect', '/redoc', '/api/v1/auth/login', '/api/v1/auth/refresh', '/api/v1/auth/logout', '/api/v1/auth/me', '/api/v1/auth/session-info', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/{rule_id}', '/api/v1/biometric-alerts/rules/from-template', '/api/v1/biometric-alerts/rules/force-validation-error', '/api/v1/biometric-alerts/rules/rule-templates', '/api/v1/analytics/api/v1/analytics/patient/{patient_id}/treatment-outcomes', '/api/v1/analytics/api/v1/analytics/status/{job_id}', '/api/v1/analytics/api/v1/analytics/practice-metrics', '/api/v1/analytics/api/v1/analytics/diagnosis-distribution', '/api/v1/analytics/api/v1/analytics/medications/{medication_name}/effectiveness', '/api/v1/analytics/api/v1/analytics/treatment-comparison/{diagnosis_code}', '/api/v1/analytics/api/v1/analytics/patient-risk-stratification', '/api/v1/analytics/analytics/events', '/api/v1/analytics/analytics/events/batch']
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - >>> Applied minimal overrides.
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:02] [INFO] [httpx] - HTTP Request: POST http://test/api/v1/biometric-alerts/patients/abcdef12-e89b-12d3-a456-426614174abc/trigger "HTTP/1.1 404 [REDACTED NAME]"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1773 HTTP Request: POST http://test/api/v1/biometric-alerts/patients/abcdef12-e89b-12d3-a456-426614174abc/trigger "HTTP/1.1 404 [REDACTED NAME]"
--------------------------- Captured stdout teardown ---------------------------
[2025-05-02 21:53:02] [INFO] [app.tests.conftest] - <<< Tearing down MINIMAL initialized_app fixture...
[31m[1m____ TestBiometricEndpointsDependencies.test_require_clinician_role_success ____[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_endpoints.py[0m:261: in test_require_clinician_role_success
    [0m[94massert[39;49;00m response.status_code == [94m200[39;49;00m[90m[39;49;00m
[1m[31mE   assert 403 == 200[0m
[1m[31mE    +  where 403 = <AwaitableResponse <Response [403 Forbidden]>>.status_code[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:02] [INFO] [httpx] - HTTP Request: GET http://testserver/test/clinician-only "HTTP/1.1 403 Forbidden"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/test/clinician-only "HTTP/1.1 403 Forbidden"
[31m[1m_____ TestBiometricEndpointsDependencies.test_require_clinician_role_admin _____[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_endpoints.py[0m:278: in test_require_clinician_role_admin
    [0m[94massert[39;49;00m response.status_code == [94m200[39;49;00m [90m# Change to 403 if Admin != Clinician access[39;49;00m[90m[39;49;00m
[1m[31mE   assert 403 == 200[0m
[1m[31mE    +  where 403 = <AwaitableResponse <Response [403 Forbidden]>>.status_code[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:02] [INFO] [httpx] - HTTP Request: GET http://testserver/test/clinician-only "HTTP/1.1 403 Forbidden"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/test/clinician-only "HTTP/1.1 403 Forbidden"
[31m[1m____ TestBiometricEndpointsDependencies.test_require_clinician_role_patient ____[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_endpoints.py[0m:294: in test_require_clinician_role_patient
    [0m[94massert[39;49;00m UserRole.CLINICIAN.value [95min[39;49;00m response.json().get([33m"[39;49;00m[33mdetail[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: assert 'CLINICIAN' in 'This operation requires one of the following roles: clinician, admin'[0m
[1m[31mE    +  where 'CLINICIAN' = <Role.CLINICIAN: 'CLINICIAN'>.value[0m
[1m[31mE    +    where <Role.CLINICIAN: 'CLINICIAN'> = UserRole.CLINICIAN[0m
[1m[31mE    +  and   'This operation requires one of the following roles: clinician, admin' = <built-in method get of dict object at 0x168bb8c00>('detail', '')[0m
[1m[31mE    +    where <built-in method get of dict object at 0x168bb8c00> = {'detail': 'This operation requires one of the following roles: clinician, admin'}.get[0m
[1m[31mE    +      where {'detail': 'This operation requires one of the following roles: clinician, admin'} = <bound method Response.json of <Response [403 Forbidden]>>()[0m
[1m[31mE    +        where <bound method Response.json of <Response [403 Forbidden]>> = <AwaitableResponse <Response [403 Forbidden]>>.json[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:02] [INFO] [httpx] - HTTP Request: GET http://testserver/test/clinician-only "HTTP/1.1 403 Forbidden"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/test/clinician-only "HTTP/1.1 403 Forbidden"
[31m[1m______ TestBiometricEndpointsDependencies.test_require_admin_role_success ______[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_endpoints.py[0m:308: in test_require_admin_role_success
    [0m[94massert[39;49;00m response.status_code == [94m200[39;49;00m[90m[39;49;00m
[1m[31mE   assert 403 == 200[0m
[1m[31mE    +  where 403 = <AwaitableResponse <Response [403 Forbidden]>>.status_code[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:02] [INFO] [httpx] - HTTP Request: GET http://testserver/test/admin-only "HTTP/1.1 403 Forbidden"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/test/admin-only "HTTP/1.1 403 Forbidden"
[31m[1m_____ TestBiometricEndpointsDependencies.test_require_admin_role_clinician _____[0m
[1m[31mapp/tests/unit/presentation/api/v1/endpoints/test_biometric_endpoints.py[0m:324: in test_require_admin_role_clinician
    [0m[94massert[39;49;00m UserRole.ADMIN.value [95min[39;49;00m response.json().get([33m"[39;49;00m[33mdetail[39;49;00m[33m"[39;49;00m, [33m"[39;49;00m[33m"[39;49;00m)[90m[39;49;00m
[1m[31mE   AssertionError: assert 'ADMIN' in 'This operation requires admin privileges'[0m
[1m[31mE    +  where 'ADMIN' = <Role.ADMIN: 'ADMIN'>.value[0m
[1m[31mE    +    where <Role.ADMIN: 'ADMIN'> = UserRole.ADMIN[0m
[1m[31mE    +  and   'This operation requires admin privileges' = <built-in method get of dict object at 0x16884c0c0>('detail', '')[0m
[1m[31mE    +    where <built-in method get of dict object at 0x16884c0c0> = {'detail': 'This operation requires admin privileges'}.get[0m
[1m[31mE    +      where {'detail': 'This operation requires admin privileges'} = <bound method Response.json of <Response [403 Forbidden]>>()[0m
[1m[31mE    +        where <bound method Response.json of <Response [403 Forbidden]>> = <AwaitableResponse <Response [403 Forbidden]>>.json[0m
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:02] [INFO] [httpx] - HTTP Request: GET http://testserver/test/admin-only "HTTP/1.1 403 Forbidden"
------------------------------ Captured log call -------------------------------
[32mINFO    [0m httpx:_client.py:1026 HTTP Request: GET http://testserver/test/admin-only "HTTP/1.1 403 Forbidden"
[31m[1m___________________ TestBedrockPAT.test_get_patient_analyses ___________________[0m
[1m[31mapp/tests/unit/services/ml/pat/test_pat_service.py[0m:360: in test_get_patient_analyses
    [0m[94massert[39;49;00m [96mlen[39;49;00m(result) == limit [90m# Check if we got the expected number back[39;49;00m[90m[39;49;00m
[1m[31mE   AssertionError[0m
---------------------------- Captured stdout setup -----------------------------
[2025-05-01 05:40:00] [INFO] [app.core.services.ml.pat.bedrock] - BedrockPAT service initialized successfully
----------------------------- Captured stdout call -----------------------------
[2025-05-02 21:53:02] [INFO] [app.core.services.ml.pat.bedrock] - Retrieving analyses for patient hash: d3ade5fc4ef9
[2025-05-02 21:53:02] [WARNING] [app.core.services.ml.pat.bedrock] - Skipping item with missing AnalysisId for patient d3ade5fc4ef9
[2025-05-02 21:53:02] [WARNING] [app.core.services.ml.pat.bedrock] - Skipping item with missing AnalysisId for patient d3ade5fc4ef9
[33m=============================== warnings summary ===============================[0m
.venv/lib/python3.12/site-packages/starlette/formparsers.py:12
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/starlette/formparsers.py:12: PendingDeprecationWarning: Please use `import python_multipart` instead.
    import multipart

.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:291
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:291
.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:291
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pydantic/_internal/_config.py:291: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.8/migration/
    warnings.warn(DEPRECATION_MESSAGE, DeprecationWarning)

.venv/lib/python3.12/site-packages/pydantic/_internal/_fields.py:161
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pydantic/_internal/_fields.py:161: UserWarning: Field "model_mappings" has conflict with protected namespace "model_".
  
  You may be able to resolve this warning by setting `model_config['protected_namespaces'] = ('settings_',)`.
    warnings.warn(

.venv/lib/python3.12/site-packages/pydantic/_internal/_fields.py:161
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pydantic/_internal/_fields.py:161: UserWarning: Field "model_path" has conflict with protected namespace "model_".
  
  You may be able to resolve this warning by setting `model_config['protected_namespaces'] = ('settings_',)`.
    warnings.warn(

.venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

.venv/lib/python3.12/site-packages/_pytest/config/__init__.py:1448
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_pytest/config/__init__.py:1448: PytestConfigWarning: Unknown config option: asyncio_default_fixture_loop_scope
  
    self._warn_or_fail_if_strict(f"Unknown config option: {key}\n")

.venv/lib/python3.12/site-packages/_hypothesis_pytestplugin.py:417
.venv/lib/python3.12/site-packages/_hypothesis_pytestplugin.py:417
.venv/lib/python3.12/site-packages/_hypothesis_pytestplugin.py:417
.venv/lib/python3.12/site-packages/_hypothesis_pytestplugin.py:417
.venv/lib/python3.12/site-packages/_hypothesis_pytestplugin.py:417
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/_hypothesis_pytestplugin.py:417: PytestRemovedIn9Warning: Marks applied to fixtures have no effect
  See docs: https://docs.pytest.org/en/stable/deprecations.html#applying-a-mark-to-a-fixture-function
    return _orig_call(self, function)

app/tests/core/test_db.py:16
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/core/test_db.py:16: PytestCollectionWarning: cannot collect test class 'TestModel' because it has a __init__ constructor (from: app/tests/core/test_db.py)
    class TestModel(Base):

.venv/lib/python3.12/site-packages/pydantic/main.py:1369: 10 warnings
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pydantic/main.py:1369: PydanticDeprecatedSince20: The `update_forward_refs` method is deprecated; use `model_rebuild` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.8/migration/
    warnings.warn(

app/tests/integration/core/test_db.py:43
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/core/test_db.py:43: PytestCollectionWarning: cannot collect test class 'TestCustomModel' because it has a __init__ constructor (from: app/tests/integration/core/test_db.py)
    class TestCustomModel(Base):

.venv/lib/python3.12/site-packages/sqlalchemy/orm/decl_api.py:0
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/sqlalchemy/orm/decl_api.py:0: PytestCollectionWarning: cannot collect test class 'Base' because it has a __init__ constructor (from: app/tests/integration/infrastructure/persistence/repositories/test_patient_repository_int.py)

app/tests/integration/infrastructure/persistence/repositories/test_patient_repository_int.py:36
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/infrastructure/persistence/repositories/test_patient_repository_int.py:36: PytestCollectionWarning: cannot collect test class 'TestUser' because it has a __init__ constructor (from: app/tests/integration/infrastructure/persistence/repositories/test_patient_repository_int.py)
    class TestUser(TestBase):

app/tests/integration/infrastructure/persistence/repositories/test_patient_repository_int.py:55
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/infrastructure/persistence/repositories/test_patient_repository_int.py:55: PytestCollectionWarning: cannot collect test class 'TestPatient' because it has a __init__ constructor (from: app/tests/integration/infrastructure/persistence/repositories/test_patient_repository_int.py)
    class TestPatient(TestBase):

app/tests/integration/infrastructure/persistence/test_models.py:45
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/infrastructure/persistence/test_models.py:45: PytestCollectionWarning: cannot collect test class 'TestPatient' because it has a __init__ constructor (from: app/tests/integration/infrastructure/persistence/test_models.py)
    class TestPatient(Base):

app/tests/integration/utils/test_authentication.py:18
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/integration/utils/test_authentication.py:18: PytestCollectionWarning: cannot collect test class 'TestAuthenticationMiddleware' because it has a __init__ constructor (from: app/tests/integration/utils/test_authentication.py)
    class TestAuthenticationMiddleware(BaseHTTPMiddleware):

.venv/lib/python3.12/site-packages/pydantic/_internal/_fields.py:161
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pydantic/_internal/_fields.py:161: UserWarning: Field "model_size" has conflict with protected namespace "model_".
  
  You may be able to resolve this warning by setting `model_config['protected_namespaces'] = ()`.
    warnings.warn(

.venv/lib/python3.12/site-packages/pydantic/_internal/_fields.py:161
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pydantic/_internal/_fields.py:161: UserWarning: Field "model_version" has conflict with protected namespace "model_".
  
  You may be able to resolve this warning by setting `model_config['protected_namespaces'] = ()`.
    warnings.warn(

app/tests/unit/services/ml/conftest.py:11
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/unit/services/ml/conftest.py:11: PytestRemovedIn9Warning: The (path: py.path.local) argument is deprecated, please use (file_path: pathlib.Path)
  see https://docs.pytest.org/en/latest/deprecations.html#py-path-local-arguments-for-hooks-replaced-with-pathlib-path
    def pytest_collect_file(parent, path):

app/tests/api/integration/test_xgboost_integration.py::TestXGBoostIntegration::test_risk_prediction_flow
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:757: DeprecationWarning: The event_loop fixture provided by pytest-asyncio has been redefined in
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/tests/conftest.py:979
  Replacing the event_loop fixture with a custom implementation is deprecated
  and will lead to errors in the future.
  If you want to request an asyncio event loop with a scope other than function
  scope, use the "scope" argument to the asyncio mark when marking the tests.
  If you want to return different types of event loops, use the event_loop_policy
  fixture.
  
    warnings.warn(

app/tests/integration/api/mentallama/test_mentallama_api.py: 8 warnings
app/tests/integration/api/test_xgboost_api_integration.py: 14 warnings
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/httpx/_client.py:1426: DeprecationWarning: The 'app' shortcut is now deprecated. Use the explicit style 'transport=ASGITransport(app=...)' instead.
    warnings.warn(message, DeprecationWarning)

app/tests/integration/api/mentallama/test_mentallama_api.py: 8 warnings
app/tests/security/auth/test_auth_endpoints.py: 9 warnings
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/app/infrastructure/cache/redis_cache.py:513: DeprecationWarning: Call to deprecated close. (Use aclose() instead) -- Deprecated since version 5.0.1.
    await _redis_pool.close()

app/tests/integration/infrastructure/security/test_security_boundary.py: 13 warnings
app/tests/security/jwt/test_jwt_auth.py: 4 warnings
app/tests/security/jwt/test_jwt_service.py: 4 warnings
app/tests/unit/infrastructure/security/test_jwt_handler.py: 14 warnings
app/tests/unit/infrastructure/security/test_jwt_service_unit.py: 7 warnings
  /Users/ray/Desktop/CLARITY-DIGITAL-TWIN/Clarity-AI-Backend/.venv/lib/python3.12/site-packages/jose/jwt.py:311: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    now = timegm(datetime.utcnow().utctimetuple())

app/tests/unit/domain/services/test_biometric_integration_service.py::TestBiometricIntegrationService::test_batch_add_biometric_data
  /opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:439: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    def __init__(
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

app/tests/unit/domain/services/test_clinical_rule_engine.py::TestClinicalRuleEngine::test_create_rule_with_invalid_priority
  /opt/homebrew/Cellar/python@3.12/3.12.10/Frameworks/Python.framework/Versions/3.12/lib/python3.12/unittest/mock.py:2217: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    def __init__(self, name, parent):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
[36m[1m=========================== short test summary info ============================[0m
[33mSKIPPED[0m [1] app/tests/core/services/ml/xgboost/test_aws_xgboost_service.py:10: Skipping AWS XGBoostService tests (AWS integration not available)
[33mSKIPPED[0m [1] app/tests/infrastructure/ml/test_symptom_forecasting_service.py:10: Skipping symptom forecasting tests (torch unsupported in this environment)
[33mSKIPPED[0m [1] app/tests/integration/core/temporal/test_temporal_wrapper.py:9: Skipping temporal wrapper integration tests: pending refactor
[33mSKIPPED[0m [1] app/tests/unit/infrastructure/ml/pharmacogenomics/test_gene_medication_model.py:10: Skipping pharmacogenomics gene medication model tests (torch unsupported)
[33mSKIPPED[0m [1] app/tests/unit/infrastructure/ml/pharmacogenomics/test_model_service_pgx.py:10: Skipping pharmacogenomics model service tests (torch unsupported)
[33mSKIPPED[0m [1] app/tests/unit/infrastructure/ml/pharmacogenomics/test_treatment_model.py:10: Skipping pharmacogenomics treatment model tests (torch unsupported)
[33mSKIPPED[0m [1] app/tests/unit/infrastructure/ml/symptom_forecasting/test_ensemble_model.py:4: Skipping ensemble model tests (torch unsupported)
[33mSKIPPED[0m [1] app/tests/unit/infrastructure/ml/symptom_forecasting/test_model_service_symptom.py:4: Skipping symptom forecasting model service tests (torch unsupported)
[33mSKIPPED[0m [1] app/tests/unit/infrastructure/ml/symptom_forecasting/test_transformer_model.py:10: Skipping transformer model tests (torch unsupported in this environment)
[33mSKIPPED[0m [11] app/tests/api/unit/test_xgboost_endpoints.py: Skipping XGBoost endpoint unit tests: pending endpoint refactor
[33mSKIPPED[0m [1] app/tests/integration/core/temporal/test_temporal_neurotransmitter_integration.py:138: Skipping temporal neurotransmitter integration: pending mapping signature update
[33mSKIPPED[0m [1] app/tests/integration/core/temporal/test_temporal_neurotransmitter_integration.py:207: Skipping full brain region coverage visualization test: pending mapping signature update
[33mSKIPPED[0m [1] app/tests/integration/core/temporal/test_temporal_neurotransmitter_integration.py:265: Skipping full neurotransmitter coverage treatment test: pending method availability
[33mSKIPPED[0m [1] app/tests/integration/core/temporal/test_temporal_neurotransmitter_integration.py:320: Skipping API integration with service test: pending endpoint implementation
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/persistence/test_database_docker_connection.py:175: Not running in Docker environment (TEST_DATABASE_URL not set)
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/persistence/test_database_docker_connection.py:197: Not running in Docker environment (TEST_DATABASE_URL not set)
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/security/phi/test_phi_sanitization_integration.py:94: PHI sanitization integration tests need updating to match new domain entity structures
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/security/phi/test_phi_sanitization_integration.py:125: PHI sanitization integration tests need updating to match new domain entity structures
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/security/phi/test_phi_sanitization_integration.py:150: PHI sanitization integration tests need updating to match new domain entity structures
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/security/phi/test_phi_sanitization_integration.py:188: PHI sanitization integration tests need updating to match new domain entity structures
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/security/phi/test_standalone_phi_sanitizer.py:316: Standalone PHI sanitizer tests need update to match PHI implementation
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/security/phi/test_standalone_phi_sanitizer.py:344: Standalone PHI sanitizer tests need update to match PHI implementation
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/security/phi/test_standalone_phi_sanitizer.py:276: Standalone PHI sanitizer tests need update to match PHI implementation
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/security/phi/test_standalone_phi_sanitizer.py:286: Standalone PHI sanitizer tests need update to match PHI implementation
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/security/phi/test_standalone_phi_sanitizer.py:265: Standalone PHI sanitizer tests need update to match PHI implementation
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/security/phi/test_standalone_phi_sanitizer.py:255: Standalone PHI sanitizer tests need update to match PHI implementation
[33mSKIPPED[0m [1] app/tests/integration/infrastructure/security/phi/test_standalone_phi_sanitizer.py:325: Standalone PHI sanitizer tests need update to match PHI implementation
[33mSKIPPED[0m [1] app/tests/security/api/test_api_hipaa_compliance.py:492: HTTPS enforcement tested at deployment level
[33mSKIPPED[0m [1] app/tests/security/api/test_api_hipaa_compliance.py:516: Rate limiting tested at infrastructure level
[33mSKIPPED[0m [1] app/tests/security/audit/test_audit_logging.py:40: Audit logger not implemented yet
[33mSKIPPED[0m [1] app/tests/security/audit/test_audit_logging.py:66: Audit logger not implemented yet
[33mSKIPPED[0m [1] app/tests/security/audit/test_audit_logging.py:98: Audit logger not implemented yet
[33mSKIPPED[0m [1] app/tests/security/audit/test_audit_logging.py:126: Audit logger not implemented yet
[33mSKIPPED[0m [1] app/tests/security/audit/test_audit_logging.py:149: Audit logger not implemented yet
[33mSKIPPED[0m [1] app/tests/security/db/test_unit_of_work.py:209: Metadata/Audit logic removed from UoW base class for now
[33mSKIPPED[0m [1] app/tests/security/jwt/test_jwt_auth.py:223: Needs refactoring to test actual endpoints/middleware, not call non-existent jwt_service method.
[33mSKIPPED[0m [1] app/tests/security/jwt/test_jwt_auth.py:251: Relies on undefined auth_service fixture.
[33mSKIPPED[0m [1] app/tests/security/jwt/test_jwt_auth.py:273: Relies on undefined auth_service fixture.
[33mSKIPPED[0m [1] app/tests/security/jwt/test_jwt_auth.py:291: Requires client fixture and defined /refresh endpoint.
[33mSKIPPED[0m [1] app/tests/security/jwt/test_jwt_auth.py:331: Relies on undefined auth_service fixture.
[33mSKIPPED[0m [1] app/tests/security/phi/test_patient_phi_security.py:132: Duplicate or legacy test; Patient does not have first_name/last_name fields.
[33mSKIPPED[0m [1] app/tests/security/phi/test_patient_phi_security.py:143: Patient model does not have all expected PHI fields for this test.
[33mSKIPPED[0m [1] app/tests/security/phi/test_patient_phi_security.py:123: Field-level PHI access restrictions not implemented in Patient model.
[33mSKIPPED[0m [1] app/tests/security/phi/test_patient_phi_security.py:128: Encrypted field serialization not implemented in Patient model.
[33mSKIPPED[0m [1] app/tests/security/phi/test_patient_phi_security.py:136: Patient model does not have all expected PHI fields for this test.
[33mSKIPPED[0m [1] app/tests/security/phi/test_patient_phi_security.py:140: Patient model does not have all expected PHI fields for this test.
[33mSKIPPED[0m [1] app/tests/security/phi/test_patient_phi_security.py:147: Patient model does not have all expected PHI fields for this test.
[33mSKIPPED[0m [1] app/tests/unit/core/services/ml/test_factory.py:104: Skipping test as create_mentalllama_service method seems removed from factory
[33mSKIPPED[0m [1] app/tests/unit/core/services/ml/test_factory.py:119: Skipping test as create_mentalllama_service method seems removed from factory
[33mSKIPPED[0m [1] app/tests/unit/core/services/ml/test_factory.py:133: Skipping test as create_mentalllama_service method seems removed from factory
[33mSKIPPED[0m [1] app/tests/unit/core/services/ml/test_factory.py:153: Skipping MentaLLaMA caching test as get_mentalllama_service method seems removed from factory
[33mSKIPPED[0m [1] app/tests/unit/services/ml/pat/test_mock_pat_service.py:525: Integration types validation is implemented differently
[31mFAILED[0m app/tests/integration/api/endpoints/test_actigraphy_endpoints.py::[1mtest_upload_actigraphy_data[0m - AssertionError
[31mFAILED[0m app/tests/integration/api/endpoints/test_actigraphy_endpoints.py::[1mtest_get_actigraphy_data_summary[0m - AssertionError
[31mFAILED[0m app/tests/integration/api/endpoints/test_actigraphy_endpoints.py::[1mtest_get_specific_actigraphy_data[0m - AssertionError
[31mFAILED[0m app/tests/integration/api/mentallama/test_mentallama_api.py::[1mtest_health_check[0m - TypeError: Can't instantiate abstract class JWTService without an implement...
[31mFAILED[0m app/tests/integration/api/mentallama/test_mentallama_api.py::[1mtest_process_endpoint[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/mentallama/test_mentallama_api.py::[1mtest_analyze_text_endpoint[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/mentallama/test_mentallama_api.py::[1mtest_detect_conditions_endpoint[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/mentallama/test_mentallama_api.py::[1mtest_therapeutic_response_endpoint[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/mentallama/test_mentallama_api.py::[1mtest_suicide_risk_endpoint[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/mentallama/test_mentallama_api.py::[1mtest_wellness_dimensions_endpoint[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/mentallama/test_mentallama_api.py::[1mtest_service_unavailable[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/test_actigraphy_api_integration.py::[1mTestActigraphyAPI::test_analyze_actigraphy[0m - AssertionError
[31mFAILED[0m app/tests/integration/api/test_actigraphy_api_integration.py::[1mTestActigraphyAPI::test_get_actigraphy_embeddings[0m - AssertionError
[31mFAILED[0m app/tests/integration/api/test_actigraphy_api_integration.py::[1mTestActigraphyAPI::test_get_analysis_by_id[0m - app.core.exceptions.base_exceptions.ValidationError: Device info must conta...
[31mFAILED[0m app/tests/integration/api/test_actigraphy_api_integration.py::[1mTestActigraphyAPI::test_get_patient_analyses[0m - app.core.exceptions.base_exceptions.ValidationError: Device info must conta...
[31mFAILED[0m app/tests/integration/api/test_actigraphy_api_integration.py::[1mTestActigraphyAPI::test_get_model_info[0m - AssertionError
[31mFAILED[0m app/tests/integration/api/test_actigraphy_api_integration.py::[1mTestActigraphyAPI::test_integrate_with_digital_twin[0m - app.core.exceptions.base_exceptions.ValidationError: Device info must conta...
[31mFAILED[0m app/tests/integration/api/test_actigraphy_api_integration.py::[1mTestActigraphyAPI::test_unauthorized_access[0m - AssertionError
[31mFAILED[0m app/tests/integration/api/test_actigraphy_api_integration.py::[1mTestActigraphyAPI::test_get_analysis_types[0m - AssertionError
[31mFAILED[0m app/tests/integration/api/test_xgboost_api_integration.py::[1mTestXGBoostAPIIntegration::test_predict_risk_validation_error[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/test_xgboost_api_integration.py::[1mTestXGBoostAPIIntegration::test_predict_risk_phi_detection[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/test_xgboost_api_integration.py::[1mTestXGBoostAPIIntegration::test_predict_risk_unauthorized[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/test_xgboost_api_integration.py::[1mTestXGBoostAPIIntegration::test_predict_outcome_success[0m - KeyError: 'outcome_type'
[31mFAILED[0m app/tests/integration/api/test_xgboost_api_integration.py::[1mTestXGBoostAPIIntegration::test_get_feature_importance_not_found[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/test_xgboost_api_integration.py::[1mTestXGBoostAPIIntegration::test_get_model_info_not_found[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/test_xgboost_api_integration.py::[1mTestXGBoostAPIIntegration::test_service_unavailable[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/test_xgboost_api_integration.py::[1mTestXGBoostAPIIntegration::test_predict_risk_no_auth[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/api/test_xgboost_api_integration.py::[1mTestXGBoostAPIIntegration::test_get_model_info_no_auth[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/integration/infrastructure/persistence/repositories/test_repository.py::[1mTestPatientRepositoryIntegration::test_create_patient[0m - app.core.exceptions.base_exceptions.PersistenceError: Failed to create pati...
[31mFAILED[0m app/tests/integration/infrastructure/persistence/test_patient_encryption_integration.py::[1mTestPatientEncryptionIntegration::test_phi_encrypted_in_database[0m - sqlalchemy.exc.StatementError: (builtins.AttributeError) 'str' object has n...
[31mFAILED[0m app/tests/integration/infrastructure/persistence/test_patient_encryption_integration.py::[1mTestPatientEncryptionIntegration::test_phi_decrypted_in_repository[0m - sqlalchemy.exc.StatementError: (builtins.AttributeError) 'str' object has n...
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestAuthentication::test_missing_token[0m - assert 404 == 401
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestAuthentication::test_invalid_token_format[0m - assert 404 == 401
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestAuthentication::test_expired_token[0m - assert 404 == 401
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestAuthentication::test_tampered_token[0m - assert 404 == 401
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestAuthentication::test_valid_token_access[0m - ValueError: badly formed hexadecimal UUID string
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestAuthorization::test_patient_accessing_own_data[0m - ValueError: badly formed hexadecimal UUID string
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestAuthorization::test_patient_accessing_other_patient_data[0m - assert 404 == 403
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestAuthorization::test_provider_accessing_patient_data[0m - assert 404 == 200
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestInputValidation::test_invalid_input_format_rejected[0m - assert 404 == 422
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestInputValidation::test_input_sanitization_handling[0m - assert 404 == 422
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestInputValidation::test_input_length_limits_enforced[0m - assert 404 == 422
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestSecureHeaders::test_required_security_headers_present[0m - assert 404 == 200
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestSecureHeaders::test_cors_headers_configuration[0m - assert 404 == 200
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mTestErrorHandling::test_internal_server_error_masked[0m - assert 404 == 500
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mtest_access_patient_phi_data_success_provider[0m - assert 404 == 200
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mtest_access_patient_phi_data_unauthorized_patient[0m - assert 404 == 403
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mtest_access_patient_phi_data_patient_not_found[0m - AssertionError: Expected get_by_id to have been awaited once. Awaited 0 times.
[31mFAILED[0m app/tests/security/api/test_api_security.py::[1mtest_authenticated_but_unknown_role[0m - assert 404 == 403
[31mFAILED[0m app/tests/security/audit/test_phi_audit.py::[1mTestPHIAudit::test_clean_app_directory_special_case[0m - AssertionError: info('Found potential PHI in a clean_app directory: %s', '/...
[31mFAILED[0m app/tests/security/audit/test_phi_audit.py::[1mTestPHIAudit::test_audit_with_clean_files[0m - assert 4 == 0
[31mFAILED[0m app/tests/security/auth/test_auth_endpoints.py::[1mtest_login_success[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_endpoints.py::[1mtest_login_invalid_credentials[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_endpoints.py::[1mtest_login_inactive_account[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_endpoints.py::[1mtest_refresh_token_success[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_endpoints.py::[1mtest_refresh_token_invalid[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_endpoints.py::[1mtest_refresh_token_missing[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_endpoints.py::[1mtest_logout[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_endpoints.py::[1mtest_session_info_authenticated[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_endpoints.py::[1mtest_session_info_not_authenticated[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_hipaa_compliance.py::[1mTestHIPAAAuthCompliance::test_token_operations_audit_trail[0m - AssertionError: Expected 'encode' to have been called.
[31mFAILED[0m app/tests/security/auth/test_auth_middleware.py::[1mtest_public_route_access[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_middleware.py::[1mtest_protected_route_no_token[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_middleware.py::[1mtest_protected_route_with_valid_token[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_middleware.py::[1mtest_protected_route_with_invalid_token[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/auth/test_auth_middleware.py::[1mtest_protected_route_with_expired_token[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/security/db/test_db_phi_protection.py::[1mTestDBPHIProtection::test_data_encryption_at_rest[0m - AttributeError: 'coroutine' object has no attribute 'ssn'
[31mFAILED[0m app/tests/security/db/test_db_phi_protection.py::[1mTestDBPHIProtection::test_role_based_access_control[0m - app.core.exceptions.base_exceptions.PersistenceError: Invalid patient ID fo...
[31mFAILED[0m app/tests/security/db/test_db_phi_protection.py::[1mTestDBPHIProtection::test_patient_data_isolation[0m - app.core.exceptions.base_exceptions.PersistenceError: Invalid patient ID fo...
[31mFAILED[0m app/tests/security/db/test_db_phi_protection.py::[1mTestDBPHIProtection::test_audit_logging[0m - app.core.exceptions.base_exceptions.PersistenceError: Invalid patient ID fo...
[31mFAILED[0m app/tests/security/db/test_db_phi_protection.py::[1mTestDBPHIProtection::test_phi_filtering_by_role[0m - ValueError: Either db_session or db_session_factory must be provided
[31mFAILED[0m app/tests/security/db/test_db_phi_protection.py::[1mTestDBPHIProtection::test_transaction_rollback_on_error[0m - TypeError: UnitOfWork() takes no arguments
[31mFAILED[0m app/tests/security/db/test_db_phi_protection.py::[1mTestDBPHIProtection::test_phi_in_query_parameters[0m - AttributeError: 'method' object has no attribute 'side_effect'
[31mFAILED[0m app/tests/security/encryption/test_ml_encryption.py::[1mTestEncryptionService::test_encryption_is_deterministic[0m - AssertionError: assert 'v1:gAAAAABoF...mmiW8eU3iuuY=' == 'v1:gAAAAABoF...2Y...
[31mFAILED[0m app/tests/security/encryption/test_ml_encryption.py::[1mTestEncryptionService::test_handle_invalid_input[0m - Failed: DID NOT RAISE <class 'Exception'>
[31mFAILED[0m app/tests/security/encryption/test_ml_encryption.py::[1mTestFieldEncryption::test_encrypt_decrypt_fields[0m - TypeError: string indices must be integers, not 'str'
[31mFAILED[0m app/tests/security/jwt/test_jwt_service.py::[1mTestJWTService::test_decode_token_invalid_format[0m - assert 'Not enough segments' in "Invalid token: Invalid header string: 'utf...
[31mFAILED[0m app/tests/security/phi/test_patient_phi_security.py::[1mTestPatientPHISecurity::test_secure_error_handling[0m - AssertionError: Email should not be in error logs
[31mFAILED[0m app/tests/security/phi/test_phi_audit_logic.py::[1mTestPHIAuditLogic::test_audit_file_detection[0m - AssertionError: PHI test file should be detected correctly
[31mFAILED[0m app/tests/security/phi/test_phi_audit_logic.py::[1mTestPHIAuditLogic::test_strict_mode_disables_special_handling[0m - AssertionError: Audit should fail in strict mode even in clean_app directory
[31mFAILED[0m app/tests/security/phi/test_phi_code_patterns.py::[1mTestPHIInSourceFiles::test_python_file_with_phi[0m - AttributeError: 'PHICodeAnalyzer' object has no attribute 'scan_file'
[31mFAILED[0m app/tests/security/phi/test_phi_code_patterns.py::[1mTestPHIInSourceFiles::test_js_file_with_phi[0m - AttributeError: 'PHICodeAnalyzer' object has no attribute 'scan_file'
[31mFAILED[0m app/tests/security/phi/test_phi_code_patterns.py::[1mTestPHIInSourceFiles::test_config_file_with_phi[0m - AttributeError: 'PHICodeAnalyzer' object has no attribute 'scan_file'
[31mFAILED[0m app/tests/security/phi/test_phi_code_patterns.py::[1mTestPHIInSourceFiles::test_clean_file[0m - AttributeError: 'PHICodeAnalyzer' object has no attribute 'scan_file'
[31mFAILED[0m app/tests/security/phi/test_phi_code_patterns.py::[1mTestPHIInSourceFiles::test_directory_scan[0m - AttributeError: 'PHICodeAnalyzer' object has no attribute 'scan_directory'
[31mFAILED[0m app/tests/security/phi/test_phi_code_patterns.py::[1mTestPHIInSourceFiles::test_excluded_files[0m - AttributeError: 'PHICodeAnalyzer' object has no attribute 'scan_directory'
[31mFAILED[0m app/tests/security/phi/test_phi_code_patterns.py::[1mTestPHIInSourceFiles::test_audit_code_for_phi[0m - AttributeError: 'PHICodeAnalyzer' object has no attribute 'audit_code_for_phi'
[31mFAILED[0m app/tests/security/phi/test_phi_code_patterns.py::[1mTestPHIInSourceFiles::test_audit_api_endpoints[0m - AttributeError: 'PHICodeAnalyzer' object has no attribute 'audit_api_endpoi...
[31mFAILED[0m app/tests/security/phi/test_phi_code_patterns.py::[1mTestPHIInSourceFiles::test_audit_configuration[0m - AttributeError: 'PHICodeAnalyzer' object has no attribute 'audit_configurat...
[31mFAILED[0m app/tests/security/phi/test_phi_detection.py::[1mTestPHIDetection::test_ssn_pattern_detection[0m - AttributeError: 'PHIService' object has no attribute 'detect_phi'
[31mFAILED[0m app/tests/security/phi/test_phi_detection.py::[1mTestPHIDetection::test_audit_with_clean_app_directory[0m - AttributeError: 'types.SimpleNamespace' object has no attribute 'audit_code...
[31mFAILED[0m app/tests/security/phi/test_phi_detection.py::[1mTestPHIDetection::test_phi_in_normal_code[0m - AttributeError: 'types.SimpleNamespace' object has no attribute 'audit_code...
[31mFAILED[0m app/tests/security/phi/test_phi_detection.py::[1mTestPHIDetection::test_phi_in_test_files[0m - AttributeError: 'types.SimpleNamespace' object has no attribute 'audit_code...
[31mFAILED[0m app/tests/security/phi/test_phi_detection.py::[1mTestPHIDetection::test_api_endpoint_security[0m - AttributeError: 'types.SimpleNamespace' object has no attribute 'audit_api_...
[31mFAILED[0m app/tests/security/phi/test_phi_detection.py::[1mTestPHIDetection::test_config_security_classification[0m - AttributeError: 'types.SimpleNamespace' object has no attribute 'audit_conf...
[31mFAILED[0m app/tests/security/phi/test_phi_middleware.py::[1mTestPHIMiddleware::test_whitelist_patterns[0m - assert 'John Smith' in '{"patient": {"name": "[REDACTED NAME]", "ssn": "[RE...
[31mFAILED[0m app/tests/security/phi/test_phi_middleware.py::[1mTestPHIMiddleware::test_add_phi_middleware[0m - AssertionError: Expected 'mock' to have been called once. Called 0 times.
[31mFAILED[0m app/tests/standalone/core/test_biometric_event_processor.py::[1mTestAlertRule::test_init_invalid_condition[0m - Failed: DID NOT RAISE <class 'app.domain.exceptions.ValidationError'>
[31mFAILED[0m app/tests/standalone/core/test_biometric_event_processor.py::[1mTestBiometricEventProcessor::test_register_observer[0m - AssertionError
[31mFAILED[0m app/tests/standalone/core/test_biometric_event_processor.py::[1mTestBiometricEventProcessor::test_process_data_point_no_alert[0m - AttributeError: 'BiometricEventProcessor' object has no attribute 'alerts'
[31mFAILED[0m app/tests/standalone/core/test_biometric_event_processor.py::[1mTestBiometricEventProcessor::test_process_data_point_with_alert[0m - AttributeError: 'BiometricEventProcessor' object has no attribute 'alerts'
[31mFAILED[0m app/tests/standalone/core/test_biometric_event_processor.py::[1mTestAlertObservers::test_in_app_observer[0m - TypeError: InAppAlertObserver.__init__() missing 1 required positional argu...
[31mFAILED[0m app/tests/standalone/core/test_biometric_event_processor.py::[1mTestAlertObservers::test_email_observer[0m - TypeError: EmailAlertObserver.__init__() missing 1 required positional argu...
[31mFAILED[0m app/tests/standalone/core/test_biometric_event_processor.py::[1mTestAlertObservers::test_sms_observer[0m - TypeError: SMSAlertObserver.__init__() missing 1 required positional argume...
[31mFAILED[0m app/tests/standalone/core/test_mock_mentallama.py::[1mTestMockMentaLLaMA::test_process_general[0m - AttributeError: 'MentaLLaMAResult' object has no attribute 'dict'
[31mFAILED[0m app/tests/standalone/core/test_mock_mentallama.py::[1mTestMockMentaLLaMA::test_process_risk_assessment[0m - AttributeError: 'MentaLLaMAResult' object has no attribute 'dict'
[31mFAILED[0m app/tests/standalone/core/test_mock_mentallama.py::[1mTestMockMentaLLaMA::test_detect_depression_positive[0m - TypeError: object dict can't be used in 'await' expression
[31mFAILED[0m app/tests/standalone/core/test_mock_mentallama.py::[1mTestMockMentaLLaMA::test_detect_depression_negative[0m - TypeError: object dict can't be used in 'await' expression
[31mFAILED[0m app/tests/standalone/core/test_pat_mock.py::[1mTestMockPATAnalysis::test_analyze_actigraphy_success[0m - AssertionError
[31mFAILED[0m app/tests/standalone/core/test_pat_mock.py::[1mTestMockPATAnalysis::test_analyze_actigraphy_invalid_analysis_types[0m - Failed: DID NOT RAISE <class 'app.core.services.ml.pat.exceptions.Validatio...
[31mFAILED[0m app/tests/standalone/core/test_pat_mock.py::[1mTestMockPATProfileManagement::test_create_patient_profile_success[0m - AssertionError
[31mFAILED[0m app/tests/standalone/core/test_pat_mock.py::[1mTestMockPATProfileManagement::test_get_patient_profile_success[0m - KeyError: 'data'
[31mFAILED[0m app/tests/standalone/core/test_pat_mock.py::[1mTestMockPATProfileManagement::test_get_patient_profile_wrong_patient[0m - app.core.services.ml.pat.exceptions.ResourceNotFoundError: Profile for pati...
[31mFAILED[0m app/tests/standalone/core/test_pat_mock.py::[1mTestMockPATProfileManagement::test_update_patient_profile_success[0m - KeyError: 'data'
[31mFAILED[0m app/tests/standalone/core/test_pat_mock.py::[1mTestMockPATProfileManagement::test_update_patient_profile_wrong_patient[0m - app.core.services.ml.pat.exceptions.ResourceNotFoundError: Profile for pati...
[31mFAILED[0m app/tests/standalone/core/test_pat_mock.py::[1mTestMockPATIntegration::test_integrate_with_digital_twin_success[0m - AssertionError
[31mFAILED[0m app/tests/standalone/core/test_pat_mock.py::[1mTestMockPATIntegration::test_integrate_with_digital_twin_profile_not_found[0m - app.core.services.ml.pat.exceptions.AuthorizationError: Analysis fb7e9112-f...
[31mFAILED[0m app/tests/standalone/core/test_standalone_biometric_processor.py::[1mTestAlertRule::test_evaluate_greater_than_or_equal[0m - AssertionError: False is not true
[31mFAILED[0m app/tests/standalone/core/test_standalone_biometric_processor.py::[1mTestAlertRule::test_evaluate_less_than_or_equal[0m - AssertionError: False is not true
[31mFAILED[0m app/tests/standalone/core/test_standalone_digital_twin.py::[1mTestNeurotransmitterTwinModel::test_simulate_medication_effect[0m - AssertionError: 1.51 != 1.3 within 5 places (0.20999999999999996 difference)
[31mFAILED[0m app/tests/standalone/core/test_standalone_pat_mock.py::[1mTestStandaloneMockPAT::test_initialization[0m - app.core.exceptions.base_exceptions.InitializationError: Mock PAT service n...
[31mFAILED[0m app/tests/standalone/core/test_standalone_pat_mock.py::[1mTestStandaloneMockPAT::test_device_info_validation[0m - AttributeError: 'MockPATService' object has no attribute '_validate_device_...
[31mFAILED[0m app/tests/standalone/core/test_standalone_pat_mock.py::[1mTestStandaloneMockPAT::test_analysis_types_validation[0m - Failed: DID NOT RAISE <class 'app.core.services.ml.pat.exceptions.Validatio...
[31mFAILED[0m app/tests/standalone/core/test_standalone_pat_mock.py::[1mTestStandaloneMockPAT::test_analyze_actigraphy[0m - app.core.exceptions.base_exceptions.ValidationError: Device info must conta...
[31mFAILED[0m app/tests/standalone/core/test_standalone_pat_mock.py::[1mTestStandaloneMockPAT::test_get_analysis_by_id[0m - app.core.exceptions.base_exceptions.ValidationError: Device info must conta...
[31mFAILED[0m app/tests/standalone/core/test_standalone_pat_mock.py::[1mTestStandaloneMockPAT::test_get_nonexistent_analysis[0m - AttributeError: 'MockPATService' object has no attribute 'get_analysis'. Di...
[31mFAILED[0m app/tests/standalone/core/test_standalone_phi_sanitizer.py::[1mTestPHIPattern::test_redact_partial_ssn[0m - AssertionError
[31mFAILED[0m app/tests/standalone/core/test_standalone_phi_sanitizer.py::[1mTestPHIPattern::test_redact_partial_phone[0m - AssertionError
[31mFAILED[0m app/tests/standalone/core/test_standalone_phi_sanitizer.py::[1mTestPHISanitizer::test_sanitize_address[0m - AssertionError
[31mFAILED[0m app/tests/standalone/core/test_standalone_phi_sanitizer.py::[1mTestSanitizedLogger::test_log_methods[0m - AssertionError
[31mFAILED[0m app/tests/standalone/core/test_standalone_phi_sanitizer.py::[1mTestSanitizedLogger::test_exception_method[0m - AssertionError
[31mFAILED[0m app/tests/standalone/core/test_utils.py::[1mtest_sanitize_name[0m - AssertionError
[31mFAILED[0m app/tests/standalone/core/test_utils.py::[1mtest_truncate_text[0m - AssertionError
[31mFAILED[0m app/tests/standalone/domain/test_exceptions.py::[1mTestMentalLLaMAExceptions::test_connection_error[0m - AssertionError
[31mFAILED[0m app/tests/standalone/domain/test_exceptions.py::[1mTestMentalLLaMAExceptions::test_connection_error_without_details[0m - AssertionError
[31mFAILED[0m app/tests/standalone/domain/test_exceptions.py::[1mTestMentalLLaMAExceptions::test_inference_error[0m - TypeError: MentalLLaMAInferenceError.__init__() takes from 2 to 4 positiona...
[31mFAILED[0m app/tests/standalone/domain/test_exceptions.py::[1mTestMentalLLaMAExceptions::test_inference_error_without_parameters[0m - AttributeError: 'MentalLLaMAInferenceError' object has no attribute 'model_...
[31mFAILED[0m app/tests/standalone/domain/test_exceptions.py::[1mTestMentalLLaMAExceptions::test_validation_error[0m - AssertionError
[31mFAILED[0m app/tests/standalone/domain/test_exceptions.py::[1mTestMentalLLaMAExceptions::test_validation_error_without_details[0m - AssertionError
[31mFAILED[0m app/tests/standalone/domain/test_exceptions.py::[1mTestMentalLLaMAExceptions::test_exception_context_isolation[0m - AssertionError
[31mFAILED[0m app/tests/standalone/domain/test_patient.py::[1mTestPatient::test_patient_id_validation[0m - Failed: DID NOT RAISE <class 'app.tests.mocks.patient_mock.ValidationExcept...
[31mFAILED[0m app/tests/standalone/domain/test_patient.py::[1mTestPatient::test_patient_name_validation[0m - Failed: DID NOT RAISE <class 'app.tests.mocks.patient_mock.ValidationExcept...
[31mFAILED[0m app/tests/standalone/domain/test_patient.py::[1mTestPatient::test_patient_date_of_birth_validation[0m - Failed: DID NOT RAISE <class 'app.tests.mocks.patient_mock.ValidationExcept...
[31mFAILED[0m app/tests/standalone/domain/test_patient.py::[1mTestPatient::test_add_medication[0m - app.tests.mocks.patient_mock.ValidationException: Medication must have a name
[31mFAILED[0m app/tests/standalone/domain/test_patient.py::[1mTestPatient::test_remove_medication[0m - app.tests.mocks.patient_mock.ValidationException: Medication must have a name
[31mFAILED[0m app/tests/standalone/domain/test_patient_model.py::[1mTestPatientModel::test_patient_creation_invalid_name[0m - Failed: DID NOT RAISE <class 'ValueError'>
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_validate_times[0m - Failed: DID NOT RAISE <class 'app.domain.exceptions.InvalidAppointmentTimeE...
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_validate_required_fields[0m - TypeError: Appointment.__init__() missing 1 required positional argument: '...
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_confirm_appointment[0m - AttributeError: 'Appointment' object has no attribute 'confirm'
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_cannot_confirm_completed_appointment[0m - AttributeError: 'Appointment' object has no attribute 'complete'
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_cancel_appointment[0m - AttributeError: 'Appointment' object has no attribute 'cancel'
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_cannot_cancel_completed_appointment[0m - AttributeError: 'Appointment' object has no attribute 'complete'
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_reschedule_appointment[0m - AssertionError
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_complete_appointment[0m - AttributeError: 'Appointment' object has no attribute 'complete'
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_cannot_complete_cancelled_appointment[0m - AttributeError: 'Appointment' object has no attribute 'cancel'
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_no_show_appointment[0m - AttributeError: 'Appointment' object has no attribute 'mark_no_show'
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_cannot_no_show_cancelled_appointment[0m - AttributeError: 'Appointment' object has no attribute 'cancel'
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_update_notes[0m - AttributeError: 'Appointment' object has no attribute 'update_notes'. Did y...
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_update_location[0m - AttributeError: 'Appointment' object has no attribute 'update_location'
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_to_dict[0m - AttributeError: 'Appointment' object has no attribute 'to_dict'
[31mFAILED[0m app/tests/standalone/infrastructure/test_appointment.py::[1mTestAppointment::test_from_dict[0m - AttributeError: 'Appointment' object has no attribute 'to_dict'
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_analyze_actigraphy_success[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_analyze_actigraphy_unauthorized[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_analyze_actigraphy_validation_error[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_analyze_actigraphy_analysis_error[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_get_actigraphy_embeddings_success[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_get_actigraphy_embeddings_unauthorized[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_get_actigraphy_embeddings_validation_error[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_get_actigraphy_embeddings_embedding_error[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_get_analysis_by_id_success[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_get_analysis_by_id_not_found[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_get_analysis_by_id_unauthorized[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_get_patient_analyses_success[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_get_patient_analyses_unauthorized[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_get_model_info_success[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_integrate_with_digital_twin_success[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_get_analysis_types_success[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_integrate_with_digital_twin_unauthorized[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_integrate_with_digital_twin_not_found[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_integrate_with_digital_twin_authorization_error[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_integrate_with_digital_twin_validation_error[0m - AssertionError
[31mFAILED[0m app/tests/unit/api/routes/test_actigraphy_routes.py::[1mTestActigraphyRoutes::test_integrate_with_digital_twin_integration_error[0m - AssertionError
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py::[1mTestBatchProcessAnalyticsUseCase::test_execute_with_empty_batch[0m - AssertionError: expected call not found.
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py::[1mTestBatchProcessAnalyticsUseCase::test_execute_with_valid_events[0m - AttributeError: 'function' object has no attribute 'call_count'
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py::[1mTestBatchProcessAnalyticsUseCase::test_partial_failure_handling[0m - AssertionError: assert 0 == 2
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py::[1mTestBatchProcessAnalyticsUseCase::test_event_timestamp_handling[0m - AttributeError: 'function' object has no attribute 'call_args_list'
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py::[1mTestBatchProcessAnalyticsUseCase::test_batch_metadata_saved[0m - AttributeError: 'function' object has no attribute 'assert_any_call'
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_batch_process_analytics.py::[1mTestBatchProcessAnalyticsUseCase::test_large_batch_chunking[0m - AttributeError: 'function' object has no attribute 'call_count'
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_process_analytics_event.py::[1mTestProcessAnalyticsEventUseCase::test_execute_with_all_parameters[0m - AttributeError: 'function' object has no attribute 'assert_called_once'
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_process_analytics_event.py::[1mTestProcessAnalyticsEventUseCase::test_execute_with_minimal_parameters[0m - AssertionError: expected call not found.
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_process_analytics_event.py::[1mTestProcessAnalyticsEventUseCase::test_real_time_counter_updates[0m - AttributeError: 'function' object has no attribute 'assert_any_call'
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_process_analytics_event.py::[1mTestProcessAnalyticsEventUseCase::test_phi_not_logged[0m - AssertionError: expected call not found.
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_process_analytics_event.py::[1mTestProcessAnalyticsEventUseCase::test_repository_error_handling[0m - Failed: DID NOT RAISE <class 'Exception'>
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py::[1mTestRetrieveAggregatedAnalyticsUseCase::test_execute_with_basic_parameters[0m - AttributeError: 'function' object has no attribute 'assert_called_once'
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py::[1mTestRetrieveAggregatedAnalyticsUseCase::test_execute_with_filters_and_time_range[0m - AttributeError: 'function' object has no attribute 'call_args'
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py::[1mTestRetrieveAggregatedAnalyticsUseCase::test_time_range_string_handling[0m - TypeError: can't compare offset-naive and offset-aware datetimes
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py::[1mTestRetrieveAggregatedAnalyticsUseCase::test_invalid_time_range_handling[0m - TypeError: can't compare offset-naive and offset-aware datetimes
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py::[1mTestRetrieveAggregatedAnalyticsUseCase::test_dimension_sanitization[0m - AttributeError: 'function' object has no attribute 'call_args'
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py::[1mTestRetrieveAggregatedAnalyticsUseCase::test_filter_sanitization[0m - AttributeError: 'function' object has no attribute 'call_args'
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py::[1mTestRetrieveAggregatedAnalyticsUseCase::test_caching_behavior[0m - AttributeError: 'function' object has no attribute 'call_count'
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py::[1mTestRetrieveAggregatedAnalyticsUseCase::test_empty_dimensions_default[0m - AttributeError: 'function' object has no attribute 'call_args'
[31mFAILED[0m app/tests/unit/application/use_cases/analytics/test_retrieve_aggregated_analytics.py::[1mTestRetrieveAggregatedAnalyticsUseCase::test_very_large_time_range_limit[0m - AttributeError: 'function' object has no attribute 'call_args'
[31mFAILED[0m app/tests/unit/core/config/test_ml_settings.py::[1mTestMLSettingsStructure::test_nested_xgboost_defaults[0m - AttributeError: 'XGBoostSettings' object has no attribute 'sagemaker_endpoi...
[31mFAILED[0m app/tests/unit/core/config/test_ml_settings.py::[1mTestEnums::test_model_type_enum[0m - AttributeError: type object 'ModelType' has no attribute 'LSTM'
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_mock_pat.py::[1mTestMockPAT::test_analyze_actigraphy_missing_patient_id[0m - app.core.exceptions.base_exceptions.ValidationError: Patient ID is required
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_mock_pat.py::[1mTestMockPAT::test_analyze_actigraphy_invalid_sampling_rate[0m - app.core.exceptions.base_exceptions.ValidationError: Sampling rate must be ...
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_mock_pat.py::[1mTestMockPAT::test_analyze_actigraphy_insufficient_readings[0m - app.core.exceptions.base_exceptions.ValidationError: At least 10 readings a...
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_mock_pat.py::[1mTestMockPAT::test_analyze_actigraphy_invalid_reading_format[0m - app.core.exceptions.base_exceptions.ValidationError: Reading format invalid...
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_mock_pat.py::[1mTestMockPAT::test_analyze_actigraphy_unsupported_analysis_type[0m - app.core.exceptions.base_exceptions.ValidationError: Unsupported analysis t...
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_mock_pat.py::[1mTestMockPAT::test_get_analysis_by_id_not_found[0m - app.core.exceptions.base_exceptions.ResourceNotFoundError: Analysis not found
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_mock_pat.py::[1mTestMockPAT::test_integrate_with_digital_twin_analysis_not_found[0m - app.core.exceptions.base_exceptions.ResourceNotFoundError: Analysis not found
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_pat_factory.py::[1mTestPATServiceFactory::test_cache_key_generation[0m - AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray...
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_pat_factory.py::[1mTestPATServiceFactory::test_different_configs_create_different_instances[0m - AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray...
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_pat_factory.py::[1mTestPATServiceFactory::test_get_bedrock_pat[0m - AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray...
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_pat_factory.py::[1mTestPATServiceFactory::test_get_default_provider[0m - AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray...
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_pat_factory.py::[1mTestPATServiceFactory::test_get_mock_pat[0m - AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray...
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_pat_factory.py::[1mTestPATServiceFactory::test_get_unknown_provider[0m - AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray...
[31mFAILED[0m app/tests/unit/core/services/ml/pat/test_pat_factory.py::[1mTestPATServiceFactory::test_instance_caching[0m - AttributeError: <module 'app.core.services.ml.pat.factory' from '/Users/ray...
[31mFAILED[0m app/tests/unit/core/services/ml/test_factory.py::[1mTestMLServiceFactory::test_create_mentalllama_service_invalid[0m - AttributeError: 'MLServiceFactory' object has no attribute 'create_mentalll...
[31mFAILED[0m app/tests/unit/core/services/ml/test_factory.py::[1mTestMLServiceFactory::test_shutdown[0m - AttributeError: 'MLServiceFactory' object has no attribute '_mental_llama_i...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock.py::[1mTestMockMentaLLaMA::test_initialization[0m - Failed: DID NOT RAISE <class 'app.core.exceptions.base_exceptions.InvalidCo...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock.py::[1mTestMockMentaLLaMA::test_digital_twin_session_workflow[0m - TypeError: MockMentaLLaMA.generate_digital_twin() got an unexpected keyword...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock.py::[1mTestMockPHIDetection::test_detect_phi_valid_inputs[0m - AssertionError: assert 'text' in {'confidence': 0.89, 'end': 12, 'id': 'ent...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock.py::[1mTestMockPHIDetection::test_redact_phi[0m - AssertionError: assert '[PHI]' in '[REDACTED] Smith (SSN: [REDACTED]) was a...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_dt.py::[1mTestMockDigitalTwinService::test_initialization[0m - assert not True
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_dt.py::[1mTestMockDigitalTwinService::test_create_session[0m - TypeError: MockDigitalTwinService.create_session() missing 1 required posit...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_dt.py::[1mTestMockDigitalTwinService::test_get_session[0m - TypeError: MockDigitalTwinService.create_session() missing 1 required posit...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_dt.py::[1mTestMockDigitalTwinService::test_send_message[0m - TypeError: MockDigitalTwinService.create_session() missing 1 required posit...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_dt.py::[1mTestMockDigitalTwinService::test_message_response_types[0m - TypeError: MockDigitalTwinService.create_session() missing 1 required posit...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_dt.py::[1mTestMockDigitalTwinService::test_end_session[0m - TypeError: MockDigitalTwinService.create_session() missing 1 required posit...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_dt.py::[1mTestMockDigitalTwinService::test_get_insights[0m - app.core.exceptions.base_exceptions.ResourceNotFoundError: Mock digital twi...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_dt.py::[1mTestMockDigitalTwinService::test_mood_insights[0m - TypeError: MockDigitalTwinService.get_insights() got an unexpected keyword ...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_dt.py::[1mTestMockDigitalTwinService::test_activity_insights[0m - TypeError: MockDigitalTwinService.get_insights() got an unexpected keyword ...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_dt.py::[1mTestMockDigitalTwinService::test_sleep_insights[0m - TypeError: MockDigitalTwinService.get_insights() got an unexpected keyword ...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_dt.py::[1mTestMockDigitalTwinService::test_medication_insights[0m - TypeError: MockDigitalTwinService.get_insights() got an unexpected keyword ...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_dt.py::[1mTestMockDigitalTwinService::test_treatment_insights[0m - TypeError: MockDigitalTwinService.get_insights() got an unexpected keyword ...
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_mentallama.py::[1mTestMockMentaLLaMA::test_process_returns_expected_structure[0m - ValueError: Invalid isoformat string: '2025-05-03T01:52:49.684158+00:00+00:00'
[31mFAILED[0m app/tests/unit/core/services/ml/test_mock_mentallama.py::[1mTestMockMentaLLaMA::test_digital_twin_session_workflow[0m - TypeError: MockMentaLLaMA.generate_digital_twin() got an unexpected keyword...
[31mFAILED[0m app/tests/unit/core/services/ml/test_phi_detection_core.py::[1mTestAWSComprehendMedicalPHIDetection::test_initialization[0m - AssertionError: Expected 'client' to have been called once. Called 0 times.
[31mFAILED[0m app/tests/unit/core/services/ml/test_phi_detection_core.py::[1mTestAWSComprehendMedicalPHIDetection::test_initialization_boto_error[0m - Failed: DID NOT RAISE <class 'app.core.exceptions.base_exceptions.InvalidCo...
[31mFAILED[0m app/tests/unit/core/services/ml/test_phi_detection_core.py::[1mTestAWSComprehendMedicalPHIDetection::test_detect_phi_with_phi[0m - AttributeError: 'AWSComprehendMedicalPHIDetection' object has no attribute ...
[31mFAILED[0m app/tests/unit/core/services/ml/test_phi_detection_core.py::[1mTestAWSComprehendMedicalPHIDetection::test_detect_phi_without_phi[0m - AttributeError: 'AWSComprehendMedicalPHIDetection' object has no attribute ...
[31mFAILED[0m app/tests/unit/core/services/ml/test_phi_detection_core.py::[1mTestAWSComprehendMedicalPHIDetection::test_detect_phi_aws_error[0m - AttributeError: 'AWSComprehendMedicalPHIDetection' object has no attribute ...
[31mFAILED[0m app/tests/unit/core/services/ml/test_phi_detection_core.py::[1mTestAWSComprehendMedicalPHIDetection::test_redact_phi_with_phi[0m - AttributeError: 'AWSComprehendMedicalPHIDetection' object has no attribute ...
[31mFAILED[0m app/tests/unit/core/services/ml/test_phi_detection_core.py::[1mTestAWSComprehendMedicalPHIDetection::test_redact_phi_without_phi[0m - AttributeError: 'AWSComprehendMedicalPHIDetection' object has no attribute ...
[31mFAILED[0m app/tests/unit/core/test_database.py::[1mtest_get_engine[0m - AssertionError: assert namespace(echo=False, future=True, pool_pre_ping=Tru...
[31mFAILED[0m app/tests/unit/core/test_database.py::[1mtest_get_session_local[0m - AssertionError: Expected 'sessionmaker' to have been called once. Called 0 ...
[31mFAILED[0m app/tests/unit/core/utils/test_encryption_unit.py::[1mTestEncryptionService::test_initialization[0m - AttributeError: 'BaseEncryptionService' object has no attribute 'secret_key...
[31mFAILED[0m app/tests/unit/core/utils/test_encryption_unit.py::[1mTestEncryptionService::test_initialization_with_missing_key[0m - Failed: DID NOT RAISE <class 'ValueError'>
[31mFAILED[0m app/tests/unit/core/utils/test_encryption_unit.py::[1mTestEncryptionService::test_encrypt_decrypt_string[0m - AttributeError: 'BaseEncryptionService' object has no attribute 'encrypt_st...
[31mFAILED[0m app/tests/unit/core/utils/test_encryption_unit.py::[1mTestEncryptionService::test_encrypt_decrypt_empty_string[0m - AttributeError: 'BaseEncryptionService' object has no attribute 'encrypt_st...
[31mFAILED[0m app/tests/unit/core/utils/test_encryption_unit.py::[1mTestEncryptionService::test_decrypt_invalid_string[0m - AttributeError: 'BaseEncryptionService' object has no attribute 'decrypt_st...
[31mFAILED[0m app/tests/unit/core/utils/test_encryption_unit.py::[1mTestEncryptionService::test_encrypt_decrypt_dict[0m - TypeError: BaseEncryptionService.encrypt_dict() takes 2 positional argument...
[31mFAILED[0m app/tests/unit/core/utils/test_encryption_unit.py::[1mTestEncryptionService::test_encrypt_decrypt_nested_dict[0m - TypeError: BaseEncryptionService.encrypt_dict() takes 2 positional argument...
[31mFAILED[0m app/tests/unit/core/utils/test_encryption_unit.py::[1mTestEncryptionService::test_generate_verify_hash[0m - AttributeError: 'BaseEncryptionService' object has no attribute 'generate_h...
[31mFAILED[0m app/tests/unit/core/utils/test_encryption_unit.py::[1mTestEncryptionService::test_generate_verify_hmac[0m - AttributeError: 'BaseEncryptionService' object has no attribute 'generate_h...
[31mFAILED[0m app/tests/unit/core/utils/test_logging_enhanced.py::[1mTestGetLogger::test_get_logger_configuration[0m - AssertionError: Expected 'Formatter' to have been called once. Called 0 times.
[31mFAILED[0m app/tests/unit/domain/entities/digital_twin/test_digital_twin_entity.py::[1mTestDigitalTwin::test_init_default_values[0m - AssertionError: assert _PatchedDateTime(2025, 5, 3, 1, 52, 49, 820868, tzin...
[31mFAILED[0m app/tests/unit/domain/entities/test_patient_entity.py::[1mTestPatientContactInfo::test_contact_info_descriptor[0m - AssertionError: <class 'app.domain.entities.patient.ContactInfo'> is not an...
[31mFAILED[0m app/tests/unit/domain/entities/test_patient_entity.py::[1mTestPatientContactInfo::test_contact_info_with_dict[0m - AssertionError: <class 'app.domain.entities.patient.ContactInfo'> is not an...
[31mFAILED[0m app/tests/unit/domain/entities/test_patient_entity.py::[1mTestPatientContactInfo::test_contact_info_with_object[0m - AssertionError: <class 'app.domain.entities.patient.ContactInfo'> is not an...
[31mFAILED[0m app/tests/unit/domain/services/test_biometric_integration_service.py::[1mTestBiometricIntegrationService::test_get_or_create_biometric_twin_existing[0m - TypeError: BiometricTwin.__init__() missing 1 required positional argument:...
[31mFAILED[0m app/tests/unit/domain/services/test_biometric_integration_service.py::[1mTestBiometricIntegrationService::test_get_or_create_biometric_twin_new[0m - assert False
[31mFAILED[0m app/tests/unit/domain/services/test_biometric_integration_service.py::[1mTestBiometricIntegrationService::test_get_or_create_biometric_twin_error[0m - Exception: Database error
[31mFAILED[0m app/tests/unit/domain/services/test_biometric_integration_service.py::[1mTestBiometricIntegrationService::test_add_biometric_data[0m - app.domain.exceptions.base.DomainException: Failed to add biometric data: 2...
[31mFAILED[0m app/tests/unit/domain/services/test_biometric_integration_service.py::[1mTestBiometricIntegrationService::test_batch_add_biometric_data[0m - app.domain.exceptions.base.DomainException: Failed to batch add biometric d...
[31mFAILED[0m app/tests/unit/domain/services/test_biometric_integration_service.py::[1mTestBiometricIntegrationService::test_get_biometric_data[0m - TypeError: BiometricTwin.__init__() got an unexpected keyword argument 'dat...
[31mFAILED[0m app/tests/unit/domain/services/test_biometric_integration_service.py::[1mTestBiometricIntegrationService::test_get_biometric_data_no_twin[0m - app.domain.exceptions.base.DomainException: Failed to retrieve biometric da...
[31mFAILED[0m app/tests/unit/domain/services/test_biometric_integration_service.py::[1mTestBiometricIntegrationService::test_analyze_trends[0m - TypeError: BiometricTwin.__init__() got an unexpected keyword argument 'dat...
[31mFAILED[0m app/tests/unit/domain/services/test_biometric_integration_service.py::[1mTestBiometricIntegrationService::test_detect_correlations[0m - TypeError: BiometricTwin.__init__() got an unexpected keyword argument 'dat...
[31mFAILED[0m app/tests/unit/domain/services/test_biometric_integration_service.py::[1mTestBiometricIntegrationService::test_connect_device[0m - app.domain.exceptions.base.DomainException: Failed to connect device: 'coro...
[31mFAILED[0m app/tests/unit/domain/services/test_clinical_rule_engine.py::[1mTestClinicalRuleEngine::test_get_active_rules_for_patient[0m - AttributeError: 'BiometricRule' object has no attribute 'created_at'
[31mFAILED[0m app/tests/unit/domain/test_biometric_alert.py::[1mTestBiometricAlert::test_biometric_alert_acknowledged[0m - TypeError: BiometricAlert.acknowledge() takes 2 positional arguments but 3 ...
[31mFAILED[0m app/tests/unit/domain/test_biometric_alert.py::[1mTestBiometricAlert::test_biometric_alert_resolved[0m - AttributeError: 'BiometricAlert' object has no attribute 'resolve'
[31mFAILED[0m app/tests/unit/domain/test_patient.py::[1mtest_create_patient[0m - AssertionError: assert None == 'john.doe@example.com'
[31mFAILED[0m app/tests/unit/domain/test_patient.py::[1mtest_update_patient[0m - AssertionError: assert None == 'jane.smith@example.com'
[31mFAILED[0m app/tests/unit/domain/value_objects/test_value_objects_enhanced.py::[1mTestEmergencyContact::test_emergency_contact_creation[0m - AssertionError: assert False
[31mFAILED[0m app/tests/unit/domain/value_objects/test_value_objects_enhanced.py::[1mTestEmergencyContact::test_emergency_contact_validation[0m - AssertionError: Regex pattern did not match.
[31mFAILED[0m app/tests/unit/domain/value_objects/test_value_objects_enhanced.py::[1mTestEmergencyContact::test_emergency_contact_to_dict[0m - AssertionError: assert '[REDACTED]' == 'Jane Doe'
[31mFAILED[0m app/tests/unit/domain/value_objects/test_value_objects_enhanced.py::[1mTestPsychiatricAssessment::test_psychiatric_assessment_creation[0m - TypeError: PsychiatricAssessment.__init__() got an unexpected keyword argum...
[31mFAILED[0m app/tests/unit/domain/value_objects/test_value_objects_enhanced.py::[1mTestPsychiatricAssessment::test_psychiatric_assessment_validation[0m - TypeError: PsychiatricAssessment.__init__() got an unexpected keyword argum...
[31mFAILED[0m app/tests/unit/domain/value_objects/test_value_objects_enhanced.py::[1mTestPsychiatricAssessment::test_psychiatric_assessment_optional_fields[0m - TypeError: PsychiatricAssessment.__init__() got an unexpected keyword argum...
[31mFAILED[0m app/tests/unit/domain/value_objects/test_value_objects_enhanced.py::[1mTestPsychiatricAssessment::test_psychiatric_assessment_equality[0m - TypeError: PsychiatricAssessment.__init__() got an unexpected keyword argum...
[31mFAILED[0m app/tests/unit/domain/value_objects/test_value_objects_enhanced.py::[1mTestPsychiatricAssessment::test_psychiatric_assessment_repr[0m - TypeError: PsychiatricAssessment.__init__() got an unexpected keyword argum...
[31mFAILED[0m app/tests/unit/domain/value_objects/test_value_objects_enhanced.py::[1mTestPsychiatricAssessment::test_psychiatric_assessment_to_dict[0m - TypeError: PsychiatricAssessment.__init__() got an unexpected keyword argum...
[31mFAILED[0m app/tests/unit/domain/value_objects/test_value_objects_enhanced.py::[1mTestPsychiatricAssessment::test_psychiatric_assessment_from_dict[0m - AttributeError: type object 'PsychiatricAssessment' has no attribute 'from_...
[31mFAILED[0m app/tests/unit/domain/value_objects/test_value_objects_enhanced.py::[1mTestContactInfoValueObject::test_contact_info_optional_fields[0m - TypeError: ContactInfo.__init__() missing 1 required positional argument: '...
[31mFAILED[0m app/tests/unit/domain/value_objects/test_value_objects_enhanced.py::[1mTestContactInfoValueObject::test_contact_info_to_dict[0m - AssertionError: assert {'email': 'pa...555-123-4567'} == {'email': 'pa...ho...
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_get_nonexistent_key[0m - AssertionError: Expected 'get' to be called once. Called 0 times.
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_get_existing_key[0m - AssertionError: assert None == {'nested': {'data': 123}, 'test': 'value'}
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_get_invalid_json[0m - AssertionError: Expected 'get' to be called once. Called 0 times.
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_set_simple_value[0m - assert False is True
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_set_complex_value[0m - assert False is True
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_set_redis_error[0m - AssertionError: Expected 'setex' to have been called once. Called 0 times.
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_delete_existing_key[0m - assert 0 is True
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_delete_nonexistent_key[0m - assert 0 is True
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_delete_redis_error[0m - assert 0 is False
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_exists_true[0m - assert False is True
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_exists_false[0m - AssertionError: Expected 'exists' to be called once. Called 0 times.
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_exists_redis_error[0m - AssertionError: Expected 'exists' to be called once. Called 0 times.
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_increment_success[0m - TypeError: RedisCache.increment() takes 2 positional arguments but 3 were g...
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_increment_redis_error[0m - TypeError: RedisCache.increment() takes 2 positional arguments but 3 were g...
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_get_ttl_success[0m - AttributeError: 'RedisCache' object has no attribute 'get_ttl'
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_get_ttl_nonexistent_key[0m - AttributeError: 'RedisCache' object has no attribute 'get_ttl'
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_get_ttl_persistent_key[0m - AttributeError: 'RedisCache' object has no attribute 'get_ttl'
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mTestRedisCache::test_get_ttl_redis_error[0m - AttributeError: 'RedisCache' object has no attribute 'get_ttl'
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mtest_no_redis_available[0m - AttributeError: 'RedisCache' object has no attribute 'redis_client'
[31mFAILED[0m app/tests/unit/infrastructure/cache/test_redis_cache.py::[1mtest_methods_with_no_redis_client[0m - AttributeError: 'RedisCache' object has no attribute 'redis_client'
[31mFAILED[0m app/tests/unit/infrastructure/ml/phi_detection/test_phi_detection_service.py::[1mTestPHIDetectionService::test_redact_phi[0m - AssertionError: assert '[REDACTED:' in '[REDACTED] [REDACTED] ([REDACTED].'
[31mFAILED[0m app/tests/unit/infrastructure/ml/phi_detection/test_phi_detection_service.py::[1mTestPHIDetectionService::test_error_handling[0m - app.core.exceptions.ml_exceptions.PHISecurityError: Failed to detect PHI: T...
[31mFAILED[0m app/tests/unit/infrastructure/ml/symptom_forecasting/test_xgboost_model.py::[1mTestXGBoostSymptomModel::test_load_model_success[0m - AssertionError: Expected 'load' to be called once. Called 0 times.
[31mFAILED[0m app/tests/unit/infrastructure/ml/symptom_forecasting/test_xgboost_model.py::[1mTestXGBoostSymptomModel::test_load_model_file_not_found[0m - Failed: DID NOT RAISE <class 'FileNotFoundError'>
[31mFAILED[0m app/tests/unit/infrastructure/ml/symptom_forecasting/test_xgboost_model.py::[1mTestXGBoostSymptomModel::test_get_feature_importance[0m - TypeError: 'types.SimpleNamespace' object is not subscriptable
[31mFAILED[0m app/tests/unit/infrastructure/ml/symptom_forecasting/test_xgboost_model.py::[1mTestXGBoostSymptomModel::test_train[0m - AttributeError: 'types.SimpleNamespace' object has no attribute 'get_score'
[31mFAILED[0m app/tests/unit/infrastructure/ml/test_digital_twin_integration_service.py::[1mTestDigitalTwinIntegrationService::test_generate_comprehensive_insights_all_services[0m - AssertionError: assert 'medication_predictions' in {'biometric_correlations...
[31mFAILED[0m app/tests/unit/infrastructure/ml/test_digital_twin_integration_service.py::[1mTestDigitalTwinIntegrationService::test_generate_comprehensive_insights_partial_services[0m - assert 'medication_predictions' in {'errors': {'medication_predictions': "'...
[31mFAILED[0m app/tests/unit/infrastructure/ml/test_digital_twin_integration_service.py::[1mTestDigitalTwinIntegrationService::test_generate_comprehensive_insights_handles_service_errors[0m - AssertionError: assert 'medication_predictions' in {'biometric_correlations...
[31mFAILED[0m app/tests/unit/infrastructure/ml/test_digital_twin_integration_service.py::[1mTestDigitalTwinIntegrationService::test_get_patient_data[0m - AttributeError: 'DigitalTwinIntegrationService' object has no attribute 'pa...
[31mFAILED[0m app/tests/unit/infrastructure/ml/test_digital_twin_integration_service.py::[1mTestDigitalTwinIntegrationService::test_get_patient_data_handles_missing_patient[0m - AttributeError: 'DigitalTwinIntegrationService' object has no attribute 'pa...
[31mFAILED[0m app/tests/unit/infrastructure/persistence/sqlalchemy/models/test_model_validation.py::[1mTestUserModelValidation::test_domain_to_persistence_mapping[0m - AttributeError: 'User' object has no attribute 'hashed_password'
[31mFAILED[0m app/tests/unit/infrastructure/persistence/sqlalchemy/models/test_model_validation.py::[1mTestUserModelValidation::test_persistence_to_domain_mapping[0m - TypeError: 'hashed_password' is an invalid keyword argument for User
[31mFAILED[0m app/tests/unit/infrastructure/persistence/sqlalchemy/repositories/test_biometric_alert_repository_infra.py::[1mTestSQLAlchemyBiometricAlertRepository::test_save_new_alert[0m - AttributeError: <class 'app.tests.unit.infrastructure.persistence.sqlalchem...
[31mFAILED[0m app/tests/unit/infrastructure/persistence/sqlalchemy/repositories/test_biometric_alert_repository_infra.py::[1mTestSQLAlchemyBiometricAlertRepository::test_get_alert_by_id[0m - AttributeError: <class 'app.tests.unit.infrastructure.persistence.sqlalchem...
[31mFAILED[0m app/tests/unit/infrastructure/persistence/sqlalchemy/repositories/test_biometric_alert_repository_infra.py::[1mTestSQLAlchemyBiometricAlertRepository::test_get_alert_by_id_not_found[0m - Failed: DID NOT RAISE <class 'app.tests.unit.infrastructure.persistence.sql...
[31mFAILED[0m app/tests/unit/infrastructure/persistence/sqlalchemy/repositories/test_biometric_alert_repository_infra.py::[1mTestSQLAlchemyBiometricAlertRepository::test_get_alerts_for_patient[0m - AttributeError: <class 'app.tests.unit.infrastructure.persistence.sqlalchem...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_auth_middleware_unit.py::[1mTestAuthMiddleware::test_valid_authentication[0m - assert 500 == 200
[31mFAILED[0m app/tests/unit/infrastructure/security/test_auth_middleware_unit.py::[1mTestAuthMiddleware::test_invalid_token[0m - assert 500 == 401
[31mFAILED[0m app/tests/unit/infrastructure/security/test_auth_middleware_unit.py::[1mTestAuthMiddleware::test_expired_token[0m - assert 500 == 401
[31mFAILED[0m app/tests/unit/infrastructure/security/test_auth_middleware_unit.py::[1mTestAuthMiddleware::test_authentication_with_roles_success[0m - assert 500 == 200
[31mFAILED[0m app/tests/unit/infrastructure/security/test_auth_middleware_unit.py::[1mTestAuthMiddleware::test_inactive_user_authentication_failure[0m - assert 500 == 403
[31mFAILED[0m app/tests/unit/infrastructure/security/test_auth_middleware_unit.py::[1mTestAuthMiddleware::test_user_not_found_authentication_failure[0m - assert 500 == 401
[31mFAILED[0m app/tests/unit/infrastructure/security/test_auth_middleware_unit.py::[1mTestAuthMiddleware::test_token_parsing_failure[0m - assert 500 == 401
[31mFAILED[0m app/tests/unit/infrastructure/security/test_auth_middleware_unit.py::[1mTestAuthMiddleware::test_unexpected_error_handling[0m - AssertionError: Expected verify_token to have been awaited once. Awaited 0 ...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_encryption_enhanced.py::[1mTestEncryptionUtils::test_decrypt_invalid_token[0m - ValueError: Invalid Token: Decryption failed with all available keys.
[31mFAILED[0m app/tests/unit/infrastructure/security/test_encryption_enhanced.py::[1mTestEnhancedEncryptionService::test_encrypt_decrypt_dict[0m - AssertionError: assert (True and False)
[31mFAILED[0m app/tests/unit/infrastructure/security/test_encryption_enhanced.py::[1mTestEnhancedEncryptionService::test_key_rotation[0m - AttributeError: <module 'app.infrastructure.security.encryption' from '/Use...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_encryption_enhanced.py::[1mTestEnhancedEncryptionService::test_file_encryption[0m - AttributeError: 'BaseEncryptionService' object has no attribute 'encrypt_fi...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_encryption_enhanced.py::[1mTestEnhancedEncryptionService::test_encrypt_file_nonexistent[0m - AttributeError: 'BaseEncryptionService' object has no attribute 'encrypt_fi...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_encryption_enhanced.py::[1mTestEnhancedEncryptionService::test_decrypt_file_nonexistent[0m - AttributeError: 'BaseEncryptionService' object has no attribute 'decrypt_fi...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_encryption_enhanced.py::[1mTestEnhancedEncryptionService::test_decrypt_invalid_file_content[0m - AttributeError: 'BaseEncryptionService' object has no attribute 'decrypt_fi...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_jwt_handler.py::[1mTestJWTService::test_decode_malformed_token[0m - assert 'Not enough segments' in "Invalid token: Invalid header string: 'utf...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_jwt_handler.py::[1mTestJWTService::test_decode_token_missing_required_claims[0m - AssertionError: assert ('validation error' in 'invalid token: invalid issue...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_jwt_service_enhanced.py::[1mTestJWTService::test_create_access_token[0m - assert (29 * 60) <= 899.8313059806824
[31mFAILED[0m app/tests/unit/infrastructure/security/test_jwt_service_enhanced.py::[1mTestJWTService::test_verify_token_valid[0m - AttributeError: 'JWTService' object has no attribute 'verify_token'
[31mFAILED[0m app/tests/unit/infrastructure/security/test_jwt_service_enhanced.py::[1mTestJWTService::test_verify_token_expired[0m - AttributeError: 'JWTService' object has no attribute 'verify_token'
[31mFAILED[0m app/tests/unit/infrastructure/security/test_jwt_service_enhanced.py::[1mTestJWTService::test_verify_token_invalid_signature[0m - AttributeError: 'JWTService' object has no attribute 'verify_token'
[31mFAILED[0m app/tests/unit/infrastructure/security/test_jwt_service_enhanced.py::[1mTestJWTService::test_verify_token_malformed[0m - AttributeError: 'JWTService' object has no attribute 'verify_token'
[31mFAILED[0m app/tests/unit/infrastructure/security/test_jwt_service_enhanced.py::[1mTestJWTService::test_refresh_access_token[0m - AttributeError: 'JWTService' object has no attribute 'refresh_access_token'...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_jwt_service_enhanced.py::[1mTestJWTService::test_refresh_access_token_with_non_refresh_token[0m - AttributeError: 'JWTService' object has no attribute 'refresh_access_token'...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_jwt_service_enhanced.py::[1mTestJWTService::test_get_token_identity[0m - AttributeError: 'JWTService' object has no attribute 'get_token_identity'
[31mFAILED[0m app/tests/unit/infrastructure/security/test_jwt_service_enhanced.py::[1mTestJWTService::test_get_token_identity_missing_sub[0m - AttributeError: 'JWTService' object has no attribute 'get_token_identity'
[31mFAILED[0m app/tests/unit/infrastructure/security/test_mfa_service.py::[1mTestMFAService::test_setup_totp[0m - app.infrastructure.security.auth.mfa_service.MFASetupException: Failed to s...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_mfa_service.py::[1mTestMFAService::test_verify_totp_valid[0m - AssertionError: Expected 'TOTP' to be called once. Called 0 times.
[31mFAILED[0m app/tests/unit/infrastructure/security/test_mfa_service.py::[1mTestMFAService::test_verify_totp_invalid[0m - AssertionError: Expected 'TOTP' to be called once. Called 0 times.
[31mFAILED[0m app/tests/unit/infrastructure/security/test_mfa_service.py::[1mTestMFAService::test_get_backup_codes[0m - AssertionError: assert ['<MAGICMOCK'... '<MAGICMOCK'] == ['ABCDEF1234'... '...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_password_handler.py::[1mTestPasswordHashing::test_verify_handles_none_values[0m - passlib.exc.UnknownHashError: hash could not be identified
[31mFAILED[0m app/tests/unit/infrastructure/security/test_password_handler.py::[1mTestPasswordStrengthValidation::test_short_password[0m - AssertionError: assert 'length' in 'password must be at least 12 characters...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_password_handler.py::[1mTestPasswordStrengthValidation::test_password_without_complexity[0m - AssertionError: Feedback for 'NoUpper123!' should mention uppercase
[31mFAILED[0m app/tests/unit/infrastructure/security/test_password_handler.py::[1mTestPasswordStrengthValidation::test_common_password[0m - AssertionError: assert 'common' in 'password must be at least 12 characters...
[31mFAILED[0m app/tests/unit/infrastructure/security/test_password_handler.py::[1mTestPasswordStrengthValidation::test_repeated_characters[0m - AssertionError: assert 'repeat' in 'password must be at least 12 characters...
[31mFAILED[0m app/tests/unit/presentation/api/dependencies/test_rate_limiter_deps.py::[1mTestRateLimitFactoryFunctions::test_rate_limit[0m - AssertionError: Expected 'RateLimitDependency' to be called once. Called 0 ...
[31mFAILED[0m app/tests/unit/presentation/api/dependencies/test_rate_limiter_deps.py::[1mTestRateLimitFactoryFunctions::test_sensitive_rate_limit[0m - AssertionError: Expected 'RateLimitDependency' to be called once. Called 0 ...
[31mFAILED[0m app/tests/unit/presentation/api/dependencies/test_rate_limiter_deps.py::[1mTestRateLimitFactoryFunctions::test_admin_rate_limit[0m - AssertionError: Expected 'RateLimitDependency' to be called once. Called 0 ...
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_analytics_endpoints.py::[1mTestAnalyticsEndpoints::test_record_analytics_event[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_analytics_endpoints.py::[1mTestAnalyticsEndpoints::test_record_analytics_batch[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_analytics_endpoints.py::[1mTestAnalyticsEndpoints::test_phi_detection_in_analytics_event[0m - RuntimeError: cannot reuse already awaited coroutine
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_get_alert_rules[0m - TypeError: Can't instantiate abstract class SQLAlchemyUserRepository withou...
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_create_alert_rule_from_template[0m - TypeError: Type <class 'app.domain.services.clinical_rule_engine.ClinicalRu...
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_create_alert_rule_from_condition[0m - TypeError: Type <class 'app.domain.services.clinical_rule_engine.ClinicalRu...
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_get_alert_rule[0m - TypeError: Can't instantiate abstract class SQLAlchemyUserRepository withou...
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_get_alert_rule_not_found[0m - TypeError: Can't instantiate abstract class SQLAlchemyUserRepository withou...
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_update_alert_rule[0m - TypeError: Type <class 'app.domain.services.clinical_rule_engine.ClinicalRu...
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_delete_alert_rule[0m - TypeError: Can't instantiate abstract class SQLAlchemyUserRepository withou...
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_get_rule_templates[0m - TypeError: Can't instantiate abstract class SQLAlchemyUserRepository withou...
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_get_alerts[0m - assert 404 == 200
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_get_alerts_with_filters[0m - assert 404 == 200
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_update_alert_status_acknowledge[0m - assert 404 == 200
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_update_alert_status_resolve[0m - assert 404 == 200
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_get_patient_alert_summary[0m - assert 404 == 200
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_create_alert_rule_template[0m - assert 405 == 201
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_update_alert_status_unauthorized[0m - assert 404 == 401
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_update_alert_status_invalid_payload[0m - assert 404 == 422
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_alerts_endpoint.py::[1mTestBiometricAlertsEndpoints::test_trigger_alert_manually_success[0m - assert 404 == 201
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_endpoints.py::[1mTestBiometricEndpointsDependencies::test_require_clinician_role_success[0m - assert 403 == 200
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_endpoints.py::[1mTestBiometricEndpointsDependencies::test_require_clinician_role_admin[0m - assert 403 == 200
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_endpoints.py::[1mTestBiometricEndpointsDependencies::test_require_clinician_role_patient[0m - AssertionError: assert 'CLINICIAN' in 'This operation requires one of the f...
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_endpoints.py::[1mTestBiometricEndpointsDependencies::test_require_admin_role_success[0m - assert 403 == 200
[31mFAILED[0m app/tests/unit/presentation/api/v1/endpoints/test_biometric_endpoints.py::[1mTestBiometricEndpointsDependencies::test_require_admin_role_clinician[0m - AssertionError: assert 'ADMIN' in 'This operation requires admin privileges'
[31mFAILED[0m app/tests/unit/services/ml/pat/test_pat_service.py::[1mTestBedrockPAT::test_get_patient_analyses[0m - AssertionError
[31m========= [31m[1m389 failed[0m, [32m1128 passed[0m, [33m62 skipped[0m, [33m117 warnings[0m[31m in 34.03s[0m[31m ==========[0m
